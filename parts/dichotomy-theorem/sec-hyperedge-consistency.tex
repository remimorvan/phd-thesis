\section{\AP\label{sec:hyperedge-consistency}%
	Hyperedge Consistency}

In this section, we introduce the "hyperedge consistency algorithm for automatic structures",
which is a variation of the classical "hyperedge consistency algorithm" for "finite structures".
We start by explaining the later algorithm,
which solves $\HomFin{\?B}$ for some $\?B$'s.\footnote{We will
see later that the algorithm is correct for "$\sigma$-structures" with so-called "tree duality",
which is a superclass of the "structures" with "finite duality".}
Then, we will use the former algorithm to prove that assuming that $\?B$ has "finite duality",
then $\HomRegAut{\?B}$ is decidable.\footnote{Interestingly, this algorithm cannot solve
$\HomRegAut{\?B}$ when $\?B$ has only "tree duality" but not "finite duality". 
We discuss this in more details in TODO.}

\subsection{Hyperedge Consistency for Finite Structures}

Given a "homomorphism" $f\colon \?G \to \?H$ between "graphs",
note that if $g\in G$ has at least one successor in $\?G$, then must have $f(g)$ in $\?H$.
As a consequence, such an $g$ cannot be mapped by any "homomorphism" to a vertex of $\?H$ with no
successor. The idea behind "hyperedge consistency@@finite" is precisely to identify for each
$g\in G$ the set $\textrm{Im}_g$ of all elements of $\?H$ to which it can be mapped: initially this set is $H$,
and we try to find some ``obstructions''. These obstructions take the following form:
if $g \in G$ has a successor $g' \in G$, then any vertex of $\textrm{Im}_g$
must have a successor in $\?H$ that lives in $\textrm{Im}_{g'}$.

TODO:example $T_2$.

We formalize this algorithm as the greatest fixpoint of some operator.
Given a finite "$\sigma$-structure" $\?B$, and an arbitrary\sidenote{Note that in this part, while some results---mostly complexity/decidability ones---require the assumption that the "left structure" is finite, some results do not,
and are stated for arbitrary "structures".}%
"$\sigma$-structure" $\?A$, we say that a function $F\colon A \to \pset{B}$ is "subsumed"
by $G\colon A \to \pset{B}$, denoted by \AP\(F \intro*\subsumed G\),
if $F(a) \subseteq G(a)$ for each $a \in A$. We denote by
\AP\(\intro*\LatticeGuessFunctions{A}{B}\) the set of functions $A \to \pset{B}$ under this order.%
\footnote{Equivalently, $\LatticeGuessFunctions{A}{B}$ is the
set of binary relations between $A$ and $B$, ordered by inclusion.}

We then define an operator on this space, which corresponds to one step of the "hyperedge consistency algorithm@@finite":
\begin{center}
	\begin{tabular}{rccc}
		$\HCOperator_{\!\?A,\?B}\colon$ & $\LatticeGuessFunctions{A}{B}$ & $\to$ & $\LatticeGuessFunctions{A}{B}$ \\
		& $F$ & $\mapsto$ & $\HCOperator(F)$,
	\end{tabular}
\end{center}
where for each $a \in A$, \AP$\intro*\HCOperator_{\!\?A,\?B}(F)(a)$ is the set of $b \in F(a)$ "st"
for every $\+R_{(k)} \in \sigma$, for every $i \in \lBrack 1,k\rBrack$,
if $\langle a_1,\, \hdots,\, a_{k-1} \rangle \in \neighbourhood{a}{\?A}{\+R}{i}$,
then there exists $b_1 \in F(a_1)$, $\hdots$, $b_{k-1} \in F(a_{k-1})$ "st" 
$\langle b_1,\, \hdots,\, b_{k-1} \rangle \in \neighbourhood{b}{\?B}{\+R}{i}$.\footnote{%
We write $\HCOperator$ for $\HCOperator_{\!\?A,\?B}$ when there is no ambiguity on
the "structures" involved.}

\begin{fact}
	The ordered set $\LatticeGuessFunctions{A}{B}$ is a "complete lattice",
	and moreover $\HCOperator$ is monotonic.
\end{fact}

As a consequence of the "Knaster-Tarski theorem", $\HCOperator$ admits a greatest fixpoint, that
we denote by \AP$\intro*\HCFixpoint{\?A}{\?B} \in \LatticeGuessFunctions{A}{B}$.\footnote{Recall 
that this greatest fixpoint can be obtained by ordinal induction by starting from
the greatest element of $\LatticeGuessFunctions{A}{B}$, namely the map $a \mapsto B$,
and iterating $\HCOperator$.}

\begin{proposition}
	If $f\colon \?A \to \?B$ is a "homomorphism" then $f(a) \in \HCFixpoint{\?A}{\?B}(a)$
	for each $a \in A$.
\end{proposition}

\begin{proof}
	The property ``$f(a) \in F(a)$ for each $a\in A$'' holds for the greatest element
	of $\LatticeGuessFunctions{A}{B}$, is stable under application of $\HCOperator$ and
	under arbitrary meets.\footnote{Meaning that if all $F_i$ ($i \in I$ for some arbitrary set $I$)
	satisfy the property, then so does $a \mapsto \bigcap_{i \in I} F(a)$}
	Hence, by ordinal induction, it holds for $\HCFixpoint{\?A}{\?B}$.
\end{proof}

\begin{corollary}
	If $\HCFixpoint{\?A}{\?B}(a) = \emptyset$ for some $a\in A$, then
	$\?A \nothomto \?B$.
\end{corollary}

In general, the converse property does not hold. For instance, if $\sigma$ is the
"signature of graphs" and $\?B$ is the "$2$-clique", then $\HCFixpoint{\?A}{\?B}$
is always the map $a \mapsto B$, no matter whether there is a "homomorphism" from
$\?A$ to $\?B$.

Yet, TODO managed to identify a necessary and sufficient condition on $\?B$ for
the "hyperedge consistency algorithm@@finute" to decide whether $\?A \in \HomFin{\?B}$.
\begin{definition}
	A finite "$\sigma$-structure" $\?B$ has ""tree duality"" when TODO.
\end{definition}

\begin{proposition}[TODO:addref]
	\AP\label{prop:hyperedge-consistency-tree-duality}
	If $\?B$ has "tree duality" then $\?A \homto \?B$ "iff"
	$\HCFixpoint{\?A}{\?B}(a) \neq \emptyset$ for all $a\in A$.
\end{proposition}

When $\?A$ is moreover finite, this immediately gives an algorithm to decide
$\?A \homto \?B$ since $\HCFixpoint{\?A}{\?B}$ can be computed not only
by an ordinal induction but with a finite induction.

\begin{corollary}
	If $\?B$ has "tree duality", then $\HomFin{\?B}$ can be solved in
	polynomial time.\sidenote{TODO: Precise complexity.}
\end{corollary}


\subsection{Hyperedge Consistency for Automatic Structures}

When $\?A$ is "automatic", \Cref{prop:hyperedge-consistency-tree-duality} still applies,
however it is not clear how to compute $\HCFixpoint{\?A}{\?B}$ since this element cannot
necessarily be obtained by finite induction, namely as
$\HCOperator^{\,n}(\topLatticeGuessFunctions{B})$ for some $n\in\N$, where
\AP$\intro*\topLatticeGuessFunctions{B}$ is the maximum element
of $\LatticeGuessFunctions{A}{B}$, namely the constant map $a \mapsto B$.
Another issue is to have a finite representation of the functions of
$\LatticeGuessFunctions{A}{B}$ since $A$ can be infinite. This last point is easy to address.

Given an "automatic presentation" $\•A$ of $\?A$, we extend
$\HCOperator_{\!\•A,\?B}$ and $\HCFixpoint{\•A}{\?B}$ to be defined on $\domainPres{\•A}$
instead of $\?A$.

\begin{lemma}[$\HCOperator$ preserves "regularity@@fun"]
	\AP\label{lem:hyperedge-consistency-preserves-regularity}
	Let $\?A$ be an arbitrary "$\sigma$-structure" and $\?B$ a finite "$\sigma$-structure".
	For any $F\in \LatticeGuessFunctions{\•A}{B}$, if $F$ is "regular@@hom",
	then $\HCOperator(F)$ is "regular@@hom".
\end{lemma}

\begin{proof}
	Let $F\in \LatticeGuessFunctions{\•A}{B}$ be "regular@@hom",
	so for each $Y \in \pset{B}$, $F^{-1}[Y]$ is "regular@@lang", and so by \Cref{prop:synchronous-first-order}, there exists a "first-order formula" $\phi_Y(x)$ over
	\(\signatureSynchronous{\Sigma}\)
	"st" $F^{-1}[Y] = \semFO{\phi_Y(x)}{\univStructSynchronous{\Sigma}}$.
	Also, since $\•A$ is an "automatic presentation", for any $\+R \in \sigma$ of arity $k$,
	there exists by \Cref{prop:synchronous-first-order} a "first-order formula" $\psi_{\+R}(x_1,\ldots,x_k)$ over \(\signatureSynchronous{\Sigma}\) "st"
	$\relPres{\•A}{\•R} = \semFO{\psi_{\+R}(x_1,\hdots,x_k)}{\univStructSynchronous{\Sigma}}$.
	Similarly, $\domainPres{\•A} = \semFO{\psi_{\textrm{dom}}(x)}{\univStructSynchronous{\Sigma}}$
	for some "formula@@FO" $\psi_{\textrm{dom}}(x)$.

	It is then easy to prove that $\HCOperator(F)$ is "regular@@hom" by providing a "first-order 
	formula" $\widehat \phi_Y(x)$ for each $Y \in \pset{B}$, describing $\HCOperator(F)^{-1}[Y]$,
	using both the formulas above, and the definition of $\HCOperator$.
	Indeed, recall that an element $u \in \domainPres{\•A}$ should be sent via $\HCOperator(F)$ 
	onto $Y\in \pset{B}$ if $Y$ is exactly the set of elements $b \in B$ "st" for every $\+R_{(k)} \in \sigma$, for every $i \in \lBrack 1,k\rBrack$, if
	$\langle a_1,\, \hdots,\, a_{k-1} \rangle \in \neighbourhood{a}{\?A}{\+R}{i}$,
	then there exists $b_1 \in F(a_1)$, $\hdots$, $b_{k-1} \in F(a_{k-1})$ "st" 
	$\langle b_1,\, \hdots,\, b_{k-1} \rangle \in \neighbourhood{b}{\?B}{\+R}{i}$.
	Symbolically the set of such $u$'s can be written as
	$\semFO{\widehat \phi_Y(x)}{\univStructSynchronous{\Sigma}}$, where
	\[
		\widehat \phi_Y(x) \defeq 
			\psi_{\textrm{dom}}(x) \land \big(\bigwedge_{b\in Y} \chi_b(x) \land \bigwedge_{b\not\in Y} \neg\chi_b(x)\big)
	\]
	where $\chi_b(x)$ is the formula\footnote{Notice that since
	$\chi_b$ appear both positively and negatively in $\widehat \phi_Y$, going from
	the $\phi$'s to the $\widehat \phi's$ increases the "quantifier alternation" of the
	"formulas@@FO" by one. And so the "formulas@@FO" we build to describe $\HCOperator^{\,n}(\topLatticeGuessFunctions{B})$ are of "quantifier alternation" $n$.
	TODO:CONCLUDE SOMEWHERE THAT CONSTRUCTION IS NOT ELEMENTARY.}
	\begin{align*}
		\chi_b(x) \defeq\; &
			\bigwedge_{\+R_{(k)} \in \sigma} \bigwedge_{i\in \lBrack 1,k\rBrack}\;
			\forall x_1.\, \hdots\, \forall x_{i-1}.\, \forall x_{i+1}.\, \hdots \, \forall x_{k}.\,\\
			& \hspace{2em}\psi_{\+R}(x_1,\hdots, x_{i-1}, x, x_{i+1}, \hdots, x_k)
			\\ 
			& \hspace{2em} \Rightarrow \Big(\bigvee_{\substack{\langle b_1,\hdots,b_{i-1},b_{i+1},\hdots b_k\rangle \in \neighbourhood{b}{\?B}{\+R}{i}}}\;
			\bigwedge_{i \in \lBrack 1,k\rBrack \smallsetminus \{i\}}
			\underbrace{%
				\bigvee_{\substack{Y' \in \pset{B}\\ b_i\in Y'}} \phi_{Y'}(x_i)
			}_{%
				b_i \in F(x_i)
			}%
			\Big).\qedhere
	\end{align*}
\end{proof}

Notice that $\topLatticeGuessFunctions{B}$ is trivially "regular@@fun", and so
by immediate induction, each $\HCOperator^{\,n}(\topLatticeGuessFunctions{B})$ with $n\in \N$ is
also "regular@@fun". While this opens the door to solving $\HomRegAut{\?B}$ when $\?B$ has
"tree duality" using the "hyperedge consistency algorithm@@finite", the problem
of finite convergence remains.

First, we show that finite iterations are enough to detect the absence of "homomorphism".
\begin{proposition}
	\AP\label{prop:hyperedge-consistency-no-hom}
	Let $\?A$ be an arbitrary "$\sigma$-structure" and $\?B$ a "finite $\sigma$-structure"
	with "tree duality". If $\?A \nothomto \?B$, then there exists $n\in\N$ and $a\in A$ "st"
	$\HCOperator^{\,n}(\topLatticeGuessFunctions{B})(a) = \emptyset$. 
\end{proposition}

In order to prove this proposition, we rely on the following property.
\begin{property}[Monotonicity of $\HCOperator$]
	\!\footnote{Observe in particular that this property can be applied if $\?A'$ is a
	substructure of $\?A$.}%
	\AP\label{prop:hyperedge-consistency-antimonotonicity}
	Let $\?A$, $\?A'$ be arbitrary "$\sigma$-structures" "st"
	there is a "homomorphism" $h\colon \?A' \to \?A$. Let $\?B$ a "finite $\sigma$-structure".
	For any $F\in \LatticeGuessFunctions{A}{B}$ and $F' \in \LatticeGuessFunctions{\?A'}{\?B}$,
	if $F(h(a)) \subseteq F'(a)$ for all $a\in A'$, then $\HCOperator(F)(h(a)) \subseteq \HCOperator(F')(a)$ for all $a\in A'$.\footnote{In other words, if $F \circ h \subsumed F'$, then
	$\HCOperator(F) \circ h \subsumed \HCOperator(F')$.}
\end{property}

\begin{proof}
	Assume that $\restr{F}{A'} \subsumed F'$, and let us show that 
	$\restr{\HCOperator(F)}{A'} \subsumed \HCOperator(F')$.
	Let $a \in A'$, and let $b \in \HCOperator(F)(h(a))$.
	Then for every $\+R_{(k)} \in \sigma$,
	for every $i \in \lBrack 1,k\rBrack$,
	if $\langle a_1,\, \hdots,\, a_{k-1} \rangle \in \neighbourhood{h(a)}{\?A}{\+R}{i}$,
	then there exists $b_1 \in F(a_1)$, $\hdots$, $b_{k-1} \in F(a_{k-1})$ "st" 
	$\langle b_1,\, \hdots,\, b_{k-1} \rangle \in \neighbourhood{b}{\?B}{\+R}{i}$.
	Then let $\+R_{(k)} \in \sigma$ and $i \in \lBrack 1,k\rBrack$.
	Let $\langle a_1,\, \hdots,\, a_{k-1} \rangle \in \neighbourhood{a}{\?A'}{\+R}{i}$.
	Then $\langle h(a_1),\, \hdots,\, h(a_{k-1}) \rangle \in \neighbourhood{h(a)}{\?A}{\+R}{i}$
	since $h$ is a "homomorphism". And so there exists
	$b_1 \in F(h(a_1))$, $\hdots$, $b_{k-1} \in F(h(a_{k-1}))$ "st" 
	$\langle b_1,\, \hdots,\, b_{k-1} \rangle \in \neighbourhood{b}{\?B}{\+R}{i}$.
	Using the inclusions $F(h(a_i)) \subseteq F'(a_i)$ (for $a_i \in A'$), it follows that
	for every $\+R_{(k)} \in \sigma$, for every $i \in \lBrack 1,k\rBrack$,
	if $\langle a_1,\, \hdots,\, a_{k-1} \rangle \in \neighbourhood{a}{\?A'}{\+R}{i}$, then
	there exists $b_1 \in F'(a_1)$, $\hdots$, $b_{k-1} \in F'(a_{k-1})$
	"st" $\langle b_1,\, \hdots,\, b_{k-1} \rangle \in \neighbourhood{b}{\?B}{\+R}{i}$.
	And hence $b \in \HCOperator(F')(a)$, which concludes the proof.
\end{proof}

\begin{proof}[Proof of \Cref{prop:hyperedge-consistency-no-hom}]
	Let $\?A$ be an arbitrary "$\sigma$-structure" and $\?B$ a "finite $\sigma$-structure"
	with "tree duality". Assume that $\?A \nothomto \?B$.
	Then by \Cref{prop:de-bruijn-erdos} there exists a finite "substructure" $\?A'$
	of $\?A$ "st" $\?A' \nothomto \?B$,
	and so by \Cref{prop:hyperedge-consistency-tree-duality},
	there exists some $a\in A$ "st" $\HCFixpoint{\?A'}{\?B}(a) = \emptyset$.
	But since $\?A'$ is finite, $\HCFixpoint{\?A'}{\?B} = \HCOperator^{\,n}(\topLatticeGuessFunctions{B})$ for some $n\in\N$. Then using \Cref{prop:hyperedge-consistency-antimonotonicity},
	\[
		\HCOperator_{\!\?A,\?B}^{\,n}(\topLatticeGuessFunctions{B})(a)
		\subseteq \HCOperator_{\!\?A',\?B}^{\,n}(\topLatticeGuessFunctions{B})(a)
		= \HCFixpoint{\?A'}{\?B}(a)
		= \emptyset.\qedhere
	\]
\end{proof}

So, if $\?A \nothomto \?B$, then "hyperedge consistency" will detect it in finite time assuming 
that $\?B$ has "tree duality".
We will then show the dual implication, under the stronger assumption that $\?B$ has "finite 
duality": the reason we need this stronger assumption is that while the "hyperedge consistency algorithm@@finite" converges for finite "$\sigma$-structures" when $\?B$ has "tree duality",
the number of iterations needed to reach the fixpoint depends on $\?A$. For "structures"
with "finite duality", we show that this is not the case---and hence, converge generalizes to 
infinite "$\sigma$-structures".

\begin{lemma}[Uniform Convergence of Hyperedge Consistency for Structures with Finite Duality]
	\AP\label{lem:hyperedge-consistency-uniform-convergence}
	Let $\?B$ be a finite "$\sigma$-structure" with "tree duality".
	The following are equivalent:
	\begin{enumerate}
		\itemAP\label{item:hc-uniform-finite-duality}%
			$\?B$ has finite duality;
		\itemAP\label{item:hc-uniform-finite-structures}%
			there exists $n\in\N$ "st" for every \emph{finite} "$\sigma$-structure" $\?A$, $\HCOperator^{\,n}_{\!\?A,\?B}(\topLatticeGuessFunctions{B}) = \HCFixpoint{\?A}{\?B}$;
		\itemAP\label{item:hc-uniform-arbitrary-structures}%
			there exists $n\in\N$ "st" for every \emph{arbitrary} "$\sigma$-structure" $\?A$, $\HCOperator^{\,n}_{\!\?A,\?B}(\topLatticeGuessFunctions{B}) = \HCFixpoint{\?A}{\?B}$;
		\itemAP\label{item:hc-uniform-first-order}%
			for each $Y \subseteq B$, the class of "pointed $\sigma$-structures"
			$\{\langle \?A, a \rangle \mid \HCFixpoint_{\?A,\?B}(\topLatticeGuessFunctions{B})(a) = Y\}$ is "first-order definable".
	\end{enumerate}
\end{lemma}

\begin{proof}
	\proofcase{\eqref{item:hc-uniform-finite-structures} $\Rightarrow$
		\eqref{item:hc-uniform-arbitrary-structures}.}
	Let $n\in \N$ "st" $\HCOperator^{\,n}_{\!\?A',\?B}(\topLatticeGuessFunctions{B}) = \HCFixpoint{\?A'}{\?B}$ for every finite "$\sigma$-structure" $\?A'$. Let $\?A$ be an arbitrary
	"$\sigma$-structure". Note that for any $F\in \LatticeGuessFunctions{A}{B}$, for any 
	"substructure" $\?A'$ of $\?A$ containing $a$, then by \Cref{prop:hyperedge-consistency-antimonotonicity}
	$\HCOperator_{\?A,\?B}(F)(a) \subseteq \HCOperator_{\?A',\?B}(F)(a)$.
	We show that equality is reached by a particular finite "substructure".
	\begin{claim}
		\label{claim:hyperedge-consistency-ball}
		For any $F\in \LatticeGuessFunctions{A}{B}$ and $m\in \N$,
		there exists a finite "substructure"\footnote{Of course, if $\?A$ is "locally finite",
		we can always take $\?A_{a,m} = \ball{\?A}{a}{m}$.}
		$\?A_{a,m}$ of $\ball{\?A}{a}{m}$ "st"
		\[\HCOperator^{\,m}_{\?A,\?B}(F)(a) = \HCOperator^{\,m}_{\?A_{a,m},\?B}(F)(a).\]
	\end{claim}
	We give a proof sketch of this claim. Note that by definition,
	$\HCOperator_{\?A,\?B}(F)(a)$ only depends on the values of $F(a')$ where $a'$ is at distance 1.
	More precisely, it only depends on whether for any "relation symbol" $\+R$ of arity $k$,
	for any $i\in\lBrack 1,k\rBrack$, for any $Y_1,\hdots,Y_{k-1} \subseteq B$, whether there
	are elements $\langle a_1,\,\hdots,\,a_{k-1}\rangle \in \neighbourhood{a}{\?A}{\+R}{i}$
	"st"  
	$\langle F(a_1),\,\hdots,\,F(a_{k-1}) \rangle = \langle Y_1,\,\hdots,\,Y_{k-1} \rangle$.
	Since $B$ is finite, there are finitely many such tuples, and for each of them it suffices
	to keep (for distance $m=1$) only one tuple $\langle a_1,\,\hdots,\,a_{k-1}\rangle \in \neighbourhood{a}{\?A}{\+R}{i}$. By induction on $m$, we
	obtain a finite "substructure" $\?A_{a,m}$ of $\ball{\?A}{a}{m}$ as in
	\Cref{claim:hyperedge-consistency-ball}.

	We now show that $\HCOperator^{\,n}_{\!\?A,\?B}(\topLatticeGuessFunctions{B}) =
	\HCFixpoint{\?A}{\?B}$. By \Cref{claim:hyperedge-consistency-ball,prop:hyperedge-consistency-antimonotonicity}
	\[\HCOperator^{\,n}_{\!\?A,\?B}(\topLatticeGuessFunctions{B})(a) =
	\HCOperator^{\,n}_{\?A_{a,n+1},\?B}(\topLatticeGuessFunctions{B})(a).\]
	Since $\?A_{a,n+1}$ is finite, by \eqref{item:hc-uniform-finite-structures}, the right-hand side
	of the equality above equals $\HCFixpoint{\?A_{a,m}}{\?B}(a)$.
	But then again by \Cref{claim:hyperedge-consistency-ball} and \eqref{item:hc-uniform-finite-structures}, 
	\[\HCOperator^{n+1}_{\!\?A,\?B}(\topLatticeGuessFunctions{B})(a) = \HCFixpoint{\?A_{a,n+1}}{\?B}(a).\]
	And hence $\HCOperator^{\,n}_{\!\?A,\?B}(\topLatticeGuessFunctions{B})(a) = \HCOperator^{n+1}_{\!\?A,\?B}(\topLatticeGuessFunctions{B})(a)$. Since this property holds
	for arbitrary values of $a\in A$, it follows that $\HCOperator^{\,n}_{\!\?A,\?B}(\topLatticeGuessFunctions{B}) = \HCFixpoint{\?A}{\?B}$. 

	\proofcase{\eqref{item:hc-uniform-arbitrary-structures} $\Rightarrow$
		\eqref{item:hc-uniform-first-order}.}
	Observe that if $F\colon \in \LatticeGuessFunctions{A}{B}$ is first-order
	definable---in the sense that for each $X \subseteq B$, the class of "pointed structures"
	$\langle \?A, a\rangle$ "st" $F(a) = X$ is "first-order definable"---, then so is
	$\HCOperator(F)$. By immediate induction and \eqref{item:hc-uniform-arbitrary-structures},
	it follows that $\HCFixpoint{\?A}{\?B}$ is first-order definable in this sense.\footnote{Note 
	that this proof crucially uses the fact that $n$ does not depend on $\?A$.}

	\proofcase{\eqref{item:hc-uniform-first-order} $\Rightarrow$
	\eqref{item:hc-uniform-finite-duality}.}
	For $Y = \emptyset$, we get that $\{\langle \?A, a \rangle \mid \HCFixpoint_{\?A,\?B}(\topLatticeGuessFunctions{B})(a) = \emptyset\}$ is "first-order definable", say by a formula
	$\phi(x)$. Then $\forall x.\, \neg \phi(x)$ is a "first-order formula" describing the class of
	$\{\?A \mid \?A \homto \?B\}$ by \Cref{prop:hyperedge-consistency-tree-duality}, since
	$\?B$ has "tree duality".\footnote{Note that this implication requires the assumption that
	$\?B$ has "tree duality": indeed, if $\?B$ is the "2-clique", then \eqref{item:hc-uniform-first-order} holds as $\HCFixpoint_{\?A,\?B}(\topLatticeGuessFunctions{B})(a) = B$ for each $a\in \?A$ and each $\?A$. Yet, \eqref{item:hc-uniform-finite-duality} does not hold since $\?B$ does not even have "tree duality" by TODO:addref.} 

	\proofcase{\eqref{item:hc-uniform-finite-duality} $\Rightarrow$
		\eqref{item:hc-uniform-finite-structures}.}
	To prove this implication, we first need a characterization of
	what it means for an element $b\in B$ not to be in $\HCFixpoint{\?A}{\?B}(a)$,
	where $a\in A$.
	% \begin{claim}
	% 	\!\footnote{This claim is a strengthening of \cite[Lemma 3.2]{LaroseLotenTardif2007CharacterisationFOCSP}, which is itself an adaptation of \cite[Theorem 21]{FederVardi1998ComputationalStructure}. The former
	% 	states that if $\HCFixpoint{\?A}{\?B}(a) = \emptyset$ for some $a \in A$,
	% 	then there exists a "$\sigma$-tree" $\?T$ "st" $\?T \homto \?A$ but $\?T \nothomto \?B$.}%
	% 	\AP\label{claim:hyperedge-consistency-uniform-convergence-tree-obstructions}
	% 	Let $a\in A$ and $b\in B$. If $b \not\in \HCFixpoint{\?A}{\?B}(a)$, then there
	% 	exists a "$\sigma$-tree" $\?T$ "st" there is a "homomorphism" $f\colon \?T \to \?A$
	% 	and an element $t \in T$ "st" $f(t) = a$ but no "homomorphism" from $\?A$ to $\?B$
	% 	can map $a$ to $b$.
	% 	Moreover, the "diameter" of $\?T$ is linearly bounded by the
	% 	least $n\in \N$ "st"
	% 	$b\not\in \HCOperator^{\,n}_{\?A,\?B}(\topLatticeGuessFunctions{B})(a)$.
	% \end{claim}
	This claim is actually proven in \cite[Proof of Lemma 3.2]{LaroseLotenTardif2007CharacterisationFOCSP}. 
	What we actually need is the converse to this property:
	\begin{claim}
		\AP\label{claim:hyperedge-consistency-uniform-convergence-tree-witnesses}
		Let $a\in A$ and $b\in B$. Assume that there exists a "$\sigma$-tree" $\?T$ "st" there is a "homomorphism" from $\?T$ to $\?A$ that maps some element $t \in T$ to $a$, but no "homomorphism" from $\?T$ to $\?B$
		can map $t$ to $b$. Then, letting $n$ denote the "height@@struct" of $\?T$ when rooted
		at $t$, we have $b \not\in \HCOperator^{\,n}_{\?A,\?B}(\topLatticeGuessFunctions{B})(a)$.
	\end{claim}
	We prove it by induction on $n$. TODO.

	\begin{claim}%
		\!\footnote{In fact, Larose, Loten \& Tardif implicitely showed a weaker result, by adapting
			\cite[Theorem 21]{FederVardi1998ComputationalStructure}, in
			\cite[Proof of Lemma 3.2]{LaroseLotenTardif2007CharacterisationFOCSP}.
			Is states that
			if $b \not\in \HCFixpoint{\?A}{\?B}(a)$, then there
			exists a "$\sigma$-tree" $\?T$ "st" there is a "homomorphism" from $\?T$ to $\?A$
			that maps some element $t \in T$ to $a$, but no "homomorphism" from $\?T$ to $\?B$
			can map $t$ to $b$. Moreover, the "height" of their "$\sigma$-tree" $\?T$ is linearly 
			bounded by the least $n\in \N$ "st"
			$b\not\in \HCOperator^{\,n}_{\?A,\?B}(\topLatticeGuessFunctions{B})(a)$.
			This property is true without any duality assumption on $\?B$, and only follows
			from the inner workings of the "hyperedge consistency algorithm".}%
		\AP\label{claim:hyperedge-consistency-uniform-convergence-size-trees}
		Assume that $\?B$ has "tree duality".
		Let $a\in A$ and $b\in B$. Assume that $b \not\in \HCFixpoint{\?A}{\?B}(a)$. Then there exists a "$\sigma$-tree" $\?T$, and $t\in T$ "st" there is a "homomorphism" from $\?T$ to $\?A$ sending $t$ to $a$, but no "homomorphism" from $\?T$ to $\?B$ sending $t$ to $b$.
		Moreover, the "height@@struct" of $\?T$ can be assumed to be linearly bounded
		by the greatest "diameter" of a "critical obstruction" of $\?B$.
	\end{claim}
	TODO:proof.

	Putting \Cref{claim:hyperedge-consistency-uniform-convergence-tree-witnesses,claim:hyperedge-consistency-uniform-convergence-size-trees} together with the fact that if $\?B$ has "finite duality", then the "diameter" of its "critical obstructions" must be bounded,
	we get that there exists some $n \in \N$ (that only depends on $\?B$),
	"st" for any finite "$\sigma$-structure" $\?A$, for all $a\in A$ and $b\in B$,
	if $b\not\in \HCFixpoint{\?A}{\?B}(a)$ then
	$b \not\in \HCOperator^{\,n}_{\?A,\?B}(\topLatticeGuessFunctions{B})(a)$.
	And hence, $\HCOperator^{\,n}_{\?A,\?B}(\topLatticeGuessFunctions{B}) = \HCFixpoint{\?A}{\?B}$,
	proving that \eqref{item:hc-uniform-finite-structures} holds.
	This concludes the proof of \Cref{lem:hyperedge-consistency-uniform-convergence}.
\end{proof}

% \begin{claim}
% 	If $\?A \nothomto \?B$, then there
% 	exists $a\in A$ "st" $\HCOperator^{\,n}(\topLatticeGuessFunctions{B})(a) = \emptyset$. 
% \end{claim}

% Indeed, let $\?D_1, \hdots, \?D_p$ be a finite set of "obstructions" for $\?B$.
% For each $i\in\lBrack 1,p\rBrack$, since $\?D_i \nothomto \?B$, there exists
% $n_i\in\N$ "st" $\HCOperator^{n_i}(\topLatticeGuessFunctions{B})(d_i) = \emptyset$ for some $d_i\in D_i$. We let $n \defeq \max_{i\in\lBrack 1,p\rBrack} n_i$.

% Then let $\?A$ be an arbitrary "$\sigma$-structure" such that $\?A \nothomto \?B$.
% Then $\?D_i \homto \?A$ for some $i \in \lBrack 1,p\rBrack$. 
% Let $h\colon \?D_i \to \?A$ be such a "homomorphism". 
% Then by \Cref{prop:hyperedge-consistency-no-hom}, 
% $\HCOperator^{n_i}_{\!\?A,\?B}(h(d_i)) \subseteq \HCOperator^{n_i}_{\!\?D_i,\?B}(d_i) = \emptyset$.
% In particular, $\HCOperator^{\,n}_{\!\?A,\?B}(\topLatticeGuessFunctions{B})(a)$ for some
% $a \in \?A$.

TODO: Is it true that $\{\?A \mid \?A \homto \?B\}$ is Gaifman-local iff
$\?B$ has "tree duality"?