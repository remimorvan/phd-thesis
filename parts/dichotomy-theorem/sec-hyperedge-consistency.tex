\section{\AP\label{sec:hyperedge-consistency}%
	Decidability of the Regular Homomorphism Problem}

In this section, we show that if $\?B$ has "finite duality", then $\HomRegAutDec{\?B}$ is decidable.
We provide two alternative proofs. In \Cref{sec:uniformly-first-order-definable-hom} we provide
a logic-based proof that if $\?B$ has "finite duality", then $\HomRegAutDec{\?B} = \HomAutDec{\?B}$,
and that $\HomRegAutDec{\?B}$ is decidable.
Independently, in \Cref{sec:hyperedge-consistency-finite,sec:hyperedge-consistency-automatic},
we introduce the "hyperedge consistency algorithm for automatic structures",
which is a variation of the classical "hyperedge consistency algorithm" for "finite structures".
We start by explaining the later algorithm,
which solves $\HomFinDec{\?B}$ for some $\?B$'s.\footnote{We will
see later that the algorithm is correct for "$\sigma$-structures" with so-called "tree duality",
which is a superclass of the "structures" with "finite duality".}
Then, we will use the former algorithm to prove that assuming that $\?B$ has "finite duality",
then $\HomRegAutDec{\?B}$ is decidable.\footnote{Interestingly, this algorithm cannot solve
$\HomRegAutDec{\?B}$ when $\?B$ has only "tree duality" but not "finite duality". 
We discuss this in more details in TODO.}

\subsection{\AP\label{sec:uniformly-first-order-definable-hom}%
	Uniformly First-Order Definable Homomorphisms}

We say that $\HomFinClass{\?B}$ (resp. $\HomAllClass{\?B}$)
have \AP""uniformly first-order definable homomorphisms"" if there exists "first-order formulas"
$\langle \phi_b(x) \rangle_{b\in B}$ over $\sigma$ "st" for any finite
(resp. arbitrary) "$\sigma$-structure" $\?A$, for any $a\in A$,
there is at most one $b \in B$ "st" $\langle \?A, a \rangle \models \phi_b(x)$, and moreover $\?A \homto \?B$
"iff" for each $a\in A$, there is exactly one $b(a) \in B$ "st" $\langle \?A, a \rangle \models \phi_{b(a)}(x)$, and $a \mapsto b(a)$ is a "homomorphism".

\begin{lemma}
	\AP\label{lemma:finite-duality-uniformly-definable-homomorphisms}
	Let $\?B$ be a finite structure. Then $\HomAllClass{\?B}$ is "first-order definable" "iff"
	$\HomAllClass{\?B}$ has "uniformly first-order definable homomorphisms".\footnote{The same 
	equivalence holds if one replaces $\HomAllClass{\?B}$ with $\HomFinClass{\?B}$.
	In both cases, these conditions are equivalent, by "Atserias' theorem", to asking that $\?B$
	has "finite duality".}
\end{lemma}

Before proving this lemma, we show an intermediate result.
\begin{fact}
	\AP\label{fact:marking-preserves-finite-duality}
	If $\?B$ is a finite "core", then is $\HomAllClass{\?B}$ is "first-order definable"
	"iff" $\HomAllClass{\marked{\?B}}$ is "first-order definable".
\end{fact}

\begin{proof}
	By \Cref{prop:marking-preserves-csp-complexity} the problems are "first-order equivalent" and so
	one is "first-order definable" "iff" the other is. TODO:fix (ref is about decision pb).
\end{proof}

\begin{proof}[Proof \Cref{lemma:finite-duality-uniformly-definable-homomorphisms}]
	\proofcase{Converse implication.} Assume that $\HomAllClass{\?B}$ has
	"uniformly first-order definable homomorphisms", say by $\langle \phi_b(x) \rangle_{b\in B}$.
	Then the conjunctions of the properties 
	``every $x$ must satisfy exactly one $\phi_b(x)$ ($b\in \?B$)'',
	and ``for every "relation symbol" $\+R$ of arity $k$, for any $\langle x_1,\, \hdots,\, x_k \rangle$ in $\+R$, there exists $\langle b_1,\, \hdots,\, b_k \rangle \in \+R(\?B)$ "st"
	each $x_i$ satisfies $b_i$ ($i \in \lBrack 1,k \rBrack$)'' is a "first-order sentence"
	describing all "$\sigma$-structures" of $\HomAllClass{\?B}$.

	\proofcase{Direct implication.} 
	Let $\?B$ such that $\HomAllClass{\?B}$ is "first-order definable".
	Given an arbitrary "$\sigma$-structure" $\?A$, we define a function $F\colon A \to \pset{B}$
	by mapping each $a$ to the set of $b$'s ($b \in \?B$) "st"
	there is a "homomorphism" from $\?A$ to $\?B$ that maps $a$ to $b$.
	\begin{claim}
		\label{claim:finite-duality-uniformly-definable-homomorphisms-homomorphism}
		If $\?A \homto \?B$ then $F$ is a "homomorphism" from $\?A$ to $\FederVardi{\?B}$.
	\end{claim}
	Indeed, since $\?A\homto\?B$, for each $a\in A$ the set
	$F(a)$ is non-empty subset of $B$---and hence an element of the domain of $\FederVardi{\?B}$.
	We then prove that it is a "homomorphism": let $\+R$ be a "relation symbol" of arity $l$,
	and let $\langle a_1,\,\hdots,\,a_l \rangle \in \+R(\?A)$. Then for each $i \in \lBrack 1,l\rBrack$, for every $b_i \in F(a_i)$, there exists a "homomorphism" $f$ from $\?A$ to $\?B$
	that sends $a_i$ to $b_i$. Then $f(a_j) \in F(a_j)$ for every $j\in \lBrack 1,l\rBrack$
	and moreover $\langle f(a_1),\,\hdots,\, f(a_l) \rangle \in \+R(\?B)$.
	Hence, $\langle F(a_1),\,\hdots,\,F(a_l) \rangle \in \+R(\FederVardi{\?B})$,
	which concludes the proof that $F$ is a "homomorphism" from $\?A$ to $\FederVardi{\?B}$.

	By "Atserias' theorem", since $\HomAllClass{\?B}$ is "first-order definable",
	then $\?B$ has "finite duality", and in particular it has TODO:addref
	"tree duality" and so by TODO:addref, there is a "homomorphism"
	$g\colon \FederVardi{\?B} \to \?B$.
	We will now produce "first-order formulas" to describe $g \circ F$.

	If $\HomAllClass{\?B}$ is "first-order definable", then so is
	$\HomAllClass{\marked{\?B}}$ by \Cref{fact:marking-preserves-finite-duality}.
	So, let $\phi$ be a "first-order formula" over $\extendedSignature{\sigma}{\?B}$
	that describes $\HomAllClass{\marked{\?B}}$. We let $B = \{b_1,\hdots,b_k\}$.
	We define a "first-order formula" $\phi^*_i(x_i)$ over $\sigma$,
	by substituting each occurrence of $\unarypred{b_i}(y)$ in $\phi$ for $y = x_i$,
	and $\unarypred{b_j}(y)$ ($j \neq i$) for $\bot$.
	Let $\?A$ be a finite "$\sigma$-structure", $a\in A$ and $i \in \lBrack 1,k\rBrack$
	and $\?A_{a,i}$ be the
	"$\extendedSignature{\sigma}{\?B}$-structure" obtained by letting 
	$\unarypred{b_i}(\?A_{a,i}) \defeq \{a\}$
	and $\unarypred{b_j}(\?A_{a,i}) \defeq \emptyset$ for all $j \neq i$.

	\begin{claim}
		\AP\label{claim:finite-duality-uniformly-definable-homomorphisms-new-formulas}
		$\?A_{a,i} \models \phi$
		"iff" $\langle \?A, a \rangle \models \phi^*_i(x_i)$.
	\end{claim}
	We prove it by induction on formulas $\phi(\bar x)$
	that $\langle\?A_{a,i}, \bar a \rangle \models \phi$
		"iff" $\langle \?A, \bar a, a \rangle \models \phi^*_i(x_i)$.
	The base case $\unarypred{b_i}(y)$ is trivial since
	$\langle \?A_{a,i}, a' \rangle \models \unarypred{b_i}(y)$ "iff"
	$a' = a$ "ie" $\langle \?A, a', a \rangle \models y = x_i$.
	Similarly, for  $\unarypred{b_j}(y)$ ($j \neq i$),
	$\langle \?A_{a,i}, a' \rangle$ never "models" $\unarypred{b_j}(y)$
	and so this is equivalent to $\langle \?A, a', a \rangle \models \bot$.
	The other atomic cases, and inductive cases are trivial.

	\begin{claim}
		\AP\label{claim:finite-duality-uniformly-definable-homomorphisms-formulas}
		There exists first-order formulas $\langle \chi_Y(x)\rangle_{Y\in \pset{B}}$,
		that do not depend on $\?A$, "st" for every arbitrary "$\sigma$-structure" $\?A$,
		for every $a\in A$, then $\langle \?A,a \rangle \models \chi_Y(x)$ "iff"
		$F(a) = Y$.
	\end{claim}
	Indeed, given $a\in A$ and $i \in \lBrack 1,k\rBrack$, there is a "homomorphism" from $\?A$
	to $\?B$ that sends $a$ to $b_i$ "iff" $\?A_{a,i} \models \phi$, and so by \Cref{claim:finite-duality-uniformly-definable-homomorphisms-new-formulas}, this is equivalent to
	$\langle \?A,a\rangle \models \phi^*_i(x_i)$. Hence, each $\chi_Y(x)$ can be defined as
	a Boolean combination of the $\phi^*_i(x_i)$'s, after renaming $x_i$ to $x$.\footnote{In 
	particular, note that $\exists x.\psi_\emptyset(x)$ is a "first-order formula"
	that defines $\HomAllClass{\?B}$.}

	We can now prove that
	$\HomAllClass{\?B}$ has "uniformly first-order definable homomorphisms".
	For each $b\in B$, we let $\psi_b(x) \defeq \bigvee_{Y \in g^{-1}[b]} \chi_Y(x)$.
	Now for any arbitrary "$\sigma$-structure" $\?A$, for any $a\in A$,
	there is at most one $b\in B$ "st" $\langle \?A, a \rangle \models \psi_b(x)$---indeed,
	there is a unique $Y \in \pset{B}$ (and so at most one $Y \in \psetp{B}$) "st"
	$\langle \?A, a \rangle \models \chi_Y(x)$ by
	\Cref{claim:finite-duality-uniformly-definable-homomorphisms-formulas}.
	Moreover, if $\?A \homto \?B$, then for each $a$ there is a unique $b(a) \in B$
	"st" $\langle \?A, a \rangle \models \psi_{b(a)}(x)$, and moreover $a \mapsto b(a)$
	is a "homomorphism" by 
	\Cref{claim:finite-duality-uniformly-definable-homomorphisms-homomorphism}, and
	moreover $\?A \homto \?B$
	"iff" for each $a\in A$, there is exactly one $b(a) \in B$ "st" $\langle \?A, a \rangle \models \phi_{b(a)}(x)$, and $a \mapsto b(a)$ is a "homomorphism"
	by \Cref{claim:finite-duality-uniformly-definable-homomorphisms-homomorphism}
	since it equals $g \circ F$. And hence $\HomAllClass{\?B}$
	has "uniformly first-order definable homomorphisms".
\end{proof}

"Uniformly first-order definable homomorphisms" are actually a very strong restriction:
we show that such "homomorphisms" are always "regular".
\begin{proposition}
	\AP\label{prop:uniformly-first-order-implies-regular}
	Let $\?B$ be a finite "$\sigma$-structure".
	If $\HomAllClass{\?B}$ has "uniformly first-order definable homomorphisms",
	then $\HomRegAutDec{\?B} = \HomAutDec{\?B}$.
\end{proposition}

\begin{proof}
	Let $\•A$ be an "automatic presentation" of a "$\sigma$-structure" $\?A$,
	and assume that $\?A \homto \?B$. We need to show that $\•A \homregto \?B$.
	Let $\langle \phi_b(x) \rangle_{b\in B}$ be "first-order formulas" over $\sigma$
	as in the definition of "uniformly first-order definable homomorphisms".
	
	Since $\•A$ is an "automatic presentation" over $\Sigma$,
	for each "relation symbol" $\+R$ of arity $k$
	of $\sigma$, there exists a "first-order formula" $\psi_{\+R}(x_1,\hdots,x_k)$ over 
	$\signatureSynchronous{\Sigma}$ describing each relation $\+R$.
	We then define $\phi^*_b(x)$ as the formulas obtained from $\phi_b(x)$
	by substituting $\+R(x_1,\hdots,x_k)$ for $\psi_{\+R}(x_1,\hdots,x_k)$.

	Then, for each $b\in B$, $\phi^*_b(x)$ is a "first-order formula" over $\signatureSynchronous{\Sigma}$,
	and so \[\{u \in \Sigma^* \mid \langle \univStructSynchronous{\Sigma},u \rangle \models \phi^*_b(x)\}\] is "regular@@lang" by TODO:ADDREF.
	Clearly, this sets are disjoint and cover $\domainPres{\•A}$, and the function that
	maps $u \in \domainPres{\•A}$ to the unique $b$ "st" $\langle \univStructSynchronous{\Sigma},u \rangle \models \phi^*_b(x)$ is a "homomorphism".
	Hence, we have built a "regular homomorphism" from $\•A$ to $\?B$, which concludes the proof.
\end{proof}

\begin{corollary}[of "Atserias' theorem", \Cref{lemma:finite-duality-uniformly-definable-homomorphisms,prop:uniformly-first-order-implies-regular}]
	\AP\label{coro:finite-duality-implies-hom-equals-homreg}
	If $\?B$ has "finite duality",
	then $\HomRegAutDec{\?B} = \HomAutDec{\?B}$.
\end{corollary}

In turn, since $\HomAutDec{\?B}$ is "coRE" and $\HomRegAutDec{\?B}$ is "RE", this implies
that $\HomRegAutDec{\?B}$ is decidable.
In fact, using the formulas $\phi^*_b(x)$, we can build a "first-order formula"
saying ``every $x$ satisfies exactly one $\phi^*_b(x)$, and moreover
if $\langle x_1,\hdots,x_k\rangle$ is an "$\+R$-hyperedge" then
$\langle b_1,\hdots,b_k \rangle$ is an $\+R$-hyperedge, where $b_i$ is the unique element of $B$
"st" $\phi_{b_i}(x_i)$ holds''. Each property ``$\langle x_1,\hdots,x_k\rangle$ is an "$\+R$-hyperedge"'' can be expressed using a "first-order formula" expressing the "relations"
of the "automatic presentation" given as input.

\begin{corollary}[of "Atserias' theorem" and \Cref{lemma:finite-duality-uniformly-definable-homomorphisms}]
	\AP\label{coro:finite-duality-implies-homreg-decidable}
	Let $\?B$ be a finite "$\sigma$-structure" with "finite duality".
	For each "automatic presentation" $\•A$ over alphabet $\Sigma$, there exists a "first-order 
	formula" $\phi$, whose size is linear in $\•A$, "st" $\univStructSynchronous{\Sigma} \models 
	\phi$ "iff" $\•A \homregto \?B$.
\end{corollary}

\subsection{\AP\label{sec:hyperedge-consistency-finite}%
	Hyperedge Consistency for Finite Structures}

Given a "homomorphism" $f\colon \?G \to \?H$ between "graphs",
note that if $g\in G$ has at least one successor in $\?G$, then must have $f(g)$ in $\?H$.
As a consequence, such an $g$ cannot be mapped by any "homomorphism" to a vertex of $\?H$ with no
successor. The idea behind "hyperedge consistency@@finite" is precisely to identify for each
$g\in G$ the set $\textrm{Im}_g$ of all elements of $\?H$ to which it can be mapped: initially this set is $H$,
and we try to find some ``obstructions''. These obstructions take the following form:
if $g \in G$ has a successor (resp. predecessor) $g' \in G$, then any vertex of $\textrm{Im}_g$
must have a successor (resp. predecessor) in $\?H$ that lives in $\textrm{Im}_{g'}$.


\begin{example}[{\Cref{ex:zigzag-defn}, continued}]
	\AP\label{ex:zigzag-HC-T2}
	We depict in \Cref{fig:zigzag-graph-HC-T2} the first steps of the "hyperedge consistency algorithm"---that we will define formally after this example---, when the "target structure"
	if $\transitiveTournament{2}$ and the "input structure" is $\zigzag{n}{2}$.
	The second step is a fixpoint, and so the procedure stops there. Note also that
	each $\textrm{Im}_g$ ($g\in \zigzag{n}{2}$) is non-empty. 
\end{example}

\begin{figure}
	\centering
	\begin{tikzpicture}
		\input{tikz/zigzag-graph}
		% \input{tikz/2-transitive-tournament}
		\input{tikz/zigzag-graph-HC-T2-step0}
	\end{tikzpicture}\\[2em]
	\begin{tikzpicture}
		\input{tikz/zigzag-graph}
		% \input{tikz/2-transitive-tournament}
		\input{tikz/zigzag-graph-HC-T2-step1}
	\end{tikzpicture}\\[2em]
	\begin{tikzpicture}
		\input{tikz/zigzag-graph}
		% \input{tikz/2-transitive-tournament}
		\input{tikz/zigzag-graph-HC-T2-step2}
	\end{tikzpicture}
	\caption{\AP\label{fig:zigzag-graph-HC-T2} Zeroth (above), first (middle) and second step (below) of the "hyperedge consistency algorithm" on $\zigzag{n}{2}$
	when the "target structure" is $\transitiveTournament{2}$, depicted in \Cref{fig:zigzag-graph-HC-T2-side-T2}. Next to each vertex $g$ of $\zigzag{n}{2}$ we represent
	all vertices $h$ of $\transitiveTournament{2}$: the vertex is filled
	when $h \in \textrm{Im}_{g}$.
	}
\end{figure}
\begin{marginfigure}[-15.5em]
	\centering
	\begin{tikzpicture}
		\input{tikz/2-transitive-tournament}
	\end{tikzpicture}
	\caption{
		\AP\label{fig:zigzag-graph-HC-T2-side-T2}
		The "$2$-transitive tournament" $\transitiveTournament{2}$.
	}
\end{marginfigure}

We formalize this algorithm as the greatest fixpoint of some operator.
Given a finite "$\sigma$-structure" $\?B$, and an arbitrary\sidenote{Note that in this part, while some results---mostly complexity/decidability ones---require the assumption that the "left structure" is finite, some results do not,
and are stated for arbitrary "structures".}%
"$\sigma$-structure" $\?A$, we say that a function $F\colon A \to \pset{B}$ is "subsumed"
by $G\colon A \to \pset{B}$, denoted by \AP\(F \intro*\subsumed G\),
if $F(a) \subseteq G(a)$ for each $a \in A$. We denote by
\AP\(\intro*\LatticeGuessFunctions{A}{B}\) the set of functions $A \to \pset{B}$ under this order.%
\footnote{Equivalently, $\LatticeGuessFunctions{A}{B}$ is the
set of binary relations between $A$ and $B$, ordered by inclusion.}

We then define an operator on this space, which corresponds to one step of the "hyperedge consistency algorithm@@finite":
\begin{center}
	\begin{tabular}{rccc}
		$\HCOperator_{\!\?A,\?B}\colon$ & $\LatticeGuessFunctions{A}{B}$ & $\to$ & $\LatticeGuessFunctions{A}{B}$ \\
		& $F$ & $\mapsto$ & $\HCOperator_{\!\?A,\?B}(F)$,
	\end{tabular}
\end{center}
where for each $a \in A$, \AP$\intro*\HCOperator_{\!\?A,\?B}(F)(a)$ is the set of $b \in F(a)$ "st"
for every $\+R_{(k)} \in \sigma$, for every $i \in \lBrack 1,k\rBrack$,
if $\langle a_1,\, \hdots,\, a_{k-1} \rangle \in \neighbourhood{a}{\?A}{\+R}{i}$,
then there exists $b_1 \in F(a_1)$, $\hdots$, $b_{k-1} \in F(a_{k-1})$ "st" 
$\langle b_1,\, \hdots,\, b_{k-1} \rangle \in \neighbourhood{b}{\?B}{\+R}{i}$.\footnote{%
We write $\HCOperator$ for $\HCOperator_{\!\?A,\?B}$ when there is no ambiguity on
the "structures" involved.}

\begin{fact}
	The ordered set $\LatticeGuessFunctions{A}{B}$ is a "complete lattice",
	and moreover $\HCOperator$ is monotonic.
\end{fact}

As a consequence of the "Knaster-Tarski theorem", $\HCOperator$ admits a greatest fixpoint, that
we denote by \AP$\intro*\HCFixpoint{\?A}{\?B} \in \LatticeGuessFunctions{A}{B}$.\footnote{Recall 
that this greatest fixpoint can be obtained by ordinal induction by starting from
the greatest element of $\LatticeGuessFunctions{A}{B}$, namely the map $a \mapsto B$,
and iterating $\HCOperator$.}

\begin{proposition}
	\AP\label{prop:existence-homomorphism-implies-lowerbound-HC}
	If $f\colon \?A \to \?B$ is a "homomorphism" then $f(a) \in \HCFixpoint{\?A}{\?B}(a)$
	for each $a \in A$.
\end{proposition}

\begin{proof}
	The property ``$f(a) \in F(a)$ for each $a\in A$'' holds for the greatest element
	of $\LatticeGuessFunctions{A}{B}$, is stable under application of $\HCOperator$ and
	under arbitrary meets.\footnote{Meaning that if all $F_i$ ($i \in I$ for some arbitrary set $I$)
	satisfy the property, then so does $a \mapsto \bigcap_{i \in I} F(a)$}
	Hence, by ordinal induction, it holds for $\HCFixpoint{\?A}{\?B}$.
\end{proof}

\begin{corollary}
	\AP\label{coro:HC-empty-implies-no-hom}
	If $\HCFixpoint{\?A}{\?B}(a) = \emptyset$ for some $a\in A$, then
	$\?A \nothomto \?B$.
\end{corollary}

In general, the converse property does not hold. For instance, if $\sigma$ is the
"signature of graphs" and $\?B$ is the "$2$-clique", then $\HCFixpoint{\?A}{\?B}$
is always the map $a \mapsto B$, no matter whether there is a "homomorphism" from
$\?A$ to $\?B$.

Yet, TODO managed to identify a necessary and sufficient condition on $\?B$ for
the "hyperedge consistency algorithm@@finute" to decide whether $\?A \in \HomFinDec{\?B}$.
\begin{definition}
	\AP\label{defn:tree-duality}
	A finite "$\sigma$-structure" $\?B$ has ""tree duality"" when TODO.
\end{definition}

\begin{proposition}[todo:addref]
	\AP\label{prop:finite-duality-implies-tree-duality}
	If a finite "$\sigma$-structure" $\?B$ has ""finite duality"",
	then it has "tree duality".
\end{proposition}

\begin{proposition}[TODO:addref]
	\AP\label{prop:hyperedge-consistency-tree-duality}
	If $\?B$ has "tree duality" then $\?A \homto \?B$ "iff"
	$\HCFixpoint{\?A}{\?B}(a) \neq \emptyset$ for all $a\in A$.
\end{proposition}

When $\?A$ is moreover finite, this immediately gives an algorithm to decide
$\?A \homto \?B$ since $\HCFixpoint{\?A}{\?B}$ can be computed not only
by an ordinal induction but with a finite induction.

As an example, \Cref{ex:zigzag-HC-T2} witnesses that
$\zigzag{n}{2} \homto \transitiveTournament{2}$ since $\transitiveTournament{2}$
has "tree duality" by \Cref{prop:finite-duality-implies-tree-duality} and TODO:ADDREF.

\begin{figure}
	\centering
	\begin{tikzpicture}
		\input{tikz/zigzag-graph}
		\input{tikz/zigzag-graph-HC-P2-step2}
	\end{tikzpicture}
	\quad\emph{(step $2$)~}\\[2em]
	\begin{tikzpicture}
		\input{tikz/zigzag-graph}
		\input{tikz/zigzag-graph-HC-P2-step3}
	\end{tikzpicture}
	\quad\emph{(step $3$)~}\\[2em]
	\begin{tikzpicture}
		\input{tikz/zigzag-graph}
		\input{tikz/zigzag-graph-HC-P2-step6}
	\end{tikzpicture}
	\quad\emph{(step $6$)~}\\[2em]
	\begin{tikzpicture}
		\input{tikz/zigzag-graph}
		\input{tikz/zigzag-graph-HC-P2-step7}
	\end{tikzpicture}
	\quad\emph{(step $7$)~}\\[2em]
	\begin{tikzpicture}
		\input{tikz/zigzag-graph}
		\input{tikz/zigzag-graph-HC-P2-step13}
	\end{tikzpicture}
	\quad\emph{(step $13$)}
	\caption{%
		\AP\label{fig:zigzag-graph-HC-P2}
		Steps $2$, $3$, $6$, $7$ and $13$ of the "hyperedge consistency algorithm"
		on $\zigzag{5}{2}$,
		when the "target structure" is $\pathGraph{2}$, depicted in \Cref{fig:zigzag-graph-HC-P2-side-P2}.%
	}
\end{figure}
\begin{marginfigure}[-9.5em]
	\centering
	\begin{tikzpicture}
		\input{tikz/2-path-graph}
	\end{tikzpicture}
	\caption{
		\AP\label{fig:zigzag-graph-HC-P2-side-P2}
		The "$2$-path" $\pathGraph{2}$.
	}
\end{marginfigure}
\begin{example}[{\Cref{ex:zigzag-HC-T2}, continued}]
	\AP\label{ex:zigzag-HC-P2}
	On the other hand, while $\pathGraph{2}$ does not have "finite duality", it has
	"tree duality", by TODO:ADDREF, and so the "hyperedge consistency algorithm"
	decides whether a finite "$\sigma$-structure" has a "homomorphism" to $\pathGraph{2}$.
	We represent some steps of the algorithm in \Cref{fig:zigzag-graph-HC-P2},
	on the "input structure" $\zigzag{5}{2}$.
	Steps $0$, $1$ and $2$ of the "hyperedge consistency algorithm"
	are identical to \Cref{ex:zigzag-HC-T2}.
	Yet, in step $2$, we have not reached the fixpoint.
	In step $7$, this is the first time
	we have $\HCOperator^{7}(g) = \emptyset$ for some
	$g\in \zigzag{5}{2}$. This propagates until step 13, 
	when $\HCOperator^{13}(g) = \emptyset$
	for all $g\in \zigzag{5}{2}$. This is of course the fixpoint of $\HCOperator$,
	proving that $\HCFixpoint{\zigzag{5}{2}}{\pathGraph{2}}$ is the constant map
	equal to $\emptyset$, and by \Cref{coro:HC-empty-implies-no-hom}
	that $\zigzag{5}{2} \nothomto \pathGraph{2}$.

	In general, on "input structure" $\zigzag{n}{2}$ (with $n\in\Np$),
	the smallest $k$ "st" $\HCOperator^{\,k}(g) = \emptyset$
	for some $g \in \zigzag{n}{2}$ is of size $\frac{n}{2} + \+O(1)$,
	and if we want to the property to hold for \emph{all} $g$'s,
	then $k$ has size $n + \+O(1)$.
\end{example}

\begin{corollary}
	If $\?B$ has "tree duality", then $\HomFinDec{\?B}$ can be solved in
	polynomial time.\sidenote{TODO: Precise complexity.}
\end{corollary}

Finally, we will prove a proposition that we will prove useful later in TODO.
\begin{proposition}
	\AP\label{prop:HC-on-same-structure}
	Let $\?B$ be a "$\sigma$-structure" with "tree duality". Then
	$\HCFixpoint{\?B}{\?B}(b) = \{b\}$ for each $b\in B$.\footnote{Note that
	this is false if $\?B$ does not have finite duality. For instance,
	if $\?B$ is the "$2$-clique", then $\HCFixpoint{\?B}{\?B}(b) = B$
	for each $b \in B$.}
\end{proposition}
\begin{proof}
	TODO: Use rigidity.
\end{proof}

\subsection{\AP\label{sec:hyperedge-consistency-automatic}%
	Hyperedge Consistency for Automatic Structures}

When $\?A$ is "automatic", \Cref{prop:hyperedge-consistency-tree-duality} still applies,
however it is not clear how to compute $\HCFixpoint{\?A}{\?B}$ since this element cannot
necessarily be obtained by finite induction, namely as
$\HCOperator^{\,n}(\topLatticeGuessFunctions{B})$ for some $n\in\N$, where
\AP$\intro*\topLatticeGuessFunctions{B}$ is the maximum element
of $\LatticeGuessFunctions{A}{B}$, namely the constant map $a \mapsto B$.
Another issue is to have a finite representation of the functions of
$\LatticeGuessFunctions{A}{B}$ since $A$ can be infinite. This last point is easy to address.

Given an "automatic presentation" $\•A$ of $\?A$, we extend
$\HCOperator_{\!\•A,\?B}$ and $\HCFixpoint{\•A}{\?B}$ to be defined on $\domainPres{\•A}$
instead of $\?A$.

\begin{lemma}[$\HCOperator$ preserves "regularity@@fun"]
	\AP\label{lem:hyperedge-consistency-preserves-regularity}
	Let $\?A$ be an arbitrary "$\sigma$-structure" and $\?B$ a finite "$\sigma$-structure".
	For any $F\in \LatticeGuessFunctions{\•A}{B}$, if $F$ is "regular@@hom",
	then $\HCOperator(F)$ is "regular@@hom".
\end{lemma}

\begin{proof}
	Let $F\in \LatticeGuessFunctions{\•A}{B}$ be "regular@@hom",
	so for each $Y \in \pset{B}$, $F^{-1}[Y]$ is "regular@@lang", and so by \Cref{prop:synchronous-first-order}, there exists a "first-order formula" $\phi_Y(x)$ over
	\(\signatureSynchronous{\Sigma}\)
	"st" $F^{-1}[Y] = \semFO{\phi_Y(x)}{\univStructSynchronous{\Sigma}}$.
	Also, since $\•A$ is an "automatic presentation", for any $\+R \in \sigma$ of arity $k$,
	there exists by \Cref{prop:synchronous-first-order} a "first-order formula" $\psi_{\+R}(x_1,\ldots,x_k)$ over \(\signatureSynchronous{\Sigma}\) "st"
	$\relPres{\•A}{\•R} = \semFO{\psi_{\+R}(x_1,\hdots,x_k)}{\univStructSynchronous{\Sigma}}$.
	Similarly, $\domainPres{\•A} = \semFO{\psi_{\textrm{dom}}(x)}{\univStructSynchronous{\Sigma}}$
	for some "formula@@FO" $\psi_{\textrm{dom}}(x)$.

	It is then easy to prove that $\HCOperator(F)$ is "regular@@hom" by providing a "first-order 
	formula" $\widehat \phi_Y(x)$ for each $Y \in \pset{B}$, describing $\HCOperator(F)^{-1}[Y]$,
	using both the formulas above, and the definition of $\HCOperator$.
	Indeed, recall that an element $u \in \domainPres{\•A}$ should be sent via $\HCOperator(F)$ 
	onto $Y\in \pset{B}$ if $Y$ is exactly the set of elements $b \in B$ "st" for every $\+R_{(k)} \in \sigma$, for every $i \in \lBrack 1,k\rBrack$, if
	$\langle a_1,\, \hdots,\, a_{k-1} \rangle \in \neighbourhood{a}{\?A}{\+R}{i}$,
	then there exists $b_1 \in F(a_1)$, $\hdots$, $b_{k-1} \in F(a_{k-1})$ "st" 
	$\langle b_1,\, \hdots,\, b_{k-1} \rangle \in \neighbourhood{b}{\?B}{\+R}{i}$.
	Symbolically the set of such $u$'s can be written as
	$\semFO{\widehat \phi_Y(x)}{\univStructSynchronous{\Sigma}}$, where
	\[
		\widehat \phi_Y(x) \defeq 
			\psi_{\textrm{dom}}(x) \land \big(\bigwedge_{b\in Y} \chi_b(x) \land \bigwedge_{b\not\in Y} \neg\chi_b(x)\big)
	\]
	where $\chi_b(x)$ is the formula\footnote{Notice that since
	$\chi_b$ appear both positively and negatively in $\widehat \phi_Y$, going from
	the $\phi$'s to the $\widehat \phi's$ increases the "quantifier alternation" of the
	"formulas@@FO" by one. And so the "formulas@@FO" we build to describe $\HCOperator^{\,n}(\topLatticeGuessFunctions{B})$ are of "quantifier alternation" $n$.
	TODO:CONCLUDE SOMEWHERE THAT CONSTRUCTION IS NOT ELEMENTARY.}
	\begin{align*}
		\chi_b(x) \defeq\; &
			\bigwedge_{\+R_{(k)} \in \sigma} \bigwedge_{i\in \lBrack 1,k\rBrack}\;
			\forall x_1.\, \hdots\, \forall x_{i-1}.\, \forall x_{i+1}.\, \hdots \, \forall x_{k}.\,\\
			& \hspace{2em}\psi_{\+R}(x_1,\hdots, x_{i-1}, x, x_{i+1}, \hdots, x_k)
			\\ 
			& \hspace{2em} \Rightarrow \Big(\bigvee_{\substack{\langle b_1,\hdots,b_{i-1},b_{i+1},\hdots b_k\rangle \in \neighbourhood{b}{\?B}{\+R}{i}}}\;
			\bigwedge_{i \in \lBrack 1,k\rBrack \smallsetminus \{i\}}
			\underbrace{%
				\bigvee_{\substack{Y' \in \pset{B}\\ b_i\in Y'}} \phi_{Y'}(x_i)
			}_{%
				b_i \in F(x_i)
			}%
			\Big).\qedhere
	\end{align*}
\end{proof}

Notice that $\topLatticeGuessFunctions{B}$ is trivially "regular@@fun", and so
by immediate induction, each $\HCOperator^{\,n}(\topLatticeGuessFunctions{B})$ with $n\in \N$ is
also "regular@@fun". While this opens the door to solving $\HomRegAutDec{\?B}$ when $\?B$ has
"tree duality" using the "hyperedge consistency algorithm@@finite", the problem
of finite convergence remains.

First, we show that finite iterations are enough to detect the absence of "homomorphism".
\begin{proposition}
	\AP\label{prop:hyperedge-consistency-no-hom}
	Let $\?A$ be an arbitrary "$\sigma$-structure" and $\?B$ a "finite $\sigma$-structure"
	with "tree duality". If $\?A \nothomto \?B$, then there exists $n\in\N$ and $a\in A$ "st"
	$\HCOperator^{\,n}(\topLatticeGuessFunctions{B})(a) = \emptyset$. 
\end{proposition}

In order to prove this proposition, we rely on the following property.
\begin{property}[Monotonicity of $\HCOperator$]
	\!\footnote{Observe in particular that this property can be applied if $\?A'$ is a
	substructure of $\?A$.}%
	\AP\label{prop:hyperedge-consistency-antimonotonicity}
	Let $\?A$, $\?A'$ be arbitrary "$\sigma$-structures" "st"
	there is a "homomorphism" $h\colon \?A' \to \?A$. Let $\?B$ a "finite $\sigma$-structure".
	For any $F\in \LatticeGuessFunctions{A}{B}$ and $F' \in \LatticeGuessFunctions{A'}{B}$,
	if $F(h(a)) \subseteq F'(a)$ for all $a\in A'$, then $\HCOperator(F)(h(a)) \subseteq \HCOperator(F')(a)$ for all $a\in A'$.\footnote{In other words, if $F \circ h \subsumed F'$, then
	$\HCOperator(F) \circ h \subsumed \HCOperator(F')$.}
\end{property}

\begin{proof}
	Assume that $\restr{F}{A'} \subsumed F'$, and let us show that 
	$\restr{\HCOperator(F)}{A'} \subsumed \HCOperator(F')$.
	Let $a \in A'$, and let $b \in \HCOperator(F)(h(a))$.
	Then for every $\+R_{(k)} \in \sigma$,
	for every $i \in \lBrack 1,k\rBrack$,
	if $\langle a_1,\, \hdots,\, a_{k-1} \rangle \in \neighbourhood{h(a)}{\?A}{\+R}{i}$,
	then there exists $b_1 \in F(a_1)$, $\hdots$, $b_{k-1} \in F(a_{k-1})$ "st" 
	$\langle b_1,\, \hdots,\, b_{k-1} \rangle \in \neighbourhood{b}{\?B}{\+R}{i}$.
	Then let $\+R_{(k)} \in \sigma$ and $i \in \lBrack 1,k\rBrack$.
	Let $\langle a_1,\, \hdots,\, a_{k-1} \rangle \in \neighbourhood{a}{\?A'}{\+R}{i}$.
	Then $\langle h(a_1),\, \hdots,\, h(a_{k-1}) \rangle \in \neighbourhood{h(a)}{\?A}{\+R}{i}$
	since $h$ is a "homomorphism". And so there exists
	$b_1 \in F(h(a_1))$, $\hdots$, $b_{k-1} \in F(h(a_{k-1}))$ "st" 
	$\langle b_1,\, \hdots,\, b_{k-1} \rangle \in \neighbourhood{b}{\?B}{\+R}{i}$.
	Using the inclusions $F(h(a_i)) \subseteq F'(a_i)$ (for $a_i \in A'$), it follows that
	for every $\+R_{(k)} \in \sigma$, for every $i \in \lBrack 1,k\rBrack$,
	if $\langle a_1,\, \hdots,\, a_{k-1} \rangle \in \neighbourhood{a}{\?A'}{\+R}{i}$, then
	there exists $b_1 \in F'(a_1)$, $\hdots$, $b_{k-1} \in F'(a_{k-1})$
	"st" $\langle b_1,\, \hdots,\, b_{k-1} \rangle \in \neighbourhood{b}{\?B}{\+R}{i}$.
	And hence $b \in \HCOperator(F')(a)$, which concludes the proof.
\end{proof}

\begin{proof}[Proof of \Cref{prop:hyperedge-consistency-no-hom}]
	Let $\?A$ be an arbitrary "$\sigma$-structure" and $\?B$ a "finite $\sigma$-structure"
	with "tree duality". Assume that $\?A \nothomto \?B$.
	Then by \Cref{prop:de-bruijn-erdos} there exists a finite "substructure" $\?A'$
	of $\?A$ "st" $\?A' \nothomto \?B$,
	and so by \Cref{prop:hyperedge-consistency-tree-duality},
	there exists some $a\in A$ "st" $\HCFixpoint{\?A'}{\?B}(a) = \emptyset$.
	But since $\?A'$ is finite, $\HCFixpoint{\?A'}{\?B} = \HCOperator^{\,n}(\topLatticeGuessFunctions{B})$ for some $n\in\N$. Then using \Cref{prop:hyperedge-consistency-antimonotonicity},
	\[
		\HCOperator_{\!\?A,\?B}^{\,n}(\topLatticeGuessFunctions{B})(a)
		\subseteq \HCOperator_{\!\?A',\?B}^{\,n}(\topLatticeGuessFunctions{B})(a)
		= \HCFixpoint{\?A'}{\?B}(a)
		= \emptyset.\qedhere
	\]
\end{proof}

So, if $\?A \nothomto \?B$, then "hyperedge consistency" will detect it in finite time assuming 
that $\?B$ has "tree duality".
We will then show the dual implication, under the stronger assumption that $\?B$ has "finite 
duality": the reason we need this stronger assumption is that while the "hyperedge consistency algorithm@@finite" converges for finite "$\sigma$-structures" when $\?B$ has "tree duality",
the number of iterations needed to reach the fixpoint depends on $\?A$:
for instance, in \Cref{ex:zigzag-HC-P2}, we showed that when the target structure
is $\pathGraph{2}$, then "hyperedge consistency algorithm@@finite" converges
on $\zigzag{n}{2}$ in $n + \+O(1)$ steps.
On the other hand, for "structures"
with "finite duality", we show that this is not the case---and hence, convergence generalizes to 
infinite "$\sigma$-structures": for instance, we showed in \Cref{ex:zigzag-HC-P2}
that over the "target structure" $\transitiveTournament{2}$, which has "finite duality", 
then "hyperedge consistency algorithm@@finite" converges
on $\zigzag{n}{5}$ in only $2$ steps.

\begin{lemma}[Uniform Convergence of Hyperedge Consistency for Structures with Finite Duality]
	\AP\label{lem:hyperedge-consistency-uniform-convergence}
	Let $\?B$ be a finite "$\sigma$-structure".
	The following are equivalent:
	\begin{enumerate}
		\itemAP\label{item:hc-uniform-finite-duality}%
			$\?B$ has finite duality;
		\itemAP\label{item:hc-uniform-finite-structures}%
			there exists $n\in\N$ "st" for every \emph{finite} "$\sigma$-structure" $\?A$, $\HCOperator^{\,n}_{\!\?A,\?B}(\topLatticeGuessFunctions{B}) = \HCFixpoint{\?A}{\?B}$
			when $\?A \homto \?B$, and
			$\HCOperator^{\,n}_{\!\?A,\?B}(\topLatticeGuessFunctions{B})(a) = \emptyset$ for some $a\in A$ when $\?A \nothomto \?B$;
		\itemAP\label{item:hc-uniform-arbitrary-structures}%
			there exists $n\in\N$ "st" for every \emph{arbitrary} "$\sigma$-structure" $\?A$, $\HCOperator^{\,n}_{\!\?A,\?B}(\topLatticeGuessFunctions{B}) = \HCFixpoint{\?A}{\?B}$
			when $\?A \homto \?B$, and
			$\HCOperator^{\,n}_{\!\?A,\?B}(\topLatticeGuessFunctions{B})(a) = \emptyset$ for some $a\in A$ when $\?A \nothomto \?B$;
	\end{enumerate}
\end{lemma}

\begin{proof}
	We prove the implications
	\eqref{item:hc-uniform-finite-duality} $\Rightarrow$
	\eqref{item:hc-uniform-finite-structures} $\Rightarrow$
	\eqref{item:hc-uniform-arbitrary-structures} $\Rightarrow$
	\eqref{item:hc-uniform-finite-duality}.
	
	\proofcase{\eqref{item:hc-uniform-finite-structures} $\Rightarrow$
		\eqref{item:hc-uniform-arbitrary-structures}.}
	Let $n\in \N$ "st" $\HCOperator^{\,n}_{\!\?A',\?B}(\topLatticeGuessFunctions{B}) = \HCFixpoint{\?A'}{\?B}$ for every finite "$\sigma$-structure" $\?A'$. Let $\?A$ be an arbitrary
	"$\sigma$-structure". Note that for any $F\in \LatticeGuessFunctions{A}{B}$, for any 
	"substructure" $\?A'$ of $\?A$ containing $a$, then by \Cref{prop:hyperedge-consistency-antimonotonicity}
	$\HCOperator_{\?A,\?B}(F)(a) \subseteq \HCOperator_{\?A',\?B}(F)(a)$.
	We show that equality is reached by a particular finite "substructure".
	\begin{claim}
		\label{claim:hyperedge-consistency-ball}
		For any $F\in \LatticeGuessFunctions{A}{B}$ and $m\in \N$,
		there exists a finite "substructure"\footnote{Of course, if $\?A$ is "locally finite",
		we can always take $\?A_{a,m} = \ball{\?A}{a}{m}$.}
		$\?A_{a,m}$ of $\ball{\?A}{a}{m}$ "st"
		\[\HCOperator^{\,m}_{\?A,\?B}(F)(a) = \HCOperator^{\,m}_{\?A_{a,m},\?B}(F)(a).\]
	\end{claim}
	We give a proof sketch of this claim. Note that by definition,
	$\HCOperator_{\?A,\?B}(F)(a)$ only depends on the values of $F(a')$ where $a'$ is at distance 1.
	More precisely, it only depends on whether for any "relation symbol" $\+R$ of arity $k$,
	for any $i\in\lBrack 1,k\rBrack$, for any $Y_1,\hdots,Y_{k-1} \subseteq B$, whether there
	are elements $\langle a_1,\,\hdots,\,a_{k-1}\rangle \in \neighbourhood{a}{\?A}{\+R}{i}$
	"st"  
	$\langle F(a_1),\,\hdots,\,F(a_{k-1}) \rangle = \langle Y_1,\,\hdots,\,Y_{k-1} \rangle$.
	Since $B$ is finite, there are finitely many such tuples, and for each of them it suffices
	to keep (for distance $m=1$) only one tuple $\langle a_1,\,\hdots,\,a_{k-1}\rangle \in \neighbourhood{a}{\?A}{\+R}{i}$. By induction on $m$, we
	obtain a finite "substructure" $\?A_{a,m}$ of $\ball{\?A}{a}{m}$ as in
	\Cref{claim:hyperedge-consistency-ball}.

	We now show that $\HCOperator^{\,n}_{\!\?A,\?B}(\topLatticeGuessFunctions{B}) =
	\HCFixpoint{\?A}{\?B}$. By \Cref{claim:hyperedge-consistency-ball,prop:hyperedge-consistency-antimonotonicity}
	\[\HCOperator^{\,n}_{\!\?A,\?B}(\topLatticeGuessFunctions{B})(a) =
	\HCOperator^{\,n}_{\?A_{a,n+1},\?B}(\topLatticeGuessFunctions{B})(a).\]
	Since $\?A_{a,n+1}$ is finite, by \eqref{item:hc-uniform-finite-structures}, the right-hand side
	of the equality above equals $\HCFixpoint{\?A_{a,m}}{\?B}(a)$.
	But then again by \Cref{claim:hyperedge-consistency-ball} and \eqref{item:hc-uniform-finite-structures}, 
	\[\HCOperator^{n+1}_{\!\?A,\?B}(\topLatticeGuessFunctions{B})(a) = \HCFixpoint{\?A_{a,n+1}}{\?B}(a).\]
	And hence $\HCOperator^{\,n}_{\!\?A,\?B}(\topLatticeGuessFunctions{B})(a) = \HCOperator^{n+1}_{\!\?A,\?B}(\topLatticeGuessFunctions{B})(a)$. Since this property holds
	for arbitrary values of $a\in A$, it follows that $\HCOperator^{\,n}_{\!\?A,\?B}(\topLatticeGuessFunctions{B}) = \HCFixpoint{\?A}{\?B}$. 

	\proofcase{\eqref{item:hc-uniform-arbitrary-structures} $\Rightarrow$
		\eqref{item:hc-uniform-finite-duality}.}
	One can show---exactly as in the proof
	of \Cref{lem:hyperedge-consistency-preserves-regularity}---by induction on $m \in \N$
	that $\HCOperator^{\,m}_{\!\?A,\?B}(\topLatticeGuessFunctions{B})$
	is "first-order definable", in the sense that for all $Y \in \pset{B}$,
	there exists a "first-order formula" $\phi_{m,Y}(x)$ over $\sigma$ "st"
	$\HCOperator^{\,m}_{\!\?A,\?B}(\topLatticeGuessFunctions{B})^{-1}[Y] = \semFO{\phi_{m,Y}(x)}{\?A}$,
	"ie" for any $a\in A$, we have
	\[
		\langle \?A, a\rangle \models \phi_{m,Y}(x)
		\text{ "iff" }
		\HCOperator^{\,m}_{\!\?A,\?B}(\topLatticeGuessFunctions{B})(a) = Y.
	\]
	We then claim that
	\[
		\?A \models \forall x. \neg \phi_{n(\?B),\emptyset}(x)
		\text{ "iff" }
		\?A \homto \?B.
	\]
	The left-to-right implication can be proven by contraposition, 
	since if $\?A \nothomto \?B$ then by \eqref{item:hc-uniform-arbitrary-structures}
	we have $\HCOperator^{\,n(\?B)}_{\!\?A,\?B}(\topLatticeGuessFunctions{B})(a) = \emptyset$
	for some $a \in A$.
	For the right-to-left implication, we again use \eqref{item:hc-uniform-arbitrary-structures}, 
	which yields that $\HCOperator^{\,n(\?B)}_{\!\?A,\?B}(\topLatticeGuessFunctions{B}) = \HCFixpoint{\?A}{\?B}$. Together with the contraposition of \Cref{coro:HC-empty-implies-no-hom},
	this implies that $\HCOperator^{\,n(\?B)}_{\!\?A,\?B}(\topLatticeGuessFunctions{B})(a) \neq \emptyset$ for all $a\in A$. The conclusion that
	$\?B$ has "finite duality" follows from "Atserias' theorem".

	\proofcase{\eqref{item:hc-uniform-finite-duality} $\Rightarrow$
		\eqref{item:hc-uniform-finite-structures}.}
	To prove this implication, we first need a characterization of
	what it means for an element $b\in B$ not to be in $\HCFixpoint{\?A}{\?B}(a)$,
	where $a\in A$.
	We denote by $n(\?B)$ the maximal "diameter" of a "critical obstruction" of $\?B$---which
	must be finite since $\?B$ has "finite duality".
	% \begin{claim}
	% 	\!\footnote{This claim is a strengthening of \cite[Lemma 3.2]{LaroseLotenTardif2007CharacterisationFOCSP}, which is itself an adaptation of \cite[Theorem 21]{FederVardi1998ComputationalStructure}. The former
	% 	states that if $\HCFixpoint{\?A}{\?B}(a) = \emptyset$ for some $a \in A$,
	% 	then there exists a "$\sigma$-tree" $\?T$ "st" $\?T \homto \?A$ but $\?T \nothomto \?B$.}%
	% 	\AP\label{claim:hyperedge-consistency-uniform-convergence-tree-obstructions}
	% 	Let $a\in A$ and $b\in B$. If $b \not\in \HCFixpoint{\?A}{\?B}(a)$, then there
	% 	exists a "$\sigma$-tree" $\?T$ "st" there is a "homomorphism" $f\colon \?T \to \?A$
	% 	and an element $t \in T$ "st" $f(t) = a$ but no "homomorphism" from $\?A$ to $\?B$
	% 	can map $a$ to $b$.
	% 	Moreover, the "diameter" of $\?T$ is linearly bounded by the
	% 	least $n\in \N$ "st"
	% 	$b\not\in \HCOperator^{\,n}_{\?A,\?B}(\topLatticeGuessFunctions{B})(a)$.
	% \end{claim}
	% This claim is actually proven in \cite[Proof of Lemma 3.2]{LaroseLotenTardif2007CharacterisationFOCSP}. 
	% What we actually need is the converse to this property:
	\begin{claim}
		\AP\label{claim:hyperedge-consistency-uniform-convergence-tree-witnesses}
		Let $a\in A$ and $b\in B$. Assume that there exists a "$\sigma$-tree" $\?T$ "st" there is a "homomorphism" from $\?T$ to $\?A$ that maps some element $t \in T$ to $a$, but no "homomorphism" from $\?T$ to $\?B$
		can map $t$ to $b$. Then, letting $m$ denote the "height@@struct" of $\?T$ when rooted
		at $t$, we have $b \not\in \HCOperator^{\,m}_{\?A,\?B}(\topLatticeGuessFunctions{B})(a)$.
	\end{claim}
	We prove by induction on $\?T$ that if there are no "homomorphism" from $\?T$ to $\?B$
	that can map $t$ to $b$, then $b \not\in \HCOperator^{\,m}_{\?T,\?B}(\topLatticeGuessFunctions{B})(t)$ where $m$ is the "height" of $\?T$ rooted at $t$.
	TODO.
	Then by \Cref{prop:hyperedge-consistency-antimonotonicity}, 
	$\HCOperator^{\,m}_{\?A,\?B}(\topLatticeGuessFunctions{B})(a) \subseteq
	\HCOperator^{\,m}_{\?T,\?B}(\topLatticeGuessFunctions{B})(t)$ and so
	$b \not\in \HCOperator^{\,m}_{\?A,\?B}(\topLatticeGuessFunctions{B})(a)$.

	\begin{claim}%
		\AP\label{claim:hyperedge-consistency-uniform-convergence-no-hom}
		Let $a\in A$ and $b\in B$.
		If $\?A \nothomto \?B$, then $\HCOperator^{\,n(\?B)}_{\?A,\?B}(\topLatticeGuessFunctions{B})(a) = \emptyset$ for some $a \in A$.
	\end{claim}
	Indeed, since $\?A \nothomto \?B$, there exists a "critical obstruction" $\?T$ of $\?B$
	"st" $\?T \homto \?A$. Since $\?T \nothomto \?B$, for any $t \in T$ and $a\in A$
	"st" $t$ is mapped on $a$, we have by \Cref{claim:hyperedge-consistency-uniform-convergence-tree-witnesses} that for any $b\in B$,
	$b \not\in \HCOperator^{\,m}_{\?A,\?B}(\topLatticeGuessFunctions{B})(a)$,
	where $m$ is the "height" of $\?T$ when rooted at $t$.
	And hence $\HCOperator^{\,m}_{\?A,\?B}(\topLatticeGuessFunctions{B})(a) = \emptyset$.
	Since $m \leq n(\?B)$, this concludes the proof of the first part of
	\eqref{item:hc-uniform-finite-duality}. We will now handle the more tricky case of
	$\?A \homto \?B$.
	
	\begin{claim}%
		\!\footnote{In fact, Larose, Loten \& Tardif implicitely showed a weaker result, by adapting
			\cite[Theorem 21]{FederVardi1998ComputationalStructure}, in
			\cite[Proof of Lemma 3.2]{LaroseLotenTardif2007CharacterisationFOCSP}.
			Is states that
			if $b \not\in \HCFixpoint{\?A}{\?B}(a)$, then there
			exists a "$\sigma$-tree" $\?T$ "st" there is a "homomorphism" from $\?T$ to $\?A$
			that maps some element $t \in T$ to $a$, but no "homomorphism" from $\?T$ to $\?B$
			can map $t$ to $b$. Moreover, the "height" of their "$\sigma$-tree" $\?T$ is linearly 
			bounded by the least $n\in \N$ "st"
			$b\not\in \HCOperator^{\,n}_{\?A,\?B}(\topLatticeGuessFunctions{B})(a)$.
			This property is true without any duality assumption on $\?B$, and only follows
			from the inner workings of the "hyperedge consistency algorithm".}%
		\AP\label{claim:hyperedge-consistency-uniform-convergence-hom}
		Let $a\in A$ and $b\in B$.
		If $\?A \homto \?B$ and $b \not\in \HCFixpoint{\?A}{\?B}(a)$,
		then $b \not\in \HCOperator^{\,n(\?B)}_{\?A,\?B}(\topLatticeGuessFunctions{B})(a)$.
	\end{claim}

	To prove this claim, we use a construction that is similar to \Cref{prop:marking-preserves-csp-complexity}.
	Fix $a\in A$ and $b\in B$ "st" $b \not\in \HCFixpoint{\?A}{\?B}(a)$.
	Let $\?C$ be defined as the disjoint union of $\?A$ and $\?B$,
	in which we identify $a$ and $b$.
	Note that for any $a' \in A$, we have:
	\[
		\neighbourhood{a'}{\?C}{\+R}{i} =
		\begin{cases*}
			\neighbourhood{a'}{\?A}{\+R}{i} & \text{ if $a' \neq a$,}\\
			\neighbourhood{a}{\?A}{\+R}{i} \cup \neighbourhood{b}{\?B}{\+R}{i}  & \text{ if $a' = a = b$.}
		\end{cases*}	
	\]
	The goal of this construction
	is that, when running the "hyperedge consistency algorithm" on $\?C$,
	vertex $b$ will be removed as a potential image for $a$ since $b \not\in \HCFixpoint{\?A}{\?B}(a)$, but because of the copy of $\?B$ included in $\?C$, any "homomorphism" from $\?C$ to $\?B$ must map $a$ to $b$.
	\marginnote{TODO:add figure ($\?B$ is $\transitiveTournament{2}$, $\?A$ is 2-path.)}
	% \begin{claim}
	% 	\AP\label{claim:hyperedge-consistency-uniform-convergence-idempotent-core}
	% 	$\HCFixpoint{\?C}{\?B}(a) = \emptyset$.
	% \end{claim} 
	% Using \Cref{prop:hyperedge-consistency-antimonotonicity} on the natural embedding
	% $\?A \homto \?C$, we get $\HCFixpoint{\?C}{\?B}(a) \subseteq \HCFixpoint{\?A}{\?B}(a)$,
	% and so $b \not\in \HCFixpoint{\?C}{\?B}(a)$.
	% Similarly, using the natural embedding $\?B \homto \?C$
	% we get $\HCFixpoint{\?C}{\?B}(a) \subseteq \HCFixpoint{\?B}{\?B}(b)$,
	% which equals $\{b\}$ by \Cref{prop:HC-on-same-structure}.
	% And hence, $\HCFixpoint{\?C}{\?B}(a) = \emptyset$.

	\begin{claim}
		\AP\label{claim:hyperedge-consistency-uniform-convergence-hom-union}
		$\?C \nothomto \?B$.
	\end{claim} 

	Indeed, if there was a "homomorphism" from $\?C$ to $\?B$, say $f$, then
	$\restr{f}{\?B}$ would be a "homomorphism" from $\?B$ to $\?B$.
	Since $\?B$ has "finite duality", it is "rigid" by TODO:ADDREF, and
	so in particular $f(b) = b$.
	Hence, we would get that $\restr{f}{A}$ is a "homomorphism" from $\?A$ to $\?B$
	which sends $a$ to $b$, and so by \Cref{prop:existence-homomorphism-implies-lowerbound-HC}
	we would have $b \in \HCFixpoint{\?A}{\?B}(a)$, which is a contradiction.

	So, since $\?C \nothomto \?B$, there exists a "critical obstruction" $\?T$ of $\?B$
	"st" there is a "homomorphism" $f$ from $\?T$ to $\?C$. 
	We claim that $a=b$ must be in the image of $f$. Indeed, since $a=b$ is the only vertex
	of $\?A$ that is adjacent to $\?B$ in $\?C$, and since $\?T$ is "connected" by TODO:ADDREF,
	we would otherwise get that either $\?T \homto \?B$---contradicting that $\?T$ is a "critical obstruction" of $\?B$---or that $\?T \homto \?A$---contradicting that $\?A \homto \?B$.
	
	And so, there exists $t \in T$ "st" $f(t) = a = b$.
	Consider the "congruence induced" $\ker{f}$ by $f$ on $T$, namely $x \ker{f} y$ "iff"
	$f(x) = f(y)$. Let $\?U$ be the "quotient" of $\?T$ by $\ker{f}$,
	and let $\?U_{\?A}$ be the "substructure" of $\?U$, induced by elements
	of $U$ that are sent via $f$ on $\?A$.
	\begin{claim}
		\AP\label{claim:hyperedge-consistency-uniform-convergence-trees-are-trees}
		$\?U_{\?A}$ is a "tree".
	\end{claim}
	First, we show that $\?U_{\?A}$ is "connected". This amounts to showing that for
	every "path"\footnote{$t_i$ denotes an element of $\?T$ and $\bar h_i$ denotes a "hyperedge" of $\?T$. By definition of $\IncidenceGraph{\?T}$, $t_i \in \bar h_i$ and
	$t_{i+1} \in \bar h_i$.}
	\[
		t_0,\, \bar h_0,\, t_1,\, \bar h_1,\, \hdots,\, t_{n-1},\, \bar h_{n-1},\, t_n
	\]
	in $\IncidenceGraph{\?T}$, if the "path" it induces in $\?U$ is "simple",
	if $f(t_0) \in A$ and $f(t_n) \in A$,
	then $f(t_i) \in A$ for all $i \in \lBrack 0,n \rBrack$.
	By contradiction, we assume that $f(t_i) \not\in A$ for some $i \in \lBrack 0,n \rBrack$.
	Since the only vertex that is adjacent to both $\?A$ and $\?B$ in $\?C$ is $a=b$,
	we get that $f(t_j) = a = b$ for some $j < i$ and $f(t_{j'}) = a = b$ for some $j' > i$.
	And hence, the "path" $f(t_0), \hdots, f(t_n)$ is not "simple", which is a contradiction.

	We then show that $\?U_{\?A}$ is "acyclic". We consider a "path"
	\[
		t_0,\, \bar h_0,\, t_1,\, \bar h_1,\, \hdots,\, t_{n-1},\, \bar h_{n-1},\, t_n
	\]
	in $\IncidenceGraph{\?U_{\?A}}$, and assume that $t_i \neq t_j$ for all pairs
	$(i,j) \in \lBrack 0,n\rBrack \smallsetminus \{(0,n),\, (n,0)\}$.
	We want to show that $t_0 \neq t_n$.

	TODO.

	\begin{claim}
		\AP\label{claim:hyperedge-consistency-uniform-convergence-tree}
		There is a "homomorphism" from $\?T_{\?A}$ to $\?A$ that maps $t$ to $a$,
		but no "homomorphism" from $\?T_{\?A}$ to $\?B$ that maps $t$ to $b$.
	\end{claim}
	The first point is trivial: it suffices to consider the restriction of $f$ to $T_A$.
	For the second point, assume by contradiction that there is a "homomorphism" $g$ from
	$\?T_{\?A}$ to $\?B$ that maps $t$ to $b$.
	Then the function
	\[
		t' \in T \mapsto \begin{cases*}
			g(t') & \text{ if $t' \in T_A$,}\\
			f(t') & \text{ if $t' \in T_B$,}
		\end{cases*}
	\]
	is well-defined---if $t' \in T_A \cap T_B$, then $f(t') = b = g(t)$---and is a "homomorphism"
	from $\?T$ to $\?B$. This contradicts that $\?T$ is a "critical obstruction" of $\?B$.
	And hence, no "homomorphism" from $\?T_{\?A}$ to $\?B$ can map $t$ to $b$.
	We then apply \Cref{claim:hyperedge-consistency-uniform-convergence-tree-witnesses}
	to get that $b \not\in \HCOperator^{\,n(\?B)}_{\?A,\?B}(\topLatticeGuessFunctions{B})(a)$,
	concluding the proof of \Cref{claim:hyperedge-consistency-uniform-convergence-hom}.
	
	Overall, \Cref{claim:hyperedge-consistency-uniform-convergence-no-hom,claim:hyperedge-consistency-uniform-convergence-hom} prove 
	\eqref{item:hc-uniform-finite-structures}, which concludes the proof of \Cref{lem:hyperedge-consistency-uniform-convergence}.
\end{proof}

% \begin{claim}
% 	If $\?A \nothomto \?B$, then there
% 	exists $a\in A$ "st" $\HCOperator^{\,n}(\topLatticeGuessFunctions{B})(a) = \emptyset$. 
% \end{claim}

% Indeed, let $\?D_1, \hdots, \?D_p$ be a finite set of "obstructions" for $\?B$.
% For each $i\in\lBrack 1,p\rBrack$, since $\?D_i \nothomto \?B$, there exists
% $n_i\in\N$ "st" $\HCOperator^{n_i}(\topLatticeGuessFunctions{B})(d_i) = \emptyset$ for some $d_i\in D_i$. We let $n \defeq \max_{i\in\lBrack 1,p\rBrack} n_i$.

% Then let $\?A$ be an arbitrary "$\sigma$-structure" such that $\?A \nothomto \?B$.
% Then $\?D_i \homto \?A$ for some $i \in \lBrack 1,p\rBrack$. 
% Let $h\colon \?D_i \to \?A$ be such a "homomorphism". 
% Then by \Cref{prop:hyperedge-consistency-no-hom}, 
% $\HCOperator^{n_i}_{\!\?A,\?B}(h(d_i)) \subseteq \HCOperator^{n_i}_{\!\?D_i,\?B}(d_i) = \emptyset$.
% In particular, $\HCOperator^{\,n}_{\!\?A,\?B}(\topLatticeGuessFunctions{B})(a)$ for some
% $a \in \?A$.

% TODO: Is it true that $\{\?A \mid \?A \homto \?B\}$ is Gaifman-local iff
% $\?B$ has "tree duality"?