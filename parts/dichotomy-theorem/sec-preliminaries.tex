\section{Preliminaries}
\AP\label{sec:dichotomy-preliminaries}


\subsection{Notations}

Let \AP$\intro*\Fin$ denote the class of all "finite $\sigma$-structures",
\AP$\intro*\Aut$ the class of all "automatic $\sigma$-structures".
We let \AP$\intro*\AutPres$ be the class of all "automatic presentations of $\sigma$-structures",
and \AP$\intro*\FinPres$ be the subclass of "presentations" of "finite $\sigma$-structures".

We denote by \AP$\intro*\HomFinClass{\?B}$ and $\intro*\HomAllClass{\?B}$ the class
of all finite (resp. all) "$\sigma$-structures" that admit a "homomorphism" to $\?B$.

Given a "$\sigma$-structure" $\?B$, and a class $\classStruct$ of "automatic presentations of $\sigma$-structures", we denote by \AP$\intro*\HomDec{\classStruct}{\?B}$ the class of all presentations $\•A \in \classStruct$ such that the "$\sigma$-structure" $\?A$
that they "represent@@structure" admits a "homomorphism" to $\?B$.
Similarly, we denote by \AP$\intro*\HomRegDec{\classStruct}{\?B}$ the class 
associated to "regular homomorphisms".%
\sidenote{Todo: set-theoretic bullshit. Not a set but it is if we fix an alphabet. Blabla.}

While the existence of a "homomorphism" from some "automatic presentation" of $\?A$ 
to a "finite $\sigma$-structure" $\?B$ only depends on $\?A$ and not the "presentation" itself,
this is not true for "regular homomorphism".
For a $\sigma$-structure $\?B$,
we use \AP$\intro*\HomFinDec{\?B}$, $\intro*\HomAutDec{\?B}$, $\intro*\HomRegFinDec{\?B}$
and $\intro*\HomRegAutDec{\?B}$ as shorthands for $\HomDec{\FinPres}{\?B}$, $\HomDec{\AutPres}{\?B}$,
$\HomRegDec{\FinPres}{\?B}$ and $\HomRegDec{\AutPres}{\?B}$, respectively.

Note that any "homomorphism" from an "automatic presentation" of a "finite structure"
to a "finite structure" is also "regular@@hom" and so $\HomFinDec{\?B} = \HomRegFinDec{\?B}$.\sidenote{Note also that membership in $\HomFinDec{-} = \HomRegFinDec{-}$ and in
$\HomAutDec{-}$ only depends on the "structure represented"
by the "automatic presentation", and not on the "presentation" itself.
This is not the case for $\HomRegAutDec{-}$. We use these definitions for two reasons: (1) for consistency with $\HomRegAutDec{-}$ and (2) for the associated decision problem to be defined unambiguously. Note moreover that in the case of "finite structures", the size of its representation, say using adjacency lists, and of its "automatic presentation" are equal up to a TODO}

\subsection{Constructions on Structures}

Given two "structures" $\?A$ and $\?B$, we define the structure \AP$\intro*\powstruct{\?B}{\?A}$ as follows:
\begin{itemize}
  \item its domain are "homomorphisms" $\?A \to \?B$,
  \item for every "predicate" $\+R$ of arity $k$, for any homomorphism $f_1,\hdots,f_k$,
  we have $\langle f_1,\hdots,f_k\rangle \in \+R(\powstruct{\?B}{\?A})$ when for every
  $\langle a_1,\hdots,a_k\rangle \in \+R(\?A)$
  then $\langle f_1(a_1), \hdots, f_k(a_k) \rangle \in \+R(\?B)$.
\end{itemize}


\begin{proposition}[Folklore: Currying Homomorphisms]
	\AP\label{prop:currying-hom}
	Given "structures" $\?A$, $\?B$ and $\?C$, if $f\colon \?A\prodstruct \?B \to \?C$
	is a "homomorphism", then $F\colon \?A \to \powstruct{\?C}{\?B}$,
	defined by $a \mapsto (b \mapsto f(a,b))$, is a "homomorphism".
	In fact, this mapping $f \mapsto F$ is a bijection
	between "homomorphisms" $\?A\prodstruct \?B \to \?C$
	and "homomorphisms" $\?A \to \powstruct{\?C}{\?B}$.
\end{proposition}

\begin{proof}
Let $\+R$ be a predicate of arity $k$, and let
$\langle a_1,\hdots,a_k \rangle \in \+R(\?A)$.
We want to show that $\langle F(a_1),\hdots,F(a_k) \rangle \in \+R(\powstruct{\?C}{\?B})$:
for any $\langle b_1,\hdots,b_k \rangle \in \+R(\?B)$, we have
\[\langle F(a_1)(b_1), \hdots, F(a_k)(b_k)\rangle = \langle f(a_1,b_1),\hdots,f(a_k,b_k) \rangle \in \+R(\?C)\] since $f$ is a "homomorphism" from $\?A\prodstruct \?B$ to $\?C$.
Hence, $F$ is indeed a "homomorphism" from $\?A$ to $\powstruct{\?C}{\?B}$.

Dually, if $F$ is a "homomorphism" from $\?A$ to $\powstruct{\?C}{\?B}$,
we define $f\colon \?A\prodstruct \?B \to \?C$ by $\langle a,b \rangle \mapsto F(a)(b)$,
and claim that $f$ is a "homomorphism". Indeed, if $\+R$ be a predicate of arity $k$,
for any $\langle a_1, \hdots, a_k \rangle \in \+R(\?A)$
and $\langle b_1, \hdots, b_k \rangle \in \+R(\?B)$,
we have $\langle f(a_1,b_1), \hdots, f(a_k,b_k) \rangle
= \langle F(a_1)(b_1), \hdots, F(a_k)(b_k) \rangle$.
Since $\langle F(a_1), \hdots, F(a_k) \rangle \in \+R(\powstruct{\?C}{\?B})$
and $\langle b_1, \hdots,b_k \rangle \in \+R(\?B)$ 
it follows that $\langle F(a_1)(b_1), \hdots, F(a_k)(b_k) \rangle \in \+R(\?C)$.
Therefore, $f$ is a "homomorphism" from $\?A \prodstruct \?B$ to $\?C$.

It is then routine to check that the maps $f \mapsto F$ and $F \mapsto f$ defined
in the two previous paragraphs are mutually inverse bijections.
\end{proof}

\subsection{Constructions on automatic presentations}
\label{sec:construction-automatic-presentations}

Let $\•A$ and $\•B$ be "automatic presentations" of some "$\sigma$-structures"
$\?A$ and $\?B$, over alphabets $\Sigma$ and $\Gamma$, respectively.
We define \AP$\•A \intro*\prodpres \•B$ to be the "presentation@@auto"
over the alphabet $(\Sigma \times \Gamma) \dcup \Sigma \times \{\pad\} \dcup \{\pad\} \times 
\Gamma$  "st":
\begin{align*}
	\domainPres{\•A\prodpres \•B} & \defeq \{u\convol v \mid u \in \domainPres{\•A} \land v \in \domainPres{\•B}\}\\
	\relPres{\+R}{\•A\prodpres \•B} & \defeq
		\{\tup{u_1\convol v_1,\, \hdots,\, u_k\convol v_k} \mid
		\tup{u_1,\, \hdots,\, u_k} \in \relPres{\+R}{\•A} \land
		\tup{v_1,\, \hdots,\, v_k} \in \relPres{\+R}{\•B}
	\}
\end{align*}
for each "predicate" $\+R$ of arity $k$ in $\sigma$.
It is an "automatic presentation" of $\?A \prodstruct \?B$.
Indeed, given a "first-order formula" $\phi(x_1,\hdots,x_k)$
over $\signatureSynchronous{\Sigma}$, describing $\relPres{\+R}{\•A}$,
and a "first-order formula" $\psi(x_1,\hdots,x_k)$
over $\signatureSynchronous{\Sigma}$, describing $\relPres{\+R}{\•B}$,
we let $\phi^*$ (resp. $\psi^*$) be the "formula@@FO" obtained from $\phi$ (resp. $\psi$)
by substituting $\lastLetter{a}(x)$ for $\bigvee_{b \in \Gamma \dcup \{\pad\}} \lastLetter{\tup{a,b}}(x)$ (resp. $\bigvee_{b \in \Sigma \dcup \{\pad\}} \lastLetter{\tup{b,a}}(x)$).
Then $\phi^* \land \psi^*$ is a "first-order formula", over the product alphabet,
that describes $\relPres{\+R}{\•A\prodpres \•B}$. The same construction
works for $\domainPres{\•A\prodpres \•B}$.

\begin{proposition}
	\label{prop:homreg-prod-finite}
	Let $\?A$, $\?B$ and $\?C$ be "automatic $\sigma$-structures", such that
	$\?B$ and $\?C$ are finite.
	Let $\•A$ (resp. $\•B$ and $\•B'$, resp. $\•C$ and $\•C'$) be an "automatic presentation"
	of $\?A$ (resp. $\?B$, resp. $\?C$).
	Then $\•A \prodpres \•B \homregto \•C$ "iff" $\•A \prodpres \•B' \homregto \•C'$.
\end{proposition}

\begin{proof}
	The proof will follow from the following claim.

	\begin{claim}
		\label{claim:homreg-prod-finite}
		Assuming again that $\?B$ and $\?C$ are finite,
		a function $f\colon\•A \prodpres \•B \to \•C$ is a "regular homomorphism"
		"iff" for every $b\in \domainPres{\•B}$, for every $c\in \domainPres{\•C}$,
		\(\{
			a\in \domainPres{\•A} \mid f(a,b) = c
		\}\)
		is a "regular language".
	\end{claim}
	
	The left-to-right implication is easy, and does not use the assumption that $\?B$ and $\?C$ are if $f\colon\•A \prodpres \•B \to \•C$ is a "regular homomorphism", then there exists
	a first-order formula $\phi(x,y,z)$ "st" for all words $u,v,w$
	in $\domainPres{\•A}$, $\domainPres{\•B}$ and $\domainPres{\•C}$, respectively, then
	\[
		\univStructSynchronous{\Sigma}, u, v, w \models \phi(x,y,z)
		\text{ "iff" }
		w = f(u, v).
	\]
	Then given $b\in \domainPres{\•B}$ and $c\in \domainPres{\•C}$,
	the formula\footnote{``y = b'' is not properly defined in the syntax of "first-order logic" but it is straightforward to come up with a formula expressing this property.}
	\[
		\exists y,\,\exists z,\, \phi(x,y,z) \land y = b \land z = c
	\]
	describes $\{ a\in \domainPres{\•A} \mid f(a,b) = c \}$, which is hence "regular@@lang".

	Conversely, we consider "first-order formulas" $\phi_{b,c}$ describing each set
	$\{ a\in \domainPres{\•A} \mid f(a,b) = c \}$ for $b\in \domainPres{\•B}$ and $c\in \domainPres{\•C}$. Then
	\[
		\phi(x,y,z) \defeq \bigwedge_{b\in \domainPres{\•B}} \bigwedge_{c \in \domainPres{\•C}}
			\phi_{b,c}(x) \land y = b \land z = c
	\]
	is a "first-order formula" (since $\?B$ and $\?C$ are "finite@@struct") describing $f$.
\end{proof}

In other words, the existence of a "regular homomorphism" does not depend on the
"automatic presentation" of the \emph{finite} "structures" that are involved, but only
on the "structure" they represent.
As a consequence of \Cref{prop:homreg-prod-finite}, we write
\(\•A \prodpres \?B \homregto \?C\) as a synonym for \(\•A \prodpres \•B \homregto \•C\).

\begin{corollary}[Currying]
	\label{coro:homreg-currying}
	Let $\?A$, $\?B$ and $\?C$ be "automatic $\sigma$-structures",
	and let $\•A$ be an "automatic presentation" of $\?A$.
	Then $\•A \prodpres \?B \homregto \?C$ "iff" $\•A \homregto \powstruct{\?C}{\?B}$.
\end{corollary}

\begin{proof}
	This also follows from \Cref{claim:homreg-prod-finite}.
\end{proof}

\subsection{Idempotent Core}

We fix a "purely relational signature" $\sigma$.
Given a "$\sigma$-structure" $\?B$,
we denote by \AP$\intro*\extendedSignature{\sigma}{\?B}$
the signature obtained from $\sigma$ by adding
a unary predicate \AP$\intro*\unarypred{b}$ for each $b\in B$.
The \AP""marked structure"" \AP$\intro*\marked{\?B}$ of $\?B$ is the
"$\extendedSignature{\sigma}{\?B}$-structure"
obtained from $\?B$ by "interpreting@@predicate" each predicate $\unarypred{b}$ as the
singleton $\{b\}$.

\begin{proposition}[Folklore]
	\!\sidenote{The non-easy part is to reduce $\HomFinDec{\marked{\?B}}$ to $\HomFinDec{\?B}$: only this reduction
	requires the assumption that $\?B$ is a core. This reduction is folklore, see "eg"
	\cite[Lemma 2.5]{LaroseTesson2009UniversalAlgebraCSP}.
	TODO: understand if the proof is indentical to us. We provide here a self-contained proof.}%
	\sidenote{The "marked structure" $\marked{\core{\?B}}$ of the "core" of $\?B$ is
	usually called the \AP""idempotent core""
	of $\?B$. From this proposition, we get that $\HomFinClass{\?B}$ and
	$\HomFinClass{\marked{\core{\?B}}}$ are "first-order equivalent".
	This reduction is a central tool
	in the algebraic approach to understand "constraint satisfaction
	problem" since the algebra associated to the "CSP" over an "idempotent core"
	only has idempotent operations, making it much easier to work with.}%
	%%%
	\AP\label{prop:idempotent-core-preserves-csp-complexity}
	If $\?B$ is a finite "core", then the problems $\HomAllClass{\marked{\?B}}$ and 
	$\HomAllClass{\?B}$ are "first-order equivalent".
	Moreover, this equivalence preserves "finiteness@@structure".%
	\footnote{And hence, by restricting this equivalence, we obtain that
	$\HomFinClass{\marked{\?B}}$ and $\HomFinClass{\?B}$ are "first-order equivalent".}
\end{proposition}

\begin{proof}[Proof of \Cref{prop:idempotent-core-preserves-csp-complexity}]
	\proofcase{Reduction from $\,\HomAllClass{\?B}$ to $\,\HomAllClass{\marked{\?B}}$.}\\
	We reduce a "$\sigma$-structure" $\?A$ to the
	"$\extendedSignature{\sigma}{\?B}$-structure" $\?A'$ obtained
	from $\?A$ by "interpreting@@predicate" each predicate $\unarypred{b}$ as the empty set.
	Clearly, a function from $A$ to $B$ is a "homomorphism" from $\?A$ to $\?B$
	"iff" it is a "homomorphism" from $\?A'$ to $\marked{\?B}$, proving the correctness
	of the reduction. It is, by definition, "first-order@@reduction".

	\proofcase{Reduction from $\,\HomAllClass{\marked{\?B}}$ to $\,\HomAllClass{\?B}$.}
	We first define the reduction $\Phi$ and show its correctness, we will show later that it
	is a "first-order reduction". We reduce a "$\extendedSignature{\sigma}{\?B}$-structure" $\?A$ to the "$\sigma$-structure"
	$\Phi(\?A)$ defined as follows:
	\begin{itemize}
		\item its underlying universe is the disjoint union $A \dcup B$,
		\item given a "predicate" $\+R$ of arity $k$, its "hyperedges" are:
		\begin{itemize}
		\item all $\+R$-"hyperedges" of $\?A$,
		\item all $\+R$-"hyperedges" of $\?B$, and
		\item all $\+R$-"hyperedges" $\tup{b_1,\hdots,b_{i-1}, a_i, b_{i+1},\hdots,b_k}$
			"st" there exists $b_i$ for which the $\+R$-"hyperedge"
			$\tup{b_1,\hdots,b_{i-1}, b_i, b_{i+1},\hdots,b_k}$
			is in $\+R(\?B)$, and $a_i$ belongs to the "interpretation@@predicate" of 
			$\unarypred{b_i}$ in $\?A$.
		\end{itemize}
	\end{itemize}
	Note that by construction, the "neighbourhood" of $a \in A$ in $\Phi(\?A)$ is
	the union of its "neighbourhood" in $\?A$, and the union of the "neighbourhoods" of
	$b$ in $\?B$ for all $b$ "st" $a \in \unarypred{b}(\?A)$.

	We show that $\?A \in \HomAllClass{\marked{\?B}}$ "iff" $\Phi(\?A) \in \HomAllClass{\?B}$.
	So, assume that there exists a "homomorphism" $f\colon \?A \to \marked{\?B}$.
	Then we let $f'\colon A \dcup B \to B$ be defined by $f'(a) = f(a)$ for all $a\in A$ and
	$f'(b) = b$ for all $b \in B$. We claim that $f'$ is a "homomorphism" from
	$\Phi(\?A)$ to $\?B$. Indeed, consider a "hyperedge" of $\Phi(\?A)$:
	\begin{itemize}
		\item if it is a "hyperedge" of $\?A$, its image by $f'$ is still a "hyperedge"
			of $\?B$ since $f$ is a "homomorphism" from $\?A$ to $\marked{\?B}$;
		\item if it is a "hyperedge" of $\?B$, then its image by $f'$ is itself, and is hence
			a "hyperedge" of $\?B$;
		\item otherwise, it must be of the form 
			\[\tup{b_1,\hdots,b_{i-1}, a_i, b_{i+1},\hdots,b_k}\]
			"st" there exists $b_i$ for which
			$\tup{b_1,\hdots,b_{i-1}, b_i, b_{i+1},\hdots,b_k} \in \+R(\?B)$
			and $a_i \in \unarypred{b_i}(\?A)$:
			in this case, its image by $f'$ is 
			\[f'(\tup{b_1,\hdots,b_{i-1}, a_i, b_{i+1},\hdots,b_k})
			= \tup{b_1,\hdots,b_{i-1}, b_i, b_{i+1},\hdots,b_k} \in \+R(\?B)\]
			since $f'(b) = b$ for all $b\in B$ and $f'(a_i) = f(a_i) = b_i$ since
			$a_i \in \unarypred{b_i}(\?A)$ and $f$ is a "homomorphism" from
			$\?A$ to $\marked{\?B}$.
	\end{itemize}
	And hence, $\Phi(\?A) \homto \?B$.

	Dually, let $g\colon \Phi(\?A) \to \?B$ be a "homomorphism".
	Its restriction to $\?B$, namely $\restr{g}{B}$ is a "homomorphism" from $\?B$
	to itself, and since $\?B$ is a "core", it must be an "automorphism" over $\?B$
	by \Cref{prop:automorphism-core}.
	We then define a map $g' \colon A \to B$ by sending
	$a$ to $(\restr{g}{B})^{-1}\circ g(a)$, and claim that it is a "homomorphism"
	from $\?A$ to $\marked{\?B}$. As a matter of fact, it clearly preserves $\+R$-"hyperedges"
	for any $\+R$ in $\sigma$, since $g$ and $(\restr{g}{B})^{-1}$ are "homomorphisms".
	We must then show that it preserves all unary "predicates" $\unarypred{b}$, with $b\in B$:
	let $a \in A$ "st" $\unarypred{b}$ holds, "ie" $a \in \unarypred{b}(\?A)$.
	Now, by construction of $\Phi(\?A)$, the "neighbourhood" of $g(a)$ in $\?B$
	and the "neighbourhood" of $g(b)$ in $\?B$ are equal.
	Since $\?B$ is a "core", it follows by \Cref{prop:neighbourhood-core} that $g(a) = g(b)$.
	By definition of $g'$, this rewrites as $g'(a) = b$, "ie" $g'(a) = \unarypred{b}(\marked{\?B})$.
	Therefore, we have built a "homomorphism" from $\?A$ to $\marked{\?B}$.

	Overall, this proves that $\Phi$ is correct. It is straightforward to notice that
	it is a "first-order reduction" and that it preserves "finiteness@@structure" since $\?B$
	is "finite@@structure".
\end{proof}

\subsection{Transitive Tournaments "vs" Paths}

\begin{figure}
	\centering
	\begin{tikzpicture}
		\input{tikz/dichotomy/zigzag-graph}
		\input{tikz/dichotomy/zigzag-graph-label}
	\end{tikzpicture}
	\caption{\AP\label{fig:zigzag-graph}The "zigzag graph" $\zigzag{5}{2}$.}
\end{figure}
\begin{example}
	\AP\label{ex:zigzag-defn}
	Let $n\in\?N$.
	We define the \AP""zigzag graph"" $\intro*\zigzag{n}{2}$ of width $n$ and length 2
	to be "graph" whose vertices are $a_0, \hdots, a_n$, $b_0, \hdots, b_{n}$,
	$a'_0$ and $b'_n$, with edges from $a_i$ to $b_{i-1}$ and to $b_{i}$ (for $i \in \lBrack 0,n\rBrack$, whenever the nodes exist), and with an edge from $a'_0$ to $a_0$ and from $b_n$
	to $b'_n$. See \Cref{fig:zigzag-graph} for an illustration.
	
	Note that $\zigzag{n}{2}$ does not admit a "homomorphism" to the "$2$-path"---indeed, such a homomorphism should send $a'_0$, $a_0$ and $b_0$ onto $0$, $1$, and $2$, respectively, 
	and so all $a_i$'s (resp. $b_i$'s) must be sent onto $1$ (resp. $2$), but then $b'_n$ cannot be mapped anywhere.

	On the other hand, $\zigzag{n}{2}$ admits a "homomorphism" to the "$2$-transitive tournament", as witnessed by \Cref{fig:zigzag-graph-hom-T2}.
	In fact, this "homomorphism" is far from being unique:
	each vertex $a_1,\,a_2,\,\hdots,\,a_{n-1}$ can be sent on either $0$ or $1$
	(the red and yellow vertices), 
	and similarly, each vertex $b_1,\,b_2,\,\hdots,\,b_{n-1}$ can be sent on either $1$ or $2$
	(the yellow and blue vertices).\footnote{Note that it is straightforward
	to extend these results---namely $\zigzag{n}{2} \homto \transitiveTournament{2}$
	and $\zigzag{n}{2} \nothomto \pathGraph{2}$---to arbitrary values of $k\in \N$ with
	$k\geq 2$, namely $\zigzag{n}{k} \homto \transitiveTournament{k}$
	and $\zigzag{n}{k} \nothomto \pathGraph{k}$, by letting
	$\zigzag{n}{k}$ be the graph obtained from $\zigzag{n}{2}$ by
	replacing the path leading to $a_0$ by a path of length $k-1$.
	}
\end{example}
\begin{figure}
	\centering 
	\begin{tikzpicture}
		\input{tikz/dichotomy/zigzag-graph-hom-T2}
	\end{tikzpicture}
	\caption{\AP\label{fig:zigzag-graph-hom-T2}A "homomorphism" from the "zigzag graph" (left-hand side) to the "$2$-transitive tournament" (right-hand side).}
\end{figure}