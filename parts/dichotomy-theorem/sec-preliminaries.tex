\section{\AP\label{sec:dichotomy-preliminaries}%
	Preliminaries}

For \AP""first-order reductions"", see
\cite[Definition 2.11 \& Definition 1.26]{Immerman1998DescriptiveComplexity}.

\subsection{A Model-Theoretic Perspective}

Given an alphabet $\Sigma$, we define on $\Sigma^*$:
\begin{itemize}
	\itemAP a predicate $\intro*\lastLetter{a}$ indicating that the last letter of a word is $a$,
	\itemAP a binary relation $\intro*\equalLength$ indicating that two words have the same length,
	\itemAP a binary relation $\intro*\prefix$ indicating that a word is a prefix of another.
\end{itemize} 
We denote by $\intro*\signatureSynchronous{\Sigma}$ the "signature" $\langle \langle\lastLetter{a}\rangle_{a \in \Sigma},\, \equalLength,\, \prefix \rangle$\footnote{We abusively use the same notations for
the "predicates" and their "interpretations@@predicate" in the "signature".} and
by \AP$\intro*\univStructSynchronous{\Sigma}$ the "$\signatureSynchronous{\Sigma}$-structure" over $\Sigma^*$ where
the "predicates" are "interpreted@@predicate" as above.

\begin{proposition}
	\label{prop:synchronous-first-order}
	A relation over $\Sigma^*$ is "synchronous" "iff" it is definable by a "first-order formula" over \(\univStructSynchronous{\Sigma}\).
\end{proposition}

\subsection{Undirected Paths}

An \AP""undirected path"" in a "$\sigma$-structure" $\?A$ consists of a sequence
\[\big\langle a_0,\, e_0,\, a_1,\, \hdots,\, e_{n-1},\, a_n\big\rangle, \text{ with } n \in \N,\]
where $a_i \in \?A$ and each $e_i$ is a "hyperedge" of $\?A$ "st" both
$a_i$ and $a_{i+1}$ occur in $e_i$. When such an "undirected path" exists, we say that
there is an "undirected path" between $a_0$ and $a_n$, or equivalently
that $a_0$ and $a_n$ are \AP""connected"".\sidenote{Note that this relation is reflexive
and symmetric.} A \AP"connected component" of $\?A$ consists of an equivalence class of the 
transitive closure of this relation.

\subsection{Constructions on Structures}

Given two "structures" $\?A$ and $\?B$, we define the structure \AP$\intro*\powstruct{\?B}{\?A}$ as follows:
\begin{itemize}
  \item its domain are "homomorphisms" $\?A \to \?B$,
  \item for every "predicate" $\+R$ of arity $k$, for any homomorphism $f_1,\hdots,f_k$,
  we have $\langle f_1,\hdots,f_k\rangle \in \+R$ when for every
  $\langle a_1,\hdots,a_k\rangle \in \+R(\?A)$
  then $\langle f_1(a_1), \hdots, f_k(a_k) \rangle \in \+R(\?B)$.
\end{itemize}


\begin{proposition}[Folklore: Currying Homomorphisms]
	\AP\label{prop:currying-hom}
	Given "structures" $\?A$, $\?B$ and $\?C$, if $f\colon \?A\prodstruct \?B \to \?C$
	is a "homomorphism", then $F\colon \?A \to \powstruct{\?C}{\?B}$,
	defined by $a \mapsto (b \mapsto f(a,b))$, is a "homomorphism".
	In fact, this mapping $f \mapsto F$ is a bijection
	between "homomorphisms" $\?A\prodstruct \?B \to \?C$
	and "homomorphisms" $\?A \to \powstruct{\?C}{\?B}$.
\end{proposition}

\begin{proof}
Let $\+R$ be a predicate of arity $k$, and let
$\langle a_1,\hdots,a_k \rangle \in \+R(\?A)$.
We want to show that $\langle F(a_1),\hdots,F(a_k) \rangle \in \+R(\powstruct{\?C}{\?B})$:
for any $\langle b_1,\hdots,b_k \rangle \in \+R(\?B)$, we have
\[\langle F(a_1)(b_1), \hdots, F(a_k)(b_k)\rangle = \langle f(a_1,b_1),\hdots,f(a_k,b_k) \rangle \in \+R(\?C)\] since $f$ is a "homomorphism" from $\?A\prodstruct \?B$ to $\?C$.
Hence, $F$ is indeed a "homomorphism" from $\?A$ to $\powstruct{\?C}{\?B}$.

Dually, if $F$ is a "homomorphism" from $\?A$ to $\powstruct{\?C}{\?B}$,
we define $f\colon \?A\prodstruct \?B \to \?C$ by $\langle a,b \rangle \mapsto F(a)(b)$,
and claim that $f$ is a "homomorphism". Indeed, if $\+R$ be a predicate of arity $k$,
for any $\langle a_1, \hdots, a_k \rangle \in \+R(\?A)$
and $\langle b_1, \hdots, b_k \rangle \in \+R(\?B)$,
we have $\langle f(a_1,b_1), \hdots, f(a_k,b_k) \rangle
= \langle F(a_1)(b_1), \hdots, F(a_k)(b_k) \rangle$.
Since $\langle F(a_1), \hdots, F(a_k) \rangle \in \+R(\powstruct{\?C}{\?B})$
and $\langle b_1, \hdots,b_k \rangle \in \+R(\?B)$ 
it follows that $\langle F(a_1)(b_1), \hdots, F(a_k)(b_k) \rangle \in \+R(\?C)$.
Therefore, $f$ is a "homomorphism" from $\?A \prodstruct \?B$ to $\?C$.

It is then routine to check that the maps $f \mapsto F$ and $F \mapsto f$ defined
in the two previous paragraphs are mutually inverse bijections.
\end{proof}

\subsection{Constructions on Automatic Presentations}
\label{sec:construction-automatic-presentations}

Let $\•A$ and $\•B$ be "automatic presentations" of some "$\sigma$-structures"
$\?A$ and $\?B$. We define \AP$\•A \intro*\prodpres \•B$ to be the "presentation@@auto"
"st":
\begin{align*}
	\domainPres{\•A\prodpres \•B} & \defeq \{u\#v \mid u \in \domainPres{\•A} \land v \in \domainPres{\•B}\}\\
	\relPres{\•A\prodpres \•B}{\+R} & \defeq \{(u_1\#v_1) \convol \cdots \convol (u_k\#v_k) \mid
		u_1 \convol \cdots \convol u_k \in \relPres{\•A}{\+R} \land
		v_1 \convol \cdots \convol v_k \in \relPres{\•B}{\+R}
	\}
\end{align*}
for each "predicate" $\+R$ of arity $k$ in $\sigma$.
It is an "automatic presentation" of $\?A \prodstruct \?B$. TODO:proof.

\begin{proposition}
	\label{prop:homreg-prod-finite}
	Let $\?A$, $\?B$ and $\?C$ be "automatic $\sigma$-structures", such that
	$\?B$ and $\?C$ are finite.
	Let $\•A$ (resp. $\•B$ and $\•B'$, resp. $\•C$ and $\•C'$) be an "automatic presentation"
	of $\?A$ (resp. $\?B$, resp. $\?C$).
	Then $\•A \prodpres \•B \homregto \•C$ "iff" $\•A \prodpres \•B' \homregto \•C'$.
\end{proposition}

\begin{proof}
	The proof will follow from the following claim.
	\begin{claim}
		\label{claim:homreg-prod-finite}
		A function $f\colon\•A \prodpres \•B \homregto \•C$ is a "regular homomorphism"
		"iff" for every $b\in \domainPres{\•B}$, for every $c\in \domainPres{\•C}$,
		\(\{
			a\in \domainPres{\•A} \mid f(a,b) = c
		\}\)
		is a "regular language".
	\end{claim}
	TODO.
\end{proof}

In other words, the existence of a "regular homomorphism" does not depend on the
"automatic presentation" of the \emph{finite} "structures" that are involved, but only
on the "structure" they represent.
As a consequence of \Cref{prop:homreg-prod-finite}, we write
\(\•A \prodpres \?B \homregto \?C\) as a synonym for \(\•A \prodpres \•B \homregto \•C\).

\begin{corollary}[Currying]
	\label{coro:homreg-currying}
	Let $\?A$, $\?B$ and $\?C$ be "automatic $\sigma$-structures",
	and let $\•A$ be an "automatic presentation" of $\?A$.
	Then $\•A \prodpres \?B \homregto \?C$ "iff" $\•A \homregto \powstruct{\?C}{\?B}$.
\end{corollary}

\begin{proof}
	By \Cref{claim:homreg-prod-finite}… TODO.
\end{proof}

\subsection{Neighbourhoods}

Given a "$\sigma$-structure" $\?A$ and $a \in A$, we define the \AP""neighbourhood"" of $a$
in $\?A$
to be the tuple of sets
\[
	\intro*\neighbourhood{a}{\?A}{\+R}{i} \defeq
	% \Big\langle
		\big\{
			\langle a_1, \hdots, a_{i-1}, a_{i+1}, \hdots, a_k \rangle \in A^{k-1} \mid
			\langle a_1, \hdots, a_{i-1}, a, a_{i+1}, \hdots, a_k \rangle \in \+R(\?A)
		\big\},
		% \;\big\vert\;
		% \+R_{(k)} \in \sigma \text{ and } i \in \lBrack 1,k\rBrack
	% \Big\rangle.
\]
when $\+R$ ranges over "predicate" of arity $k$ of $\sigma$ and $i \in \lBrack 1,k\rBrack$. 
\marginnote{TODO: introduce notation $\+R_{(k)} \in \sigma$}
For "graphs", the "neighbourhood" of a vertex corresponds to its set of predecessors and
its set of successors.

\subsection{Idempotent Core}

We fix a "purely relational signature" $\sigma$.
Given a "$\sigma$-structure" $\?B$,
we denote by \AP$\intro*\extendedSignature{\sigma}{\?B}$
the signature obtained from $\sigma$ by adding
a unary predicate \AP$\intro*\unarypred{b}$ for each $b\in B$.
The "marked structure" \AP$\intro*\marked{\?B}$ of $\?B$ is the
"$\extendedSignature{\sigma}{\?B}$-structure"
obtained from $\?B$ by "interpreting@@predicate" each predicate $\unarypred{b}$ as the
singleton $\{b\}$.\sidenote{TODO: ASIA'S REMARK: this is called the ``idempotent core''.}

\begin{proposition}[Folklore]
\!\sidenote{The non-easy part is to reduce $\HomFinDec{\marked{\?B}}$ to $\HomFinDec{\?B}$: only this reduction
requires the assumption that $\?B$ is a core. This reduction is folklore, see "eg"
\cite[Lemma 2.5]{LaroseTesson2009UniversalAlgebraCSP}.
TODO: understand if the proof is indentical to us. We provide here a self-contained proof.}%
\sidenote{The "marked structure" $\marked{\core{\?B}}$ of the "core" of $\?B$ is
usually called the \AP""idempotent core""
of $\?B$. By TODO:addref and this proposition, $\HomFinDec{\?B}$ and
$\HomFinDec{\marked{\core{\?B}}}$ are equivalent under "first-order reductions".
This reduction is a central tool
in the algebraic approach to understand "constraint satisfaction
problem" since the algebra associated to the "CSP" over an "idempotent core"
only has idempotent operations, making it much easier to work with. See TODO:addref for
more details.}%
\AP\label{prop:marking-preserves-csp-complexity}
If $\?B$ is a finite "core", then the problems $\HomFinDec{\marked{\?B}}$ and 
$\HomFinDec{\?B}$ are equivalent under "first-order reductions".
\end{proposition}

\begin{proof}[Proof of \Cref{prop:marking-preserves-csp-complexity}]
\proofcase{Reduction from $\HomFinDec{\?B}$ to $\HomFinDec{\marked{\?B}}$.}
We reduce a "$\sigma$-structure" $\?A$ to the
"$\extendedSignature{\sigma}{\?B}$-structure" $\?A'$ obtained
from $\?A$ by "interpreting@@predicate" each predicate $\unarypred{b}$ as the emptyset.
Clearly, a function from $A$ to $B$ is a "homomorphism" from $\?A$ to $\?B$
"iff" it is a "homomorphism" from $\?A'$ to $\marked{\?B}$, proving the correctness
of the reduction. It is, by definition, "first-order@@reduction".

\proofcase{Reduction from $\HomFinDec{\marked{\?B}}$ to $\HomFinDec{\?B}$.}
We first define the reduction $\Phi$ and show its correctness, we will show later that it
is a "first-order reduction". We reduce a "$\extendedSignature{\sigma}{\?B}$-structure" $\?A$ to the "$\sigma$-structure"
$\Phi(\?A)$ defined as follows:
\begin{itemize}
	\item its underlying universe is the disjoint union $A \sqcup B$,
	\item given a "predicate" $\+R$ of arity $k$, its "hyperedges" are:
	\begin{itemize}
	\item all $\+R$-"hyperedges" of $A$,
	\item all $\+R$-"hyperedges" of $B$, and
	\item all $\+R$-"hyperedges" $(b_1,\hdots,b_{i-1}, a_i, b_{i+1},\hdots,b_k)$
		"st" there exists $b_i$ for which the $\+R$-"hyperedge"
		$(b_1,\hdots,b_{i-1}, b_i, b_{i+1},\hdots,b_k)$
		is in $\+R(\?A)$, and $a_i$ belongs to the "interpretation@@predicate" of 
		$\unarypred{b_i}$ in $\?A$.
	\end{itemize}
\end{itemize}
Note that by construction, the "neighbourhood" of $a \in A$ in $\Phi(\?A)$ is
the union of its "neighbourhood" in $\?A$, and the union of the "neighbourhoods" of
$b$ in $\?B$ for all $b$ "st" $a \in \unarypred{b}(\?A)$.
TODO: To be concluded.  
\end{proof}

\subsection{De Bruijn–Erdős Theorem}

\begin{proposition}[""De Bruijn–Erdős Theorem""]
	\!\footnote{It is straightforward to note that
	one can replace ``every finite "substructure"'' by
	``every finite "induced substructure"'' in the statement of the theorem.}%
	\AP\label{prop:de-bruijn-erdos}
	Let $\?A$ be an arbitrary "$\sigma$-structure" and $\?B$ a "finite $\sigma$-structure".
	There is a "homomorphism" from $\?A$ to $\?B$ "iff" for every finite "substructure" $\?A'$
	of $\?A$, there is a "homomorphism" from $\?A$ to $\?B$.
\end{proposition}

\begin{proof}
	The left-to-right implication is direct.
	We prove the converse by using the "Tychonoff's compactness theorem".\footnote{This is a direct adaptation from todo:addref-wiki, which proves this result in the particular case of graph colouring.}
	So, assume that for every finite "substructure" $\?A'$ of $\?A$,
	there is a "homomorphism" from $\?A$ to $\?B$. 
	Consider the topological space $B^A$, consisting of all functions from $A$ to $B$,
	together with the product topology.\footnote{We equip $B$ with the discrete topology,
	making it compact since $B$ is finite.} By "Tychonoff's compactness theorem",
	$B^A$ is compact. For each finite subset $X$ of $A$, let
	$H_X$ denote the set of all $f \in B^A$ "st" $\restr{f}{X}$ is a "homomorphism"
	from the "substructure" of $\?A$ "induced@@structure" by $X$ to $\?B$.
	Then, each $H_X$ is closed---indeed, whether $f\in B^A$ belongs to $H_X$ only depends
	on finitely many $f(x)$'s---, and moreover the intersection of finitely many
	$H_X$'s, say $H_{X_1} \cap \cdots \cap H_{X_n}$, is non-empty since
	$H_{X_1} \cap \cdots \cap H_{X_n} \supseteq H_{X_1\cup \hdots \cup X_n}$
	and by assumption $H_{X_1\cup \hdots \cup X_n}$ is non-empty since $X_1 \cup \cdots \cup X_n$ is finite. Hence, by compactness of $B^A$ and the "finite intersection property", it follows
	that $\bigcap_X H_X$ is non-empty, which means that there is a "homomorphism" from $\?A$ to $\?B$.
\end{proof}

\begin{corollary}
	\!\footnote{Another important consequence of the "De Bruijn–Erdős Theorem" is that,
	for instance, the notion of "dual" does not depend on whether we are considering finite or
	arbitrary "$\sigma$-structures".}
	\AP\label{coro:de-bruijn-erdos}
	Given arbitrary $\sigma$-structures $\?B_1$ and $\?B_2$, the following are equivalent:
	\begin{enumerate}
		\itemAP\label{item:de-bruijn-erdos-finite} for every finite "$\sigma$-structure" $\?A$, then $\?A \homto \?B_1$
		"iff" $\?A \homto \?B_2$;
		\itemAP\label{item:de-bruijn-erdos-arbitrary} for every arbitrary "$\sigma$-structure" $\?A$, then $\?A \homto \?B_1$
			"iff" $\?A \homto \?B_2$;
		\itemAP\label{item:de-bruijn-erdos-hom} $\?B_1$ and $\?B_2$ are "homomorphically equivalent".
	\end{enumerate}
\end{corollary}
\begin{proof}
	\eqref{item:de-bruijn-erdos-arbitrary} $\Rightarrow$ \eqref{item:de-bruijn-erdos-hom}
	and \eqref{item:de-bruijn-erdos-hom} $\Rightarrow$ \eqref{item:de-bruijn-erdos-finite}
	are trivial.
	For \eqref{item:de-bruijn-erdos-finite} $\Rightarrow$ \eqref{item:de-bruijn-erdos-arbitrary},
	we assume "wlog" by contradiction that there is an arbitrary "$\sigma$-structure" $\?A$ "st" $\?A \homto \?B_1$ but $\?A \nothomto \?B_2$. Then by \Cref{prop:de-bruijn-erdos},
	there exists a finite "substructure" $\?A_0$ of $\?A$ "st" $\?A_0 \nothomto \?B_2$.
	But then $\?A_0 \homto \?A \homto \?B_1$, which contradicts \eqref{item:de-bruijn-erdos-finite}.
\end{proof}

\subsection{Transitive Tournaments "vs" Paths}

\begin{figure}
	\centering
	\begin{tikzpicture}
		\input{tikz/zigzag-graph}
		\input{tikz/zigzag-graph-label}
	\end{tikzpicture}
	\caption{\AP\label{fig:zigzag-graph}The "zigzag graph" $\zigzag{5}{2}$.}
\end{figure}
\begin{example}
	\AP\label{ex:zigzag-defn}
	Let $n\in\?N$.
	We define the \AP""zigzag graph"" $\intro*\zigzag{n}{2}$ of width $n$ and length 2
	to be "graph" whose vertices are $a_0, \hdots, a_n$, $b_0, \hdots, b_{n}$,
	$a'_0$ and $b'_n$, with edges from $a_i$ to $b_{i-1}$ and to $b_{i}$ (for $i \in \lBrack 0,n\rBrack$, whenever the nodes exist), and with an edge from $a'_0$ to $a_0$ and from $b_n$
	to $b'_n$. See \Cref{fig:zigzag-graph} for an illustration.
	
	Note that $\zigzag{n}{2}$ does not admit a "homomorphism" to the "$2$-path"---indeed, such a homomorphism should send $a'_0$, $a_0$ and $b_0$ onto $0$, $1$, and $2$, respectively, 
	and so all $a_i$'s (resp. $b_i$'s) must be sent onto $1$ (resp. $2$), but then $b'_n$ cannot be mapped anywhere.

	On the other hand, $\zigzag{n}{2}$ admits a "homomorphism" to the "$2$-transitive tournament", as witnessed by \Cref{fig:zigzag-graph-hom-T2}.
	In fact, this "homomorphism" is far from being unique:
	each vertex $a_1,\,a_2,\,\hdots,\,a_{n-1}$ can be sent on either $0$ or $1$
	(the red and purple vertices), 
	and similarly, each vertex $b_1,\,b_2,\,\hdots,\,b_{n-1}$ can be sent on either $1$ or $2$
	(the purple and blue vertices).\footnote{Note that it is straightforward
	to extend these results---namely $\zigzag{n}{2} \homto \transitiveTournament{2}$
	and $\zigzag{n}{2} \nothomto \pathGraph{2}$---to arbitrary values of $k\in \N$ with
	$k\geq 2$, namely $\zigzag{n}{k} \homto \transitiveTournament{k}$
	and $\zigzag{n}{k} \nothomto \pathGraph{k}$, by letting
	$\zigzag{n}{k}$ be the graph obtained from $\zigzag{n}{2}$ by
	replacing the path leading to $a_0$ by a path of length $k-1$.
	}
\end{example}
\begin{figure}
	\centering 
	\begin{tikzpicture}
		\input{tikz/zigzag-graph-hom-T2}
	\end{tikzpicture}
	\caption{\AP\label{fig:zigzag-graph-hom-T2}A "homomorphism" from the "zigzag graph" (left-hand side) to the "$2$-transitive tournament" (right-hand side).}
\end{figure}