\subsection{$k$-Regular Colourability Problem}

While we do not know how to approach the "regular colourability problem", we show that as soon as we add the restriction that the number of colours is bounded, the problem becomes undecidable;
"ie", the "$k$-regular colourability problem" is undecidable for $k\geq 2$. Using this, we obtain in the next section 
the undecidability for the separability problem on two natural classes of 
"recognizable relations". This is proven by a reduction from a suitable problem on reversible 
Turing Machines with certain restrictions, which we call ``well-founded''.

\paragraph*{Regularity of Reachability for Turing Machines.}
We use the standard notation $u[i..j]$ to denote the factor of a word $u$ between (and including) positions $i$ and $j$, and $u[i]$ to denote $u[i..i]$.
%\sidediego{Should this go the preliminaries?}
Consider any deterministic Turing Machine (TM) $T = \tup{Q,\Gamma,\bot,\delta,q_0,F}$, where $Q$ is the set of states, $\Gamma$ is tape alphabet, $\bot$ is the blank symbol, $\delta: (Q \setminus F) \times \Gamma_\bot \to Q \times \Gamma \times \set{L,R}$ is the transition (partial) function, where $\Gamma_\bot = \Gamma \cup \set\bot$, and $q_0$ and $F$ is the initial and set of final states, respectively.
%
We represent a configuration with tape content $w \cdot \bot^\omega$ (where $w \in \Gamma^* \cdot \set{\bot}$), in state $q$ and with the head pointing to the cell number $1 \leq i \leq |w|$, as the string
\[
   w[1..i-1] \cdot (w[i],q) \cdot w[i+1..|w|] 
\]
over the alphabet $\Sigma_T = \Gamma \cup (\Gamma_\bot \times Q)$.
\AP In light of this representation, we will henceforth denote by ``configuration'' any string from the set  $\intro*\configs \defeq (\Gamma^* \cdot (\Gamma_\bot \times Q)) \cup  (\Gamma^* \cdot (\Gamma \times Q) \cdot \Gamma^*)$. The ""initial configuration"" is $(\bot,q_0)$.
\AP The ""configuration graph"" of $T$ is the infinite graph $\intro*\confGraph$ having $\configs$ as set of vertices and an edge from $c$ to $c'$, denoted $c \rightarrow c'$, if $c'$ is the configuration of the next step of $T$ starting from $c$. Observe that the "configuration graph" $\confGraph$ of any TM $T$ is an effective "synchronous graph" (see, e.g., \cite{KuskeLohrey2010AutomaticGraphs}).

\AP We say that a deterministic TM $T$ is ""reversible"" if every node of $\confGraph$ has in-degree at most 1, in other words if the machine is co-deterministic\footnote{Note
that a modern proof of undecidability of the isomorphism problem for automatic structures by
Blumensath \cite[\S VIII. Theorem 4.3, p. 396 \& second claim, p. 398]{Blumensath2023MSO} also relies on the use of "reversible" Turing machines.}.
We say that a TM $T$ is a ""well-founded Reversible Turing Machine"" (\reintro{wf-RTM}) if its "configuration graph" is such that (1) the "initial configuration" has in-degree 0 (2) every node has in-degree and out-degree at most one (3) there are no infinite backward paths $c_1 \leftarrow c_2 \leftarrow \dotsb$ in $\confGraph$. 

\AP Note that every "well-founded Reversible Turing Machine" is deterministic and "reversible" and, moreover,
its "configuration graph" is a (possibly infinite) disjoint union of
directed paths, which are all finite, or isomorphic to $(\mathbb{N}, +1)$.
The set of ""reachable configurations"", denoted by $\intro*\Reach$, is 
the set of all configurations that admit a path from the "initial configuration"
% the set of all "configurations" in the connected component of the "initial configuration" 
in $\confGraph$, for a given TM $T$.
Such a configuration graph is depicted on \Cref{subfig:config-graph-wf-RTM}.

\AP The ""reachable regularity problem"" is the problem of, given a "wf-RTM" $T$, whether its set of "reachable configurations" is a regular language. To show that is it undecidable, we exhibit a reduction from the halting problem on deterministic "reversible" Turing machines.

\begin{proposition}[{\cite[Theorem 1]{Lecerf1963MachinesReversibles}}]
    \AP\label{prop:halting-problem-detrevTM}
    The halting problem on deterministic "reversible" Turing machines is undecidable.
\end{proposition}

For more details and pointers on "reversible" Turing machines, see \cite[Chapter 5]{Morita2017Reversible}.

\begin{lemma}
    \AP\label{lem:reachable-regularity}
    The "reachable regularity problem" is undecidable.
\end{lemma}

\begin{proof}[Proof sketch]
    By reducing the halting problem on deterministic "reversible" Turing machines,
    in such a way that the "reachable configurations" whose
    state $q$ coincide with the state of the original machine are
    of the form $(u q v a^n b^n)$ where $(u q v)$ is a configuration of the original machine,
    $a$ and $b$ are new symbols,
    and $n\in\N$. Transitions are defined in such a way that the new machine is a
    "wf-RTM": this is implemented by having, for every transition $uqv \to u'q'v'$ of the original machine and every $n\in \N$, a (multi-step) transition $(u q v a^n b^n) \to^* (u' q' v' a^{n+1} b^{n+1})$---and is illustrated in \Cref{fig:reachable-regularity}.
	\begin{figure}[htb]
		\centering
        \begin{tikzpicture}
		    \input{tikz/dichotomy/reachable-regularity}
        \end{tikzpicture}
		\caption{
			\AP\label{fig:reachable-regularity}
			Encoding of a single transition of the form
			``when reading a blank in state $\color{cBlue} p$, write a
			$1$, go in state $\color{cBlue} q$ and move right''
			of the machine $T$ in the machine $T'$
			in the proof of \Cref{lem:reachable-regularity}.
			Red unlabelled states represent states of $T'$
			that are not originally present in $T$.
		}
	\end{figure}
	Moreover:
    \begin{itemize}
        \item if the original machine was halting, then the "reachable configurations"
            of the new one are finite and hence regular;
        \item otherwise, the set of "reachable configurations" is not regular,
            which follows from the non-regularity of any infinite subset of $\{a^n b^n \mid n \in \N\}$.
    \end{itemize}
\end{proof}

\begin{proof}
    By reduction from the halting problem for deterministic and "reversible" TMs, which is undecidable by \Cref{prop:halting-problem-detrevTM}. Given a deterministic and "reversible" TM $T$ (running on the empty input), consider the TM $T'$ where every time there is a transition $(u, p, v) \to (u', q, v')$ from configuration $c$ to configuration $c'$ in $T$,
	simulate this transition in $T'$---$a$'s should be treated as blank symbols---,
	and then rewrite $a^n b^n$ into $a^{n+1}b^{n+1}$.
	When $T$ writes on a blank symbol that was actually a $a$ in $T'$,
	we must also add an extra $a$ (to account for the one that was overwritten):
	this case is depicted \Cref{fig:reachable-regularity}.
	Moreover, when $T$ deletes a symbol at the end of the tape,
	we must shift the $a^n b^n$ prefix. This can be done by replacing the blank
	with an $a$, the last $a$ with a $b$, and deleting the last $b$.
	
	% in \Cref{fig:reachable-regularity}, by a series of steps that ``make some room'' between $c$ and $c'$ if needed (for example because the head was at the last position of $c$ and moves to the right), and make some room between the $a$'s and the $b$'s to accomodate for the extra $a$, and writes an extra $b$ at the end. This can be done with the invariant that at all times there are roughly as many $a$'s as $b$'s ($\pm 1$) in the working tape.
    Observe that $T'$ is a "wf-RTM":
    \begin{enumerate}
        \item the "initial configuration" $(\bot,q_0,\bot)$ has no predecessor;
        \item it is deterministic and co-deterministic:
        \begin{itemize}
            \item every configuration inside a path $(u, q, v a^n b^n) \xrightarrow{*} (u, q, v a^{n+1} b^{n+1})$ 
            has, by definition, exactly in- and out-degree one;
            \item every configuration of the form $(u, p, v a^n b^n)$ has as many predecessors 
            [resp. successors] in $T'$ as $(u,q,v)$ in $T$, namely one since $T$ was assumed to be
                deterministic and "reversible";
        \end{itemize}
        \item it has no infinite descending chain since $\N$ is well-founded.
    \end{enumerate}
    Moreover, $T'$ has no cycle,
    so if $T$ is halting (on an empty input) then the set of "reachable configurations" of $T'$ is finite (since it is a "wf-RTM") and thus regular. If $T$ is not halting, the set of "reachable configurations" of $T'$ is infinite and its projection onto $\set{a,b}$ is an infinite set of words of the form $a^{n} b^{n'}$ where $n-2 \leq n' \leq n+2$. Hence, since regular languages are closed under homomorphic images, the "reachable configurations" of $T'$ cannot be regular.
\end{proof}


\paragraph*{Undecidability of the $k$-Regular Colourability Problem.}
We can now show undecidability for the "$k$-regular colourability problem" by reduction from the "reachable regularity problem" as defined before.

\begin{fact}
    \AP\label{fact:initial-nodes-are-regular}
    Given an "synchronous graph", the set of nodes with no predecessor is effectively a regular language. 
\end{fact}

\begin{theorem}
    \AP\label{thm:k-reg-col-undec}
    The "$k$-regular colourability problem" on "synchronous graphs" is undecidable, for every $k\geq 2$. More precisely, the problem is recursively enumerable-complete. This holds also for connected "synchronous graphs".
\end{theorem}

\begin{proof}%
    \begin{marginfigure}%
        \centering
        \begin{tikzpicture}
            \input{tikz/dichotomy/conf-graph-wf-RTM}
        \end{tikzpicture}
        \caption{
            \AP\label{fig:reduction-wf-RTM-to-colouring-config-graph-wf-RTM}
            Configuration graph of a "well-founded Reversible Turing Machine".
        }
    \end{marginfigure}%
    \begin{marginfigure}
        \centering
        \begin{tikzpicture}
            \input{tikz/dichotomy/reduction-wf-RTM}
        \end{tikzpicture}
        \caption{
            \AP\label{subfig:reduction-wf-RTM-to-colouring}
            The synchronous graph to which the "configuration graph"
            of \Cref{fig:reduction-wf-RTM-to-colouring-config-graph-wf-RTM} is reduced.
        }
    \end{marginfigure}%
	\proofcase{Lower bound.}
    By reduction from the "reachable regularity problem" for "wf-RTM"s
    (\Cref{lem:reachable-regularity}). We first show it for $k=2$.
    \AP Given a "wf-RTM" $T$, let $c_{\textit{init}}$ be its "initial configuration".
    Observe that the set $\intro*\Init$ of all vertices of $\confGraph$ with in-degree $0$ is an effective regular language (by \Cref{fact:initial-nodes-are-regular}), and that $c_{\textit{init}} \in \Init$. Let $B$ and $R$ be fresh symbols. 
    Consider the "synchronous graph" $\AutGraph{L}{E}$ for $L = \set{B,R} \times \configs$, having 
    an edge from $(z,c) \in \{B,R\} \times \configs$ to $(z',c') \in \{B,R\} \times \configs$ if either 
    \begin{enumerate}
        \item $(z,z') = (B,R)$ and $c=c'$;
        \item $(z,z') = (R,B)$ and there is an edge from $c$ to $c'$ in $\confGraph$; or
        \item $(z,z') = (B,B)$, $c = c_{\textit{init}}$ and $c' \in \Init \setminus \set{c_{\textit{init}}}$.
    \end{enumerate}
Fresh symbols $B$ and $R$ are utilized to represent two versions of each configuration - one in Blue and one in Red. This graph is depicted
    on \Cref{fig:reduction-wf-RTM-to-colouring}.
    Note that $\AutGraph{L}{E}$ is connected and "2-colourable": in fact, it is a directed (possibly infinite) tree with root $(B,c_{\textit{init}})$. 
    
    We claim that $\AutGraph{L}{E}$ is "$2$-regular colourable" if, and only if, the set of "reachable configurations" of $T$ is a regular language. 
    In fact, up to permuting the two-colours, 
  $\AutGraph{L}{E}$ admits a unique 2-colouring, defined by:
    \[
        C_1 ~~ \defeq ~~ \{B\} \times \Reach ~~\cup~~ \{R\} \times (\configs \setminus \Reach)
    \]
    and $C_2$ is the complement of $C_1$.
    If $\Reach$ is regular, then so is $C_1$. Dually, if $C_1$ is regular, then
    $\Reach$ is the set of configurations $c$ such that $(B,c) \in C_1$ and hence is regular.
    It follows that $\AutGraph{\Sigma^*}{E}$ is "$2$-regular colourable" if and only if
    the "reachable configurations" of $T$ are regular, which concludes the proof for $k=2$.

    % In one direction, if the "reachable configurations" of $T$ is a regular language $L$, then consider the regular sets of vertices of $G$ defined as $C_1 = (\set B \times L) \cup (\set R \times (\configs \setminus L))$ and $C_2$ as its complement. It is easy to verify that $(C_1,C_2)$ is a "two-regular colouring@$k$-regular colouring" of $\AutGraph[E]$.

    % In the converse direction, suppose there is a "two-regular colouring@$k$-regular colouring" $(C_1,C_2)$ of $\AutGraph[E]$, and suppose without loss of generality that $(B,c_{\textit{init}}) \in C_1$. Since $\AutGraph[E]$ is connected, the colouring is uniquely determined by the colour of any of its vertices, and hence $C_1 = (\set B \times \hat L) \cup (\set R \times (\configs \setminus \hat L))$, where $\hat L$ is the set of "reachable configurations" of $T$. Now $\hat L$ can be obtained from $C_1$ by means of projection and thus $\hat L$ is regular.

    To prove the statement for any $k>2$, we define $\AutGraph{L}{E_k}$ as the result of adding a $(k-2)$-clique to $\AutGraph{L}{E}$ and adding an edge from every vertex of the clique to every vertex incident to an edge of $E$. This forces the clique to use $k-2$ colours that cannot be used in the remaining part of the graph and the proof is then analogous.

	\proofcase{Upper-bound.} We show that the problem is recursively enumerable. Let us define a $k$-coloured automaton like a regular (complete) DFA, except that instead of having
	a set of final states, it has a partition $\langle C_1,\hdots,C_k \rangle$ of its states.
	Such an automaton recognizes a regular colouring $\Sigma^* \to \set{1, \dotsc, k}$.
	Given an "synchronous graph" $\AutGraph{L}{R}$---specified by
	 NFA's $\+A_1$ and $\+A_2$ recognizing $L$ and $\convolRel{R}$  respectively--- and a $k$-coloured automaton $\+B$,
	we can build, by a product construction, an NFA $\+A'_2$  which accepts
	all $u \otimes v \in \convolRel{R}$ such that the colour of $u$ is distinct from the colour of $v$.
	Then, $\+A'_2$ is equivalent to $\+A_2$ if, and only if, $\+B$ describes a proper "$k$-colouring" 
	of $\AutGraph{L}{R}$. The "RE" upper-bound of the "$k$-regular colourability problem" follows: it 
	suffices to enumerate all $k$-coloured automata and check for equivalence.
\end{proof}

Note that this reduction provides an easy way of building
graphs in the shape of \Cref{subfig:reduction-wf-RTM} that are "2-colourable" (in fact, they are trees) but not "2-regular colourable". In fact, we can provide a slightly more
direct construction.

\begin{example}
    \AP\label{ex:tree-not-2-reg-colourable}
    On the alphabet $\Sigma = \{a,b\}$, the tree $\+T$ depicted in \Cref{fig:tree-not-2reg-colour} whose set of vertices is $V = a^*b^*$ and whose set 
    of edges is $E = E_{\mathrm{incr}} \cup E_{\mathrm{init}}$, with 
    \begin{align*}
        E_{\mathrm{incr}} & = \{(a^pb^q,\, a^{p+1}b^{q+1}) \mid p,q \in \N\} \\
        E_{\mathrm{init}} & = \{(\varepsilon,\, a^p) \mid p \in \N\} \cup \{(\varepsilon,\, b^q) \mid q \in \N\}, 
    \end{align*}    
    is "automatic" but not "2-regular colourable". 
    Indeed, its only "2-colouring"
    consists in partitioning the vertices of $\+T$ into
    \[
        C = \{a^n b^n \mid n \in 2\N\}
            \cup \{a^p b^q \mid p > q \text{ and $q$ is odd}\}
            \cup \{a^p b^q \mid p < q \text{ and $p$ is odd}\}
    \]
    and its complement $V \setminus C$.
    Let $P = \{a^p b^q \mid p, q \in 2\N\} = (aa)^*(bb)^*$:
    $P$ is regular, yet $C \cap P = \{a^n b^n \mid n \in 2\N\}$ is not.
    Hence, $C$ is not regular, and thus $\+T$ is not "2-regular colourable".
    \qed 
\end{example}

\begin{figure}[htb]
    \centering
    \begin{tikzpicture}
        \input{tikz/dichotomy/tree-not-2reg-colour}
    \end{tikzpicture}
    \caption{
        \label{fig:tree-not-2reg-colour}
        The "automatic tree@synchronous graph" $\+T$ of \Cref{ex:tree-not-2-reg-colourable},
        and its unique "2-colouring" $(C, V\setminus C)$, which is not "regular@@colouring".
    }
\end{figure}