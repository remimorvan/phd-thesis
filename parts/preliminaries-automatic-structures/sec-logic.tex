\section{A Logical Excursion}
\label{sec:preliminaries-automatic-structures-logic}

\subsection{First-Order Interpretation}

A major construction in logic to restrict the scope of the class
of models---thereafter called ``universe''.
Formally, given a universe $\+U$ and a class of "queries@@sem" $\+Q$,%
\footnote{Recall that we see "queries@@sem" here in a purely semantical way: it is nothing but a subclass of $\+U$.}
given a subclass $\+V$ of $\+U$, we can consider the restriction
\[
	\restr{\+Q}{\+V} \defeq \{\phi \cap \+V \mid \phi \in \+Q\}.
\]
For instance, letting $\+U$ be the class of all "$\sigma$-structures" and $\+Q$ be the set of all 
"first-order sentences" over $\sigma$, by taking $\+V$ to be the set of all \emph{finite}
"$\sigma$-structures", then $\restr{\+Q}{\+V}$ precisely corresponds to
the "first-order sentences" over "finite structures". For instance, the class of all
\emph{finite} "$\sigma$-structures" belongs to $\restr{\+Q}{\+V}$ but not to
$\+Q$ (todo:addref).

However, this construction does not preserve any reasonable property on $\+Q$,
since $\+U'$ is an arbitrary subclass of $\+U$. The idea behind "first-order interpretation"
is precisely to circumvent this problem, by \emph{interpreting} a class of structures
inside another one by using "first-order logic", allowing this way to preserve some properties.

Let $\sigma$ and $\tau$ be "relational signatures".
A \AP ""$d$-dimensional first-order interpretation"" $\+I$ consists of the following tuple of
"first-order formulas" over $\sigma$:
\begin{itemize}
	\itemAP $\intro*\domainInter{\+I}(x^1,\hdots, x^d)$ (specifying the domain)
	\itemAP $\intro*\relInter{=}{\+I}(\tup{x^1,\hdots, x^d}, \tup{y^1,\hdots, y^d})$ (specifying equality)
	\itemAP $\reintro*\relInter{\+R}{\+I}(\tup{x^1_1,\hdots,x^d_1}, \hdots, \tup{x^1_k,\hdots,x^d_k})$
		for any predicate $\+R \in \tau$ of arity $k$,
\end{itemize}
such that $\relInter{=}{\+I}$ defines an equivalence relation on the domain of $\+I$.

Given a "$\sigma$-structure" $\?A$, the \AP""$\+I$-interpretation of $\?A$"" is the "$\tau$-structure" denoted by \AP$\intro*\interpretation{\+I}{\?A}$ defined as follows:%
\footnote{For the same of readability, we use $\bar a$ or $\bar x$ to
denote $d$-tuples of elements of $\?A$ and $d$-tuples of variables.}
\begin{itemize}
	\item its domain is the quotient of 
		$\{\bar a \in \?A^d \mid \?A, \bar a \models \domainInter{\+I}(\bar x)\}$
		by the equivalence relation
		$\set{\tup{\bar a, \bar b} \mid \?A, \bar a, \bar b \models \relInter{=}{\+I}(\bar x, \bar y)}$,
	\item for any predicate $\+R_{(k)} \in \tau$,
		we have
		\[
			\+R_{(k)}(\interpretation{\+I}{\?A}) =
			\Big\{\tup{\bar x_1, \hdots, \bar x_k} \mid
				\exists \bar y_1.\, \hdots.\, \bar y_k.\,
				\bigwedge_{i=1}^k \relInter{=}{\+I}(\bar x_i, \bar y_i)
				\land \relInter{\+R}{\+I}(\bar y_1, \hdots, \bar y_k)
			\Big\}.
		\]
\end{itemize}
For instance, letting $\sigma$ and $\tau$ be the "graph signature", consider
the "one-dimensional interpretation" $\+I$ where:
\begin{itemize}
	\item the domain formula keeps all vertices,
	\item the equality formula is proper equality,
	\item the formula for the edge predicate puts two variables $x$ and $y$ in relation
		if either there is an edge from $x$ to $y$, or if $x$ has no successor and $y$ has no predecessor.
\end{itemize}
Then, the $\+I$-interpretation of a directed path is a cycle,
see \Cref{fig:interpretation-path-into-cycle}.
\begin{marginfigure}
	\centering
	\begin{tikzpicture}
		\node[vertex, draw=c2, fill=c2, fill opacity=.4] at (0,0) (2) {};
		\node[vertex, left=of 2, draw=c1, fill=c1, fill opacity=.4] (1) {};
		\node[vertex, left=of 1, draw=c0, fill=c0, fill opacity=.4] (0) {};

		\draw[edge] (0) to (1);
		\draw[edge] (1) to (2);
	\end{tikzpicture}
	\qquad
	\begin{tikzpicture}
		\node[vertex, draw=c2, fill=c2, fill opacity=.4] at (0,0) (2) {};
		\node[vertex, left=of 2, draw=c1, fill=c1, fill opacity=.4] (1) {};
		\node[vertex, left=of 1, draw=c0, fill=c0, fill opacity=.4] (0) {};

		\draw[edge] (0) to (1);
		\draw[edge] (1) to (2);
		\draw[edge, bend right=60] (2) to (0);
	\end{tikzpicture}
	\caption{
		\AP\label{fig:interpretation-path-into-cycle}
		A directed path (left) and its "interpretation" by $\+I$ (right),
		that adds an edge from any vertex with no successor to any vertex with no predecessor.
	}
\end{marginfigure}

The idea behind "first-order interpretation" is that
"first-order formulas" about the interpretation $\interpretation{\+I}{\?A}$
can be translated into "first-order formulas" over $\?A$.
Formally, given a "first-order formula" $\phi(x_1,\hdots,x_k)$ over $\tau$,
we can define a "first-order formula" $\phi^{\+I}(\bar x_1,\hdots,\bar x_k)$ over $\sigma$
defined inductively by:
\begin{itemize}
	\item replacing each variable $x$ by a $d$-tuple $\bar x$,
	\item replacing every occurrence of
		$\+R(x_1,\hdots, x_k)$ (with $\+R_{(k)} \in \tau$)
		by the formula $\relInter{\+R}{\+I}(\bar x_1, \hdots, \bar x_k)$,
	\item relativizing quantification with respect to $\domainInter{\+I}$,
		meaning that
		\begin{align*}
			(\exists x.\, \phi(x))^{\+I} 
			& \defeq \exists \bar x.\, \domainInter{\+I}(\bar x) \land \phi^{\+I}(\bar x),
			\text{ and} \\ 
			(\forall x.\, \phi(x))^{\+I} 
			& \defeq \forall \bar x.\, \domainInter{\+I}(\bar x) \Rightarrow \phi^{\+I}(\bar x).
		\end{align*}
\end{itemize} 
\begin{proposition}
	\AP\label{prop:first-order-interpretation}
	For any "first-order formula" $\phi(x_1,\hdots,x_k)$ over $\tau$,
	for any "pointed $\sigma$-structure" $\tup{\?A, \bar a_1,\hdots, \bar a_k}$, we have:
	\[
		\tup{\interpretation{\+I}{\?A}, \equivclass{\bar a_1}, \hdots, \equivclass{\bar a_k}}
		\models \phi(x_1, \hdots, x_k)
		\quad\text{"iff"}\quad
		\tup{\?A, \bar a_1,\hdots, \bar a_k} \models \phi^{\+I}(\bar x_1,\hdots,\bar x_k).
	\]
\end{proposition}
And so, in particular, if $\+C$ is a class of structures, then
model checking (resp. satisfiability, resp. validity) over the class $\interpretation{\+I}{\+C}$
can be reduced to satisfiability (resp. satisfiability, resp. validity) over $\+C$.

\begin{marginfigure}
	\centering
	\begin{tikzpicture}
		\tikzset{every node/.style={fill opacity=.4}}

		\node[vertex] at (0,0) (0-0) {};
		\foreach \j in {1,2} {
			\pgfmathtruncatemacro{\prev}{\j - 1}
			\pgfmathtruncatemacro{\jc}{mod(\j,2) ? 2 : 1}
			\node[vertex, right=2em of 0-\prev] (0-\j) {};
		}
		\foreach \i in {1,2} {
			\pgfmathtruncatemacro{\prev}{\i - 1}
			\foreach \j in {0,1,2} {
				\pgfmathtruncatemacro{\jc}{mod(\i+\j,2) ? 2 : 1}
				\node[vertex, above=2em of \prev-\j] (\i-\j) {};
			}
		}

		\foreach \i in {0,1,2} {
			\foreach \j in {0,1} {
				\draw[edge] (\i-\j) to (\i-\the\numexpr\j+1\relax);
			}
		}
		\foreach \i in {0,1} {
			\foreach \j in {0,1,2} {
				\draw[edge] (\i-\j) to (\the\numexpr\i+1\relax-\j);
			}
		}
	\end{tikzpicture}
	\caption{
		\AP\label{fig:interpretation-path-into-grid}
		"Interpretation" of the directed path of
		\Cref{fig:interpretation-path-into-cycle} by the
		``block product interpretation''.
	}
\end{marginfigure}
\begin{example}
	The ``block product'' is a typical example of a 2-dimensional interpretation.
	Let $\sigma$ and $\tau$ be the "graph signature".
	We define a "two-dimensional interpretation" $\+I$ with trivial domain and equality%
	\footnote{Meaning formally that \[\domainInter{\+I}(x^1,x^2) \defeq \top,\text{ and}\]
	and $\relInter{=}{\+I}(\tup{x^1,x^2}, \tup{y^1,y^2})$ is
	the formula $x^1 = y^1 \land x^2 = y^2$.}
	and we put an edge from $\tup{x^1,x^2}$ to $\tup{y^1,y^2}$ if either
	there is an edge from $x^1$ to $y^1$ and $x^2 = y^2$, or if
	$x^1 = y^1$ and there is an edge from $x^2$ to $y^2$.
	Then the interpretation of a directed path is a directed grid,
	see \Cref{fig:interpretation-path-into-grid}.
\end{example}

\subsection{First-Order Reduction and First-Order Model Checking}

For the classical notion of \AP""first-order reductions"", see
\cite[Definition 2.11 \& Definition 1.26]{Immerman1998DescriptiveComplexity}.
Note that the complexity of a decision problem is traditionally measured
as a function of the size of the binary encoding of its input.
However, here, the notion of "first-order reductions" deals with
decision problems defined on "relational structures":
\begin{itemize}
	\item any ``classical'' decision problem, "ie" language $L \subseteq \2^*$
		can be seen as a class of "structure" over the "signature of binary strings";
	\item for any "relational signature" $\sigma$,
		there is an encoding of "finite $\sigma$-structures" as "finite structures"
		over the "signature of binary strings", "ie" as a ``classical''
		decision problem---see "eg" \cite[\S~2.2]{Immerman1998DescriptiveComplexity}.
\end{itemize}
Importantly, this last encoding is a "first-order reduction", proving that these reductions
make sense not only from a logical perspective, but also from a complexity-theoretic point of
view.

\begin{proposition}[Folklore]
	\label{prop:FO-in-L}
	"FOfin" $\subseteq$ "L".
\end{proposition}

\begin{proof}[Proof sketch]
	The naive recursive algorithm, recursing over the "first-order formula",
	works in logarithmic space: it suffices to keep one pointer to the "structure"
	for every variable of the "formula@@FO", but since this formula is fixed, we only
	require a constant number of pointers.
\end{proof}

Note that usually, "L"-hardness is defined using "first-order reductions".


\subsection{First-Order Interpretations}

todo.


\subsection{todo:move this around.}

What we said above work with the implicit assumptions that all structures at hand are 
"finite@@struct". However, part of this can be generalized to "automatic structures"---however, this comes to the cost of losing the inclusion in "L".

\begin{proposition}[Folklore]
	\AP\label{prop:first-order-reduction-preserve-automaticity}
	The image of an "automatic structure" by a "first-order reduction" is
	still an "automatic structure".
\end{proposition}
\begin{proof}
	TODO
\end{proof}

\decisionproblem{""First-Order Model Checking of Automatic Structures""}{
	A "first-order formula" $\phi(x_1,\hdots,x_k)$ over $\sigma$,
	an "automatic presentation" $\â€¢A$ of an "automatic $\sigma$-structure" $\?A$,
	and words $u_1,\hdots,u_k \in \domainPres{\+A}$.
}{
	Does $\?A, u_1,\hdots, u_k \FOmodels \phi$?
}

\begin{proposition}
	\!\footnote{See "eg" \cite[Theorem XII.1.7]{Blumensath2024MSOModelTheory}.}
	%
	\label{prop:first-order-model-checking-automatic-structures}
	"First-order model checking of automatic structures" is decidable in todo.
	Its "data complexity" is "NL"-complete.
\end{proposition}

\begin{proof}
	TODO.

	For the "NL" lower bound, reduction from NFA non-emptiness.
\end{proof}

We define \AP""FOaut"" to be the class of all problems over "automatic structures"
which are "first-order definable". By \Cref{prop:first-order-reduction-preserve-automaticity},
this class is closed under "first-order reductions". Moreover,
by \Cref{prop:first-order-model-checking-automatic-structures}, we obtain an upper bound.

\begin{proposition}
	"FOaut" $\subseteq$ "NL".
\end{proposition}


\subsection{A Model-Theoretic Perspective}

Given an alphabet $\Sigma$, we define on $\Sigma^*$:
\begin{itemize}
	\itemAP a predicate $\intro*\lastLetter{a}$ indicating that the last letter of a word is $a$,
	\itemAP a binary relation $\reintro*\equalLength$ indicating that two words have the same length,
	\itemAP a binary relation $\intro*\prefix$ indicating that a word is a prefix of another.
\end{itemize} 
We denote by $\intro*\signatureSynchronous{\Sigma}$ the "signature" $\langle \langle\lastLetter{a}\rangle_{a \in \Sigma},\, \equalLength,\, \prefix \rangle$%
\footnote{For the sake of simplicity, we abusively use the same notations for
the "predicates" and their "interpretations@@predicate" in the "signature".} and
by \AP$\intro*\univStructSynchronous{\Sigma}$ the "$\signatureSynchronous{\Sigma}$-structure" over $\Sigma^*$ where
the "predicates" are "interpreted@@predicate" as above.

\begin{proposition}
	\AP\label{prop:automatic-first-order}
	If $\Sigma$ has at least two letters, then a relation over $\Sigma^*$
	is "automatic@@rel" "iff" it is "first-order definable" in
	$\univStructSynchronous{\Sigma}$.\footnote{When $\Sigma$ has a single letter,
	then the right-to-left implication holds, but not the converse one.
	For instance, it can be shown that $(aa)^*$ is not "first-order definable"
	in $\univStructSynchronous{\{a\}}$.}
\end{proposition}

todo:proof

\begin{example}
	\AP\label{ex:lexicographic-is-automatic}
	Given an ordered alphabet $\Sigma = \{a_1,\hdots,a_n\}$ with $a_1 < \hdots < a_n$,
	the \AP""lexicographic order"" $\intro*\lex$ defined by $u \lex v$ when there exists 
	a prefix $w$ both of $u$ and of $v$, "st" either $w$ has the same length as $u$,
	or the letter following $w$ in $u$ is strictly smaller than the letter following $w$ in $v$.
	
	Note that this can be defined by a "first-order formula" over $\signatureSynchronous{\Sigma}$
	since saying that the letter following $w$ in $u$ is $a$ amounts to
	guessing the smallest prefix $w'$ of $u$ that must strictly contain $w$ as a prefix,
	and checking that $w'$ ends with letter $a$.
	From \Cref{prop:automatic-first-order}, it follows that the "lexicographic order"
	is an "automatic relation".
\end{example}

\subsection{Logical Characterization of Other Classes of Relations}

todo.