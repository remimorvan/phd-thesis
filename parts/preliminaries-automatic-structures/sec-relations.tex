\section{The Landscape of Rationality for Relations over Finite Words}
\label{sec:preliminaries-automatic-structures-relations}

\subsection{Regularity is Key...}

The class of "regular languages" is remarkably stable, and can either be characterized as the 
languages recognized by either:
\begin{itemize}
	\item deterministic or non-deterministic finite state automata,
	see "eg" \cite[Proposition~1.2.3, p.~7]{Pin2021FiniteAutomata},
	\item two-way finite state automata by Shepherdson-Rabin-Scott theorem
		\cite[Theorem~2, p.~198]{Shepherdson1959ReductionTwoWay}
		\cite[Theorem~15, p.~123]{RabinScott1959FiniteAutomata},
	\item rational expressions by Kleene's theorem,
		see "eg" \cite[Theorem~1.5.11, p.~34]{Pin2021FiniteAutomata},
	\item monadic second-order logic by Trakhtenbrot-BÃ¼chi-Elgot theorem,
		see "eg" \cite[Theorem~2.2, p.~32]{Bojanczyk2020MSO}, or
	\item finite monoids,
		see "eg" \cite[\S~1.4.2, p.~19]{Pin2021FiniteAutomata}.
\end{itemize}
Moreover, all transformations between these representations are effective---although some
models can be strictly more succinct.

\begin{figure*}
	\centering
	\includegraphics[width=\linewidth]{fig/landscape-rationality-relations.png}
	\caption{
		\AP\label{fig:landscape-rationality-relations}
		The ``landscape of rationality'' for binary relations.
		Dashed regions are empty.
		TODO:UPDATE: SUFFIX RELATION IS Deterministic TWO-WAY AND RATIONAL.
	}
\end{figure*}
These equivalences explain why the terms \emph{recognizable language}---meaning implicitly
``recognizable by a finite-state automaton'' or ``recognizable by a finite monoid''---and
\emph{rational language}---meaning ``described by a rational expression''---are used 
interchangeably. In fact, in this thesis as well as in most of the literature,
we will use the generic term "regular language".
However, in more complex settings, for instance subsets of non-free monoids,%
\footnote{Recall that a language is nothing else but a subset of a free
(usually finitely-generated) monoid.}
the equivalence between these classes no longer holds. \cite{Pin2021StackExchange}

The landscape of rationality for $k$-ary relations of finite words ($k \geq 2$) is far more complex than for languages,\footnote{Which can be seen as unary relations of finite words.} as depicted in \Cref{fig:landscape-rationality-relations}. We will briefly present these classes,
although this thesis will only deal with the two most restrictive ones, namely
"recognizable@@rel" and "automatic relations".%
\footnote{It should be noted that the names
of these classes were often coined independently of one another---sometimes defying common sense.
For instance, "automatic relations" are named this way because they correspond to
the relations recognized by some model of automata...
not unlike most of the classes in \Cref{fig:landscape-rationality-relations}.
They are also sometimes named ``regular relations'', which have nothing to do
with "regular functions" and do \emph{not} correspond to the intersection of "regular functions"
with "functional relations", as one would reasonably expect.}
We fix two alphabets $\Gamma$ and $\Sigma$. In the rest of this section, we focus
on relations $\+R \subseteq \Gamma^* \times \Sigma^*$, "aka" transductions.

Often, in the literature, when the terminology ``transduction'' is used,
these relations are thought as functions from $\Gamma^*$ to $\pset{\Sigma^*}$---sometimes
assuming that the input is a singleton, sometimes not---,
and in this case $\Gamma$ (resp. $\Sigma$) plays the role of an ``input alphabet''
(resp. ``output alphabet''). A transducer reads a letter from the input alphabet,
and \emph{produces} a letter from the output alphabet: inherently, transducers are seen
as a machine that \emph{produces} an ouput, or rather that \emph{tranduces} an input into an output, or multiple outputs.

On the other hand, when the terminology ``relation'' is used,
we often take $\Gamma = \Sigma$.\footnote{For instance this is somewhat important when
dealing with logic or defining automatic structure
\Cref{sec:preliminaries-automatic-structures-automatic-structures,sec:preliminaries-automatic-structures-logic}.}
Multi-tape automata are seen as machine that read
tuples of words, and either accept or reject them: it is a decision model.
The question of $\Gamma =^? \Sigma$ makes little difference since we can often
see a relation $\+R \subseteq \Gamma^* \times \Sigma^*$ as a subset of
$(\Gamma\sqcup \Sigma)^* \times (\Gamma\sqcup \Sigma)^*$
while preserving the notion of ``rationality'' at hand.
Moreover, we will see that some classes can be equally defined
by using multi-tape automata or transducers todo:addref.

Note also that most notions defined by multi-tape automata
can be trivially extended to $k$-ary relations ($k \geq 3$):
we simply work here with binary relations for the sake of simplicity---we will sometimes give more general definition for higher arity when the generalization is not trivial.
On the other hand, transducers intrinsically recognize functions $\Gamma^* \to \pset{\Sigma^*}$,
"ie" binary relations.

Given two classes of finite-word relations $\+C$ and $\+D$ "st" $\+C \supseteq \+D$,
we will often want to know if this inclusion is \emph{effective}:
\decisionproblem{
	""$\+D$-membership problem for $\+C$-relations""
}{
	A $\+C$-relation $\+R$.
}{
	Does $\+R \in \+D$?
}
This problem is also called the \reintro{$\+C$/$\+D$-membership problem}.

A natural extension of this problem is the so-called separability problem,
which has received lots of attention in todo:addref.
\decisionproblem{
	""$\+D$-separability problem for $\+C$-relations""
}{
	Two $\+C$-relations $\+R$ and $\+R'$.
}{
	Is there a $\+D$-relation "st" $\+R \subseteq \+S$ and $\+R' \cap \+S = \emptyset$?
}
In this case, we say that $\+S$ ""separates@@rel"" $\+R$ from $\+R'$.
Note that when $\+D$ is closed under complement, $\+R$ and $\+R'$ play a symmetric role in this problem. Moreover, if $\+D$ is \emph{effectively} closed under complement,
then "membership@@problemrel" reduces to "separability@@problem" 
since $\+R in \+D$ if, and only if, $\+R$ and its complement are "separable@@rel" by
a $\+D$-relation.


\subsection{Recognizable Relations}

A relation $\+R \subseteq \Gamma^* \times \Sigma^*$ is \AP""recognizable@@rel""
if there exists a "finite monoid" $\?M$ together with a "monoid morphism"
\[
	f\colon \Gamma^* \times \Sigma^* \to \?M,
\]
as well as a subset $\Acc \subseteq M$ "st"
$\+R = f^{-1}[\Acc]$. We denote by \AP$\intro*\REC$ the class of "recognizable relations".%
\footnote{todo: Again, insert some set-theoretic bullshit.}

For instance the \AP""same parity relation""
\[
	{\intro*\sameParity} \defeq 
	\{
		\tup{u,v} \in \Gamma^* \times \Sigma^* \mid
		|u| = |v| \mod{2}
	\}
\]
is "recognizable". Indeed, letting $f\colon  \Gamma^* \times \Sigma^* \to \ZnZ{2}$,
then $\sameParity$ can be written as $f^{-1}[\{\bar 0\}]$.

These relations admit a remarkably simple characterization.\AP
\begin{proposition}[{""Mezei's theorem"", see "eg" \cite[Corollary~II.2.20, p.~254]{Sakarovitch2009Elements}}]
	\!\footnote{\cite[\S~2, ``Notes \& references'']{Sakarovitch2009Elements} mentions
	that this proposition is ``unanimously ascribed to G. Mezei (unpublished)''.}
	\label{prop:Mezei-theorem}
	A relation $\+R$ is "recognizable" "iff" there exists $n\in\N$,
	"regular languages" $\tup{K_i}_{i\in \lBrack 1,n\rBrack}$ over $\Gamma$
	and "regular languages" $\tup{L_i}_{i\in \lBrack 1,n\rBrack}$ over $\Sigma$
	"st"
	\[
		\+R = \bigcup_{i=1}^n K_i \times L_i.
	\]
\end{proposition}

In other words, "recognizable relations" are exactly the finite unions of
"Cartesian products" of "regular languages".
For instance, \[{\sameParity} =
(\Gamma\Gamma)^* \times (\Sigma\Sigma)^*
\cup \Gamma(\Gamma\Gamma)^* \times \Sigma(\Sigma\Sigma)^*.\]
We provide a slightly more general statement of "Mezei's theorem".

\begin{proposition}
	\label{prop:Mezei-theorem-generalization}
	Let $\B{V}$ be a "pseudovariety of finite monoids"
	and $\+V$ be the corresponding "pseudovariety of regular languages".
	Let $\+R \subseteq \Gamma^* \times \Sigma^*$ be a relation.
	The following are equivalent:
	\begin{enumerate}
		\item there exists a "finite monoid" $\?M \in \B{V}$, a "monoid morphism"
		$f\colon \Gamma^* \times \Sigma^* \to \?M$ and $\Acc \subseteq \?M$
		"st" $\+R = f^{-1}[\Acc]$;
		\item there exists $n \in \N$
		and $K_1,\hdots,K_n \in \+V_{\Gamma}$ and $L_1,\hdots,L_n \in \+V_{\Sigma}$
		"st" $\mathcal{R} = \bigcup_{i=1}^n K_i \times L_i$,
	\end{enumerate}
	in which case we say that $\+R$ is \AP""$\+V$-recognizable@@rel"".
\end{proposition}

When $\B{V}$ is the "pseudovariety@@reglang" of all "regular languages",
we get back \Cref{prop:Mezei-theorem}.

\begin{proof}
	\proofcase{From monoids to products.}
	Assume that $\+R$ is "recognizable@@rel". 
	Then by definition
	\[
		\+R = \bigcup_{z \in \Acc} f^{-1}[z].
	\]
	Observe then that $f(u,v) = f(\tup{u,\varepsilon}\cdot\tup{\varepsilon,v})
	= f(u,\varepsilon)\cdot f(\varepsilon,v)$ for all $u,v \in \Gamma^* \times \Sigma^*$, and hence:
	\[
		\+R = \bigcup_{\substack{x,y \in M\\ \text{"st" } x\cdot y \in \Acc}}
		\underbrace{\{u \in \Gamma^* \mid f(u, \varepsilon) = x\}}_{\defeq \;K_x}
		\times \underbrace{\{v \in \Sigma^* \mid f(\varepsilon, v) = y\}}_{\defeq \;L_y}.
	\]
	Since $M$ is finite, the union is finite, and moreover, each $K_x$ and $L_y$ is
	recognized by $M \in \B{V}$, and hence belong to $\+V$.

	\proofcase{From products to monoids.} If $\mathcal{R} = \bigcup_{i=1}^n K_i \times L_i$ 
		where all languages belong to $\+V$, then let $M_i,N_i \in \B{V}$
		be their "syntactic monoids", $g_i,h_i$ be their
		"syntactic morphism", and $\Acc_i,\Bcc_i$ be their accepting sets.
		Consider the monoid morphism
		\begin{center}
		\begin{tabular}{ccc}
			$\Gamma^* \times \Sigma^*$ & $\to$ & $\prod_{i}(M_i \times N_i)$ \\
			$\tup{u,v}$ & $\mapsto$ & $\tup{g_i(u), h_i(v)}_{i}$.
		\end{tabular}
		\end{center}
		Then $\+R$ is the preimage by this morphism of
		\[
			\bigcup_{i=1}^n \bigl(
			\cdots \times (M_{i-1}\times N_{i-1}) \times
			(\Acc_i \times \Bcc_i) \times (M_{i+1}\times N_{i+1}) \times \cdots \bigr).
		\]
		The conclusion follows from the fact that $\B{V}$ is closed under finite products.
\end{proof}

Both the algebraic definition of "recognizable relations" and
"Mezei's theorem" imply---informally!---that all reasonable problems on
"recognizable relations" are decidable. For instance, from \Cref{prop:Mezei-theorem-generalization},
we get that $\+V$ has decidable "membership" "iff" the class of "$\+V$-recognizable relations"
has decidable "membership".

On the other hand, \Cref{prop:Mezei-theorem} proves that "recognizable relations" are not very expressive.
\begin{corollary}
	\!\footnote{Of course, this property is far from being sufficient
	at characterizing "reflexive relations": note that the proof
	does not even use the "regularity@@lang" of the languages at hand...}%
	\footnote{Of course, another way of proving this result would be
	to apply "Raysey's infinite theorem" to $f\colon \Sigma^* \times \Sigma^* \to \?M$.
	Again, we do not use the fact that $f$ is a "monoid morphism", but simply
	that it is a finite-domain function.}
	\AP\label{coro:infinite-clique-recognizable}
	Let $\+R \subseteq \Sigma^* \times \Sigma^*$ be a "reflexive relation".
	Then $\+R$ contains an infinite clique, "ie"
	there exists an infinite language $L \subseteq \Sigma^*$ "st"
	$\tup{u,v} \in \+R$ for all $u,v \in L$.
\end{corollary}
\begin{proof}
	Indeed, by \Cref{prop:Mezei-theorem}, write $\+R$ as $\bigcup_{i=1}^n K_i \times L_i$.
	Given a word $u \in \Sigma^*$, define $f(u) \in \?2^{2n}$ where
	the $2i$-th (resp. $(2i+1)$-th) bit of $f(u)$ indicates if $u \in K_i$ (resp. $u \in L_i$)
	for all $i$.
	By pigeon-hole principle, there exists a bit-sequence in $\?2^{2n}$ whose preimage
	$L$ by $f$ is infinite. Then pick $u,v \in L$. Since $\+R$ is reflexive, then
	$\tup{u,u} \in \+R$ and so, since $f(u) = f(v)$, we
	have $u \in K_i$ "iff" $v \in K_i$ and
	$u \in L_i$ "iff" $v \in L_i$ for all $i$, and so $\tup{u,v} \in \+R$.
\end{proof}

In particular, this corollary implies that neither the \AP""prefix relation""
${\intro*\prefix} \defeq \{
	\tup{u,v} \in \Sigma^*\times\Sigma^* \mid
	\text{$u$ is a prefix of $v$}
\}$, the \AP""suffix relation""
${\intro*\suffix} \defeq \{
	\tup{u,v} \in \Sigma^*\times\Sigma^* \mid
	\text{$u$ is a prefix of $v$}
\}$, nor the equality relation are "recognizable@@rel".
A similar proof can show that the ""equal-length relation""
${\intro*\equalLength} \defeq \{
	\tup{u,v} \in \Gamma^*\times\Sigma^* \mid
	|u| = |v|
\}$.%
\footnote{Note however that \Cref{coro:infinite-clique-recognizable} does not apply since
we assumed there that the input and output alphabets are equal.}


\subsection{Automatic Relations}

"Automatic relations" are a strictly larger class of relations,
and trade some decidability properties to gain in expressiveness.
This is precisely what makes this class interesting to us, and why we will focus
on both "automatic relations" and "automatic structures": while being relatively
expressive, some problems remain decidable.%
\footnote{They are known in the literature under many names:
``synchronous relations''
	"eg" in \cite[Definition~2.3]{CartonChoffrutGrigorieff2006DecisionProblems},
``regular relations''
	"eg" in \cite[Definition~2.2]{KhoussainovNerode1995AutomaticPresentations},
``automatic relations''
	"eg" in \cite[\S~2.1]{LodingSpinrath2019DecisionProblems}.
Frougny and Sakarovitch's work, which is often referred as the first one
that extensively studied this class, refer to them as ``synchronized rational relations''
\cite[\S~4]{FrougnySakarovitch1993SynchronizedRationalRelations}.
Of course, this class already appears in prior work, "eg" in Hodgson's work on
"automatic structures" \cite{Hodgson1983Decidabilite}, but no terminology was coined on these relations there.}

Given a word $u \in \Gamma^*$ and $v\in \Sigma^*$, we define
its \AP""convolution@@word"" $u \intro*\convol v$ to be the word
$i \mapsto \tup{u_i, v_i}$ of length $\max{(|u|,|v|)}$,
with the convention that $u_i = \pad$ (resp. $v_i = \pad$)
if $u_i$ (resp. $v_i$) is undefined, where $\intro*\pad$ is a new letter called
""blank symbol"" or \reintro{padding symbol}. In other words,
$u \convol v$ is obtained by writing $u$ and $v$ on two left-align horizontal tapes,
adding "padding symbols" at the end of the shorter word if their length differ,
and then reading pairs of letters from left to right.
For this reason, the pair $\tup{a,b}$ is instead written $\pair{a}{b}$.
We let \AP$\Gamma \intro*\convolAlpha \Sigma$ denote the alphabet
\[(\Gamma \times \Sigma) \cup (\Gamma \times \{\pad\}) \cup (\{\pad\} \times \Sigma),\]
and we let $\intro*\SigmaPair \defeq \Sigma \convolAlpha \Sigma$.

By construction, if $u \in \Gamma^*$ and $v\in \Sigma^*$, then $u\convol v \in (\Gamma\convolAlpha\Sigma)^*$.%
\footnote{When dealing with relations of higher arity, note that $\convol$ is associative up to a trivial
alphabet relabelling.}
For instance
\[
	aba \convol baa = \pair{a}{b}\pair{b}{a}\pair{a}{a}
	\quad\text{ and }\quad
	abab \convol cdd = \pair{a}{c}\pair{b}{d}\pair{a}{d}\pair{b}{\pad}.
\]
We denote by \AP$\intro*\convolRel{\+R}$ the language
$\{ u \convol v \mid \tup{u,v} \in \+R\} \subseteq (\Gamma\convolAlpha\Sigma)^*$.

A (finite-state) \AP""synchronous automaton"" $\+A$ over input alphabet $\Gamma$ and output alphabet $\Sigma$
is a finite-state automaton over $\Gamma\convolAlpha \Sigma$.%
\footnote{In particular, just like for classical automata, we allow for non-determinism
unless otherwise specified.}
We say that $\+A$ accepts the pair of words $\tup{u,v} \in \Gamma^* \times \Sigma^*$ if
it accepts $u \convol v$ as a ``classical automaton''. Similarly, $\+A$ "recognizes@@sync"
$\+R$ if it $\convolRel{\+R}$ is exactly the set of
words of the form $u \convol v$ that are accepted by $\+A$ as a "classical automaton".
A relation is \AP""automatic@@rel"" if it is "recognized@@sync" by a finite-state "synchronous automaton".
We denote by \AP$\intro*\AUT$ the class of "automatic relations".

\begin{remark}
	Note that some words of $(\Gamma\convolAlpha \Sigma)^*$ do \emph{not} correspond to
	encodings of pairs of words, in the sense that they are not of the
	form $u \convol v$ for some $u \in \Gamma^*$ and $v\in \Sigma^*$. 
	This is for instance the case of $\pair{a}{\pad}\pair{\pad}{b}$.
	In fact, $\convolRel{(\Gamma^*\times\Sigma^*)} =
	\{u \convol v \mid \in u \in \Gamma^* \land v\in \Sigma^* \}$ precisely corresponds to
	the words of $(\Gamma\convolAlpha \Sigma)^*$ "st" if some "padding symbol" is seen
	on some tape, then all subsequent symbols on this tape must also be "padding symbols".
	These words are called \AP""well-formed"", and the set of all "well-formed words" over
	$\Gamma$ and $\Sigma$ is denoted by \AP$\intro*\WellFormed[\Gamma,\Sigma]$.%
	\footnote{Of course, when the alphabets are equal, we will write
	$\reintro*\WellFormed[\Sigma]$ instead of $\WellFormed[\Sigma,\Sigma]$.}
\end{remark}

Because of this, some automata that are not \emph{classically} equivalent
become equivalent when seen as "synchronous automaton". For instance, 
both "synchronous automata" of
\Cref{fig:example-synchronous-automaton-prefix-1,fig:example-synchronous-automaton-prefix-2}
"recognize@@sync" the "prefix relation". However, they do not recognize
the same language when seen as classical automaton---for instance, $\pair{\pad}{a}\pair{a}{a}$
is accepted by the automaton of \Cref{fig:example-synchronous-automaton-prefix-1}
but not by the one of \Cref{fig:example-synchronous-automaton-prefix-2}.
Generalizing this example, it is trivial to check that two "synchronous automata"
have the same semantics if, and only if, they have the same
intersection of their semantics, when seen as classical automata, with
an automaton for $\WellFormed[\Gamma,\Sigma]$.

\begin{marginfigure}
	\centering
	\begin{tikzpicture}[shorten >= 1pt, node distance = 1.8cm, on grid, baseline]
		\node[state, initial left, accepting] (q0) {}; 
		\path[->]
			(q0) edge[loop right] node[font=\scriptsize] {$\pair{a}{a}, \pair{\pad}{a}\text{ for }a\in \Sigma$} (q0);
	\end{tikzpicture}
	\caption{
		\AP\label{fig:example-synchronous-automaton-prefix-1}
		A deterministic one-state "synchronous automaton" "recognizing@@sync"
		the "prefix relation".
	}
\end{marginfigure}
\begin{marginfigure}
	\centering
	\begin{tikzpicture}[shorten >= 1pt, node distance = 1.8cm, on grid, baseline]
		\node[state, initial left, accepting] (q0) {}; 
		\node[state, accepting, below=of q0] (q1) {}; 
		\path[->]
			(q0) edge[loop right] node[font=\scriptsize] {$\pair{a}{a}\text{ for }a\in \Sigma$} (q0)
			(q0) edge node[font=\scriptsize, right] {$\pair{\pad}{a}\text{ for }a\in \Sigma$} (q1)
			(q1) edge[loop right] node[font=\scriptsize] {$\pair{\pad}{a}\text{ for }a\in \Sigma$} (q1);
	\end{tikzpicture}
	\caption{
		\AP\label{fig:example-synchronous-automaton-prefix-2}
		A deterministic two-state "synchronous automaton" "recognizing@@sync"
		the "prefix relation".
	}
\end{marginfigure}

Note that, by definition of "synchronous automata", everything that can be done
on classical automata can be done with "synchronous automata",
including determinisation, removal of $\varepsilon$-transitions, completion, etc.
Moreover, observe by the previous paragraph that
the universality of a "synchronous automaton" $\+A$ amounts to 
the universality of the disjoint union of $\+A$ with an automaton for the complement of
$\WellFormed[\Gamma,\Sigma]$.
A similar construction works for the inclusion problem.
\begin{property}
	Inclusion and universality of "synchronous automata" is "PSpace"-complete.
\end{property}
Similarly, the emptiness of a "synchronous automaton" $\+A$ amounts to
the emptiness of the classical automaton obtained by intersecting $\+A$ with $\WellFormed[\Gamma,\Sigma]$.
\begin{property}
	\AP\label{prop:non-emptiness-problem}
	Emptiness and non-emptiness of "synchronous automata" are "NL"-complete.
\end{property}

Similarly to \Cref{fig:example-synchronous-automaton-prefix-1,fig:example-synchronous-automaton-prefix-2},
it is straightforward to prove that the "equal-lenth relation"
and the equality relation are "automatic". As stated before, this class extends
the class of "recognizable relations".

\begin{proposition}
	Every "recognizable relation" is "automatic@@rel".
\end{proposition}

\begin{proof}
	Clearly, "automatic relations" are closed under union: it suffices to do the disjoint union
	of their automata.
	So, to prove this result, it suffices to show that if $K$ and $L$ are "regular languages",
	then $K \times L$ is "automatic@@rel".
	Let $\+A$ (resp. $\+B$) be an automaton recognizing $K$ (resp. $L$). 
	We build a "synchronous automaton" $\+A \otimes \+B$ as follows:
	TODO:USE FRAC INSTEAD
	\begin{itemize}
		\item its states are the pairs of states of $\+A$ and of states of $\+B$,
		\item $\tup{p,q}$ is initial if both $p$ and $q$ are initial,
		\item $\tup{p,q}$ is accepting if both $q$ and $q$ are accepting, and
		\item for every transition $p \transition{a} p' \in \+A$ and $q \transition{b} q' \in \+B$,
			we put a transition
			\[
				\tup{p,q} \transition{\pair{a}{b}} \tup{p',q'},
			\]
		\item moreover, for every transition $p \transition{a} p' \in \+A$, for every $q$,
			we put a transition 
			\[\tup{p,q} \transition{\pair{a}{\pad}} \tup{p',q},\]
		\item and dually, for every transition $q \transition{b} q' \in \+B$, for every $p$,
			we put a transition 
			\[\tup{p,q} \transition{\pair{\pad}{b}} \tup{p,q'}.\]
	\end{itemize}
	By construction, for any $u\in \Gamma^*$ and $v\in \Sigma^*$,
	there is an accepting path in $\+A \otimes \+B$ labelled by $u \convol v$ 
	"iff" $u \in K$ and $v\in L$.
\end{proof}

todo: add examples lexicographic \& Gray.

As often in automata theory, the pumping lemma provides a useful tool to prove
non-regularity, or rather here non-automaticity.
For instance, the "suffix relation" is not "automatic": otherwise,
using the pumping lemma on $a^n \convol b^n a^n$ for some sufficiently big $n\in\N$
would imply that $a^{n+k} \convol b^{n+k} a^n \in \convolRel{(\suffix)}$ for some $k\in\Np$.
Similarly, the \AP""subword relation"" $\intro*\subword$ is also not "automatic@@rel".%
\footnote{Recall that this relation is defined by, for all $u, v \in \Sigma^*$,
$u \subword v$ "iff" there exists $j_1 < j_2 < \hdots < j_{|u|}$ "st" $u_i = v_{j_{i}}$
for all $i \in \lBrack 1, |u|\rBrack$: in other words, $u$ can be obtained from $v$ by removing letters.}

Another useful tool to prove "non-automaticity" is the following one.
Given $I \subseteq \lBrack 1,k\rBrack$,
we say that a $k$-ary "relation" $\+R \subseteq \Sigma_1^* \times \cdots \times \Sigma_k^*$ is
""$I$-locally finite"" if for every $\tup{w_i}_{i\in I} \in \prod_{i\in I} \Sigma_i^*$,
there are only finitely many $\tup{w_j}_{j\not\in I} \in \prod_{j \not\in I} \Sigma_j^*$
"st" $\tup{w_1,\hdots,w_k} \in \+R$.%
\footnote{Note that this is one of the very few statements
that we spell out for $k$-ary relation since its generalization from binary to $k$-ary relations
is not entirely trivial.}
Note that every $k$-ary relation is "$\lBrack 1,k\rBrack$-locally finite".
\begin{proposition}[See "eg" {\cite[Proposition~3.1]{KhoussainovNiesRubinStephan2007Automatic}}]
	\!\footnote{\cite{KhoussainovNiesRubinStephan2007Automatic} attributes this proposition
	to older work by Khoussainov, Nerode and Blumensath, but we failed to verify this claim.}%
	\footnote{Recall that $\max{\emptyset} = -\infty$, and so in the case
	of $I = \lBrack 1,k\rBrack$, this statement is trivially valid.}
	\AP\label{prop:bound-automatic-structures}
	Let $\+R \subseteq \Sigma_1^* \times \cdots \times \Sigma_k^*$ be "$I$-locally finite".
	If $\+R$ is "automatic", then there exists a constant $n\in\N$ "st" for every
	$\tup{w_1,\hdots,w_k} \in \+R$,
	\[
		\max_{j \not\in I}{|w_j|} - \max_{i \in I}{|w_i|} \leq n.
	\]
\end{proposition}

For instance, consider the ternary relation of concatenation,
consisting of all triples $\tup{u,v,w}$ "st" $uv = w$, where $u,v,w\in\Sigma^*$.
Then this relation is "$\{3\}$-locally finite", and so by
\Cref{prop:bound-automatic-structures}, there exists $n\in \N$
"st" for all $u,v \in \Sigma^*$, $|uv| \leq \max{(|u|,|v|)} + n$.
This is trivially false, and hence, concatenation is not "automatic".

Despite being somewhat expressive, "automatic relations" retain some decidability properties. 
\begin{proposition}[{\cite[Theorem 1]{BarceloHongLeLinNiskanen2019MonadicDecomposability}, see also \cite[Corollary 2.9]{BergstrasserGanardiLinZetzsche2022RamseyQuantifiers}}]
	\!\footnote{Decidability, first in "3ExpTime" and then
	in "2ExpTime" was already known in the 1970s as a consequence
	of todo:addref-deterministic-rational-relations.
	An "ExpTime" upper bound was incorrectly claimed in \cite[Table~1]{CartonChoffrutGrigorieff2006DecisionProblems},
	and proved wrong in \cite[\S~4.1]{LodingSpinrath2019DecisionProblems}.
	LÃ¶ding and Spinrath noticed that the previous algorithm was
	actually working in "2ExpTime", and improved 
	the bound to "ExpTime" for binary relations
	in \cite[Corollary~22]{LodingSpinrath2019DecisionProblems}.}
	The ""$\REC$-membership problem for automatic relations"" is "PSpace"-complete.
\end{proposition}

On the other hand, the associated "separation problem@@rel" remains open.
This part of this thesis is mostly motivated by this problem.%
\footnote{Pablo BarcelÃ³ introduced me to this problem in October 2022.
todo:blabla.}

\begin{openproblem}
	Is the ""$\REC$-separability problem for automatic relations"" decidable?
\end{openproblem}

We will see more properties of "automatic relations"---or rather of "automatic structures"---in
\Cref{sec:preliminaries-automatic-structures-automatic-structures,sec:preliminaries-automatic-structures-logic}.

\subsection{Rational Relations}

"Rational relations" are perhaps the most natural class of finite-word relations:
they are defined similarly to "automatic relations", except that
the automaton used to defined have one head per tape, and can move each head
independently of one another---however each head can only move from left to right.
For the same of convenience, we assume that the automaton can move multiple heads at every step.
This can be formalized as follows.

An \AP""multi-tape automaton"" over $\Gamma,\Sigma$
can be syntactically defined as a classical automaton over $\Gamma \convolAlpha \Sigma$.
We then let $\pi_1\colon (\Gamma\convolAlpha\Sigma)^* \to \Gamma^*$ and 
$\pi_2\colon (\Gamma\convolAlpha\Sigma)^* \to \Sigma^*$ be the "monoid morphisms"
defined by
\[
	\pi_1\pair{x}{y}\defeq \begin{cases*}
		a & \text{if $x = a \in \Gamma$,}\\
		\varepsilon & \text{if $x=\pad$,}
	\end{cases*}
	\quad\text{and}\quad
	\pi_2\pair{x}{y}\defeq \begin{cases*}
		b & \text{if $y = b \in \Sigma$,}\\
		\varepsilon & \text{if $y=\pad$,}
	\end{cases*}
\]
for all $\pair{x}{y}\in \Gamma\convolAlpha\Sigma$.
Then \AP$\intro*\projDesync \defeq \pi_1 \times \pi_2$ defines a "monoid morphism" 
from $(\Gamma\convolAlpha\Sigma)^*$ to $\Gamma^* \times \Sigma^*$,
that reads both tapes one after the other, while ignoring "padding symbols".
For instance:
\[
	\projDesync\pair{a \pad b \pad a \pad c \pad}{a a b b a a c c}
	= \tup{abac, aabbaacc}.
\]
The semantics of the "multi-tape automaton"
can be defined as the image by $\projDesync$ of its semantics when seen as a
classical automaton.%
\footnote[][-15em]{These automata are often simply called ``$k$-tape automata''. 
They are rarely referred to as ``asynchronous automata'',
"eg" in \cite[\S~3]{CarayolLoding2011Uniformization}.
We do \emph{not} use this terminology following a suggestion
of Anca Muscholl to avoid the confusion with Zielonka's ``asynchronous automata'' used in 
concurrency \cite[\S~4]{Zielonka1987AsynchronousAutomata}.}

We say that a relation $\+R \subseteq \Gamma^* \times \Sigma^*$ is ""rational@@rel""
if it is "recognized@@desync" by an "multi-tape automaton",
or equivalently if it is the image by $\projDesync$ of a "regular language"
over $\Gamma\convolAlpha\Sigma$.
The class of all "rational relations" is denoted by $\RAT$.

% For instance, the \AP""local squaring function"",
% consisting of all pairs $\tup{u,v} \in \Sigma^* \times \Sigma^*$
% "st" $v = u_1 u_1 u_2 u_2 \cdots u_{|u|} u_{|u|}$ is "rational@@rel", 
% see \Cref{fig:multi-tape-automaton-local-squaring}.
% However, it is not "automatic@@rel".
% \begin{marginfigure}[-20em]
% 	\centering
% 	\begin{tikzpicture}[shorten >= 1pt, node distance = 1.8cm, on grid, baseline]
% 		\node[state, initial left, accepting] (q0) {$\smash{*}$}; 
% 		\node[state, above right=3em and 5em of q0] (qa2) {$\smash{q'_a}$}; 
% 		\node[state, above left=3em and 5em of qa2] (qa1) {$\smash{q_a}$}; 
% 		\node[state, below right=3em and 5em of q0] (qb2) {$\smash{q'_b}$}; 
% 		\node[state, below left=3em and 5em of qb2] (qb1) {$\smash{q_b}$}; 
% 		\path[->]
% 			(q0) edge[bend left] node[font=\scriptsize, right] {$\pair{a}{\pad}$} (qa1)
% 			(qa1) edge[bend left] node[font=\scriptsize, below] {$\pair{\pad}{a}$} (qa2)
% 			(qa2) edge[bend left] node[font=\scriptsize, above] {$\pair{\pad}{a}$} (q0)
% 			(q0) edge[bend right] node[font=\scriptsize, right] {$\pair{b}{\pad}$} (qb1)
% 			(qb1) edge[bend right] node[font=\scriptsize, above] {$\pair{\pad}{b}$} (qb2)
% 			(qb2) edge[bend right] node[font=\scriptsize, below] {$\pair{\pad}{b}$} (q0);
% 	\end{tikzpicture}
% 	\caption{
% 		\AP\label{fig:multi-tape-automaton-local-squaring}
% 		An "multi-tape automaton" for the "local squaring function"
% 		when $\Sigma = \{a,b\}$.
% 	}
% \end{marginfigure}
\begin{marginfigure}[-10em]
	\centering
	\begin{tikzpicture}[shorten >= 1pt, node distance = 1.8cm, on grid, baseline]
		\node[state, initial left, accepting] (q0) {$*$}; 
		\node[state, above right=5em of q0] (qa) {$q_a$}; 
		\node[state, below right=5em of q0] (qb) {$q_b$}; 
		\path[->]
			(q0) edge[bend left] node[font=\scriptsize, left] {$\pair{a}{\pad}$} (qa)
			(qa) edge[loop right] node[font=\scriptsize, right] {$\pair{\pad}{b}$} (qa)
			(qa) edge[bend left] node[font=\scriptsize, right] {$\pair{\pad}{a}$} (q0)
			(q0) edge[bend right] node[font=\scriptsize, left] {$\pair{b}{\pad}$} (qb)
			(qb) edge[loop right] node[font=\scriptsize, right] {$\pair{\pad}{a}$} (qb)
			(qb) edge[bend right] node[font=\scriptsize, right] {$\pair{\pad}{b}$} (q0);
	\end{tikzpicture}
	\caption{
		\AP\label{fig:multi-tape-automaton-subword}
		An "multi-tape automaton" for the "subword relation" $\subword$
		when $\Sigma = \{a,b\}$.
	}
\end{marginfigure}
\begin{marginfigure}
	\centering
	\begin{tikzpicture}[shorten >= 1pt, node distance = 1.8cm, on grid, baseline]
		\node[state, initial left, accepting] (q0) {}; 
		\node[state, accepting, right=7em of q0] (q1) {}; 
		\path[->]
			(q0) edge[loop above] node[font=\scriptsize, above]
				{$\pair{\pad}{a}$ for $a\in \Sigma$} (q0)
			(q0) edge node[font=\scriptsize, below] {$\pair{a}{a}$ for $a\in \Sigma$} (q1)
			(q1) edge[loop above] node[font=\scriptsize, above]
				{$\pair{a}{a}$ for $a\in \Sigma$} (q1);
	\end{tikzpicture}
	\caption{
		\AP\label{fig:multi-tape-automaton-suffix}
		An "multi-tape automaton" for the "suffix relation" $\suffix$.
	}
\end{marginfigure}

Similarly, the "subword relation" $\subword$ is "rational@@rel": the idea behind
the "automaton@@desync" recognizing it that, when reading an $a$ on the first tape,
the "automaton@@desync" will only move its second head write, until it reads
an $a$; it then reads the next letter on the first tape and iterates this process. 

Note that alternative definitions exist, but yield an equivalent definition of "rational relations".
For instance, in \cite[Definition~2.1]{CartonChoffrutGrigorieff2006DecisionProblems},
the "multi-tape automaton" are defined analogously (under the name ``$k$-tape automaton'')
except that the alphabet is not $\Gamma \convolAlpha \Sigma$ but 
$(\Gamma \times \{\pad\}) \cup (\{\pad\}\times \Sigma)$. In other words,
their model can only move one head at a time.
Of course, this makes little difference: we can simulate an $\pair{a}{b}$-transition in our model
by two transitions labelled by $\pair{a}{\pad}$ and $\pair{\pad}{b}$ in their model, to the cost of adding a new state.

\subsection{Deterministic Rational Relations}

Note that the "automaton@@sync" of \Cref{fig:multi-tape-automaton-suffix} is deterministic
as a classical automaton. However, we claim that it should not be considered to be ``deterministic''
as an "multi-tape automaton".
For instance, assume that we are running this automaton over the pair
$\tup{aab, ababaab}$, and that we started reading the sequence $\pair{\pad}{a}, \pair{\pad}{b}$,
while staying in the initial state. Should we take the
$\pair{\pad}{a}$ and stay in the initial state, or take the transition $\pair{a}{a}$ and go to 
final state? In the first case, we can obtain an accepting run, but in the second case we cannot.
In other word, assuming that $u \subword v$, we need to guess when we've reached the suffix of
$v$ corresponding to $u$, and this is a source of non-determinism. Observe that
the automaton of \Cref{fig:multi-tape-automaton-suffix} is deterministic as a classical automaton
because $\pair{\pad}{a}$ and $\pair{a}{a}$ are distinct letters of $\Gamma\convolAlpha\Sigma$, 
although in the multi-tape setting, both pairs can be simultaneously admissible.
In other words, the lack of injectivity of the function $\projDesync$ creates another
source of non-determinism. This motivates an alternative definition for determinism.

Hence, we say that a $k$-ary "multi-tape automaton" over $\Sigma_1,\hdots,\Sigma_k$
is ""deterministic@@desync"" if
there exists a partition $\tup{Q_H}_{H \in \psetp{\lBrack 1,k\rBrack}}$ of its states "st":
\begin{enumerate}
	\item it has a unique initial state,
	\item for any state $q$, for any $\bar a \in \Sigma_1\convolAlpha\cdots\convolAlpha\Sigma_k$,
		there is at most one out-going transition from $q$ labelled by $\bar a$, and
	\item for any $H\in\psetp{\lBrack 1,k\rBrack}$, for any $q \in Q_H$,
		every out-going transition from $q$ can only be labelled by elements of
		the form $\bar a \in \Sigma_1\convolAlpha\cdots\convolAlpha\Sigma_k$, with
		$a_h \in \Sigma_h$ for any $h\in H$ and $a_h = \pad$ for any $h\not\in H$.
\end{enumerate}
In other words, we ask for classical determinism to hold, but moreover we need to know \emph{a priori}, at each state, which set of heads we will be moving at the next step.

\begin{claim}
	Let $\+A$ be a $k$-ary "deterministic multi-tape automaton" over $\Sigma_1,\hdots,\Sigma_k$.
	For any $\tup{w_1,\hdots,w_k} \in \Sigma_1^* \times \cdots \Sigma_k^*$,
	for any state $q$ of $\+A$, there exists at most
	one word $w \in (\Sigma_1\convolAlpha\cdots\convolAlpha\Sigma_k)^*$ "st" $\projDesync(w) = \tup{w_1,\hdots,w_k}$ and there is a run of $\+A$, starting at $q$ and labelled by $w$.%
	\footnote{On the other hand, observe that classical determinism only ensures
	at most one run for each $w \in (\Sigma_1\convolAlpha\cdots\convolAlpha\Sigma_k)^*$,
	and not for each $\tup{w_1,\hdots,w_k} \in \Sigma_1^* \times \cdots \Sigma_k^*$.}
\end{claim}

We say that a relation $\+R \subseteq \Gamma^* \times \Sigma^*$ is ""deterministic rational@@rel""
if the relation
\[
	\{\tup{u\triangleleft, v\triangleleft} \mid \tup{u,v} \in \+R\}
\]
is recognized by a "deterministic multi-tape automaton", where $\triangleleft$ is a new symbol.
Note that if $\+R$ is recognized by a "deterministic multi-tape automaton", then so is
this ``enhanced'' relation, but the converse property does not hold.
The motivation behind this somewhat strange definition is that this way,
"deterministic rational relations" generalize "automatic relations".

\begin{proposition}
	\AP\label{prop:synchronous-implies-detrat}
	Every "automatic relation" is "deterministic rational".
\end{proposition}

\begin{marginfigure}
	\centering
	\begin{tikzpicture}[shorten >= 1pt, node distance = 1.8cm, on grid, baseline]
		\node[state, initial left] (q0) {}; 
		\node[state, below=of q0] (q1) {}; 
		\node[state, accepting, below=of q1] (q2) {}; 
		\path[->]
			(q0) edge[loop right] node[font=\scriptsize] {$\pair{a}{a}\text{ for }a\in \Sigma$} (q0)
			(q0) edge node[font=\scriptsize, right] {$\pair{\triangleleft}{a}\text{ for }a\in \Sigma$} (q1)
			(q1) edge[loop right] node[font=\scriptsize] {$\pair{\pad}{a}\text{ for }a\in \Sigma$} (q1)
			(q1) edge node[font=\scriptsize, right] {$\pair{\pad}{\triangleleft}\text{ for }a\in \Sigma$} (q2);
	\end{tikzpicture}
	\caption{
		\AP\label{fig:example-synchronous-automaton-prefix-1-detrat}
		Construction of the proof of \Cref{prop:synchronous-implies-detrat}
		applied to the "deterministic multi-tape automaton" built from the synchronous automaton of
		\Cref{fig:example-synchronous-automaton-prefix-1} "recognizing@@sync" the "prefix relation".
	}
\end{marginfigure}
\begin{proof}[Proof sketch]
	Start from a "synchronous automaton" $\+A$:
	"wlog" it can be assumed to be deterministic, when seen 
	as a classical automaton. However, when seen as a "multi-tape automaton", some determinism 
	remains: for instance some state can have outgoing transitions labelled both
	by $\pair{a}{a}$ and $\pair{\pad}{a}$.
	To fix this, we build a "multi-tape automaton" $\+A'$ by triplicating the states:
	each original state $q$ yields a state $q_H$ for $H \in \psetp{\lBrack 1,2 \rBrack}$.
	Transitions are built using the following rules:
	\[
		\frac{
			p_{\{1,2\}} \transition{\pair{a}{b}} q_{\{1,2\}} \in \+A'
		}{
			p \transition{\pair{a}{b}} q \in \+A
			\vphantom{\Big()}
		},
	\]
	\vspace{-2em}
	\begin{align*}
		\frac{
			p \transition{\pair{a}{\pad}} q \in \+A
		}{
			p_{\{1,2\}} \transition{\pair{a}{\triangleleft}} q_{\{1\}} \in \+A'
			\vphantom{\Big()}
		},\hphantom{\quad and}\qquad
		& 
		\frac{
			p \transition{\pair{a}{\pad}} q \in \+A	
		}{
			p_{\{1\}} \transition{\pair{a}{\pad}} q_{\{1\}} \in \+A'
			\vphantom{\Big()}
		}, \\
		\frac{
			p \transition{\pair{\pad}{a}} q \in \+A
		}{
			p_{\{1,2\}} \transition{\pair{\triangleleft}{a}} q_{\{2\}} \in \+A'
			\vphantom{\Big()}
		}\text{,\quad and}\qquad
		& 
		\frac{
			p \transition{\pair{\pad}{a}} q \in \+A
		}{
			p_{\{2\}} \transition{\pair{\pad}{a}} q_{\{2\}} \in \+A'
			\vphantom{\Big()}
		}.\\
	\end{align*}
	We also add to $\+A'$ a single new state $q_{\emptyset}$, and for every accepting state $p$ of
	$\+A$, we add a transition from $p_H$ ($H \in \psetp{\lBrack 1,k\rBrack}$) to $q_{\emptyset}$
	labelled by the unique tuple having $\triangleleft$ at every index $h \in H$,
	and $\pad$ at every other index.
	$q_{\emptyset}$ is the unique accepting state of $\+A'$, and moreover
	$p_{\lBrack 1,k\rBrack}$ is the unique initial state of $\+A'$, where $p$ is the initial state of $\+A$. See \Cref{fig:example-synchronous-automaton-prefix-1-detrat} for an example.
	
	Note that by construction, $\+A'$ is a "deterministic multi-tape automaton". 
	Using the fact that $\+A$ is "synchronous", it can be shown that
	if $\+R$ is the relation "recognized@@sync" by $\+A$, then $\+A'$ precisely 
	""recognizes@@multi-tape"" $\{\tup{u\triangleleft,v\triangleleft} \mid \tup{u,v} \in \+R\}$.
	And hence, $\+R$ is "deterministic rational".
\end{proof}



Clearly, \Cref{fig:multi-tape-automaton-suffix} is "non-deterministic@@desync". But in fact, we prove a stronger result: the "suffix relation" $\suffix$ cannot be recognized by a
"deterministic multi-tape automaton".
Indeed, TODO.


\subsection{Todo}

\begin{itemize}
	\item todo:add polyregular functions.
	\item history-deterministic two-way rational functions?
	\item todo: rename ``synchronous relations'' to ``automatic relations''
	\item todo:the intersection of
	functional relations and two-way rational relations
	collapses to regular functions by
	\cite[Theorem 22, p.~243]{EH2001transduction}.
	\item cite GaÃ«tan's thesis (chapter 1 for finite words, chapter 8 for infinite words)
	\item mention pebble, marble and whatnot.
	\item TODO: \S~8.2 ``star-free and locally threshold testable presentations''
		in Blumensath's thesis.
	\item cite "An Algebraic Characterization of Unary Two-Way Transducers"
	\url{https://link.springer.com/chapter/10.1007/978-3-662-44522-8\_17}
\end{itemize}